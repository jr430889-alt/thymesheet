<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThymeSheet</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    <script>
        // Override Babel's inline script size limit
        if (window.Babel && window.Babel.transform) {
            const originalTransform = window.Babel.transform;
            window.Babel.transform = function(code, options) {
                // Remove size checking by patching the transform function
                return originalTransform.call(this, code, options);
            };
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --deep-green: #1C5A3F;
            --eggplant: #4B2E39;
            --off-white: #F9F8F7;
            --soft-gray: #EAEAEA;
            --pearl: #F5F3F0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--off-white);
            margin: 0;
            padding: 0;
            color: #2D2D2D;
            line-height: 1.6;
        }

        * {
            box-sizing: border-box;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'deep-green': '#1C5A3F',
                        'eggplant': '#4B2E39',
                        'off-white': '#F9F8F7',
                        'soft-gray': '#EAEAEA',
                        'pearl': '#F5F3F0',
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                    },
                    borderRadius: {
                        'subtle': '5px',
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef } = React;

        // Lucide-style icons using SVG
        const Clock = () => React.createElement('svg', {
            width: '20',
            height: '20',
            viewBox: '0 0 24 24',
            fill: 'none',
            stroke: 'currentColor',
            strokeWidth: '2',
            strokeLinecap: 'round',
            strokeLinejoin: 'round',
            style: { display: 'inline-block', verticalAlign: 'middle' }
        }, React.createElement('circle', { cx: '12', cy: '12', r: '10' }), React.createElement('polyline', { points: '12 6 12 12 16 14' }));

        const Square = () => React.createElement('svg', {
            width: '20',
            height: '20',
            viewBox: '0 0 24 24',
            fill: 'none',
            stroke: 'currentColor',
            strokeWidth: '2',
            strokeLinecap: 'round',
            strokeLinejoin: 'round'
        }, React.createElement('rect', { x: '3', y: '3', width: '18', height: '18', rx: '2', ry: '2' }));

        const Download = () => React.createElement('svg', {
            width: '20',
            height: '20',
            viewBox: '0 0 24 24',
            fill: 'none',
            stroke: 'currentColor',
            strokeWidth: '2',
            strokeLinecap: 'round',
            strokeLinejoin: 'round'
        }, React.createElement('path', { d: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4' }), React.createElement('polyline', { points: '7 10 12 15 17 10' }), React.createElement('line', { x1: '12', y1: '15', x2: '12', y2: '3' }));

        const Upload = () => React.createElement('svg', {
            width: '20',
            height: '20',
            viewBox: '0 0 24 24',
            fill: 'none',
            stroke: 'currentColor',
            strokeWidth: '2',
            strokeLinecap: 'round',
            strokeLinejoin: 'round'
        }, React.createElement('path', { d: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4' }), React.createElement('polyline', { points: '17 8 12 3 7 8' }), React.createElement('line', { x1: '12', y1: '3', x2: '12', y2: '15' }));

        const Plus = () => React.createElement('svg', {
            width: '20',
            height: '20',
            viewBox: '0 0 24 24',
            fill: 'none',
            stroke: 'currentColor',
            strokeWidth: '2',
            strokeLinecap: 'round',
            strokeLinejoin: 'round'
        }, React.createElement('line', { x1: '12', y1: '5', x2: '12', y2: '19' }), React.createElement('line', { x1: '5', y1: '12', x2: '19', y2: '12' }));

        const Trash2 = () => React.createElement('svg', {
            width: '20',
            height: '20',
            viewBox: '0 0 24 24',
            fill: 'none',
            stroke: 'currentColor',
            strokeWidth: '2',
            strokeLinecap: 'round',
            strokeLinejoin: 'round'
        }, React.createElement('polyline', { points: '3 6 5 6 21 6' }), React.createElement('path', { d: 'M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2' }), React.createElement('line', { x1: '10', y1: '11', x2: '10', y2: '17' }), React.createElement('line', { x1: '14', y1: '11', x2: '14', y2: '17' }));

        const Edit2 = () => React.createElement('svg', {
            width: '18',
            height: '18',
            viewBox: '0 0 24 24',
            fill: 'none',
            stroke: 'currentColor',
            strokeWidth: '2',
            strokeLinecap: 'round',
            strokeLinejoin: 'round'
        }, React.createElement('path', { d: 'M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7' }), React.createElement('path', { d: 'M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z' }));

        const Settings = () => React.createElement('svg', {
            width: '20',
            height: '20',
            viewBox: '0 0 24 24',
            fill: 'none',
            stroke: 'currentColor',
            strokeWidth: '2',
            strokeLinecap: 'round',
            strokeLinejoin: 'round'
        }, React.createElement('circle', { cx: '12', cy: '12', r: '3' }), React.createElement('path', { d: 'M12 1v6m0 6v6m5.657-13.657l-4.243 4.243m-2.828 2.828l-4.243 4.243M23 12h-6m-6 0H1m18.364-5.657l-4.243 4.243m-2.828 2.828l-4.243 4.243' }));

        const MessageSquare = () => React.createElement('svg', {
            width: '20',
            height: '20',
            viewBox: '0 0 24 24',
            fill: 'none',
            stroke: 'currentColor',
            strokeWidth: '2',
            strokeLinecap: 'round',
            strokeLinejoin: 'round'
        }, React.createElement('path', { d: 'M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z' }));

        const ChevronDown = () => React.createElement('svg', {
            width: '16',
            height: '16',
            viewBox: '0 0 24 24',
            fill: 'none',
            stroke: 'currentColor',
            strokeWidth: '2',
            strokeLinecap: 'round',
            strokeLinejoin: 'round'
        }, React.createElement('polyline', { points: '6 9 12 15 18 9' }));

        const Building = () => React.createElement('svg', {
            width: '20',
            height: '20',
            viewBox: '0 0 24 24',
            fill: 'none',
            stroke: 'currentColor',
            strokeWidth: '2',
            strokeLinecap: 'round',
            strokeLinejoin: 'round'
        }, React.createElement('rect', { x: '4', y: '2', width: '16', height: '20', rx: '2', ry: '2' }), React.createElement('path', { d: 'M9 22v-4h6v4M8 6h.01M16 6h.01M12 6h.01M12 10h.01M12 14h.01M16 10h.01M16 14h.01M8 10h.01M8 14h.01' }));

        const Folder = () => React.createElement('svg', {
            width: '18',
            height: '18',
            viewBox: '0 0 24 24',
            fill: 'none',
            stroke: 'currentColor',
            strokeWidth: '2',
            strokeLinecap: 'round',
            strokeLinejoin: 'round'
        }, React.createElement('path', { d: 'M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z' }));

        const RefreshCw = ({ size = 20 } = {}) => React.createElement('svg', {
            width: size,
            height: size,
            viewBox: '0 0 24 24',
            fill: 'none',
            stroke: 'currentColor',
            strokeWidth: '2',
            strokeLinecap: 'round',
            strokeLinejoin: 'round'
        }, React.createElement('polyline', { points: '23 4 23 10 17 10' }), React.createElement('polyline', { points: '1 20 1 14 7 14' }), React.createElement('path', { d: 'M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15' }));

        const FolderOpen = () => React.createElement('svg', {
            width: '20',
            height: '20',
            viewBox: '0 0 24 24',
            fill: 'none',
            stroke: 'currentColor',
            strokeWidth: '2',
            strokeLinecap: 'round',
            strokeLinejoin: 'round'
        }, React.createElement('path', { d: 'M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z' }), React.createElement('polyline', { points: '2 8 4 20 20 20 22 8' }));

        const Tag = () => React.createElement('svg', {
            width: '18',
            height: '18',
            viewBox: '0 0 24 24',
            fill: 'none',
            stroke: 'currentColor',
            strokeWidth: '2',
            strokeLinecap: 'round',
            strokeLinejoin: 'round'
        }, React.createElement('path', { d: 'M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z' }), React.createElement('line', { x1: '7', y1: '7', x2: '7.01', y2: '7' }));

        const Bookmark = () => React.createElement('svg', {
            width: '16',
            height: '16',
            viewBox: '0 0 24 24',
            fill: 'none',
            stroke: 'currentColor',
            strokeWidth: '2',
            strokeLinecap: 'round',
            strokeLinejoin: 'round'
        }, React.createElement('path', { d: 'M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z' }));

        const DollarSign = () => React.createElement('svg', {
            width: '20',
            height: '20',
            viewBox: '0 0 24 24',
            fill: 'none',
            stroke: 'currentColor',
            strokeWidth: '2',
            strokeLinecap: 'round',
            strokeLinejoin: 'round'
        }, React.createElement('line', { x1: '12', y1: '1', x2: '12', y2: '23' }), React.createElement('path', { d: 'M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6' }));

        // Listen for IPC messages from main process
        let ipcRenderer = null;
        if (typeof require !== 'undefined') {
            ipcRenderer = require('electron').ipcRenderer;

            window.toggleTimerFromTray = () => {
                if (window.currentTimerToggle) {
                    window.currentTimerToggle();
                }
            };

            window.navigateToPage = (page) => {
                if (window.navigateTo) {
                    window.navigateTo(page);
                }
            };

            window.showUpgradeDialogHandler = () => {
                if (window.showUpgradeDialogFn) {
                    window.showUpgradeDialogFn();
                }
            };

            ipcRenderer.on('toggle-timer', () => {
                window.toggleTimerFromTray();
            });

            ipcRenderer.on('navigate-to', (event, page) => {
                window.navigateToPage(page);
            });

            ipcRenderer.on('export-data-request', () => {
                if (window.exportAllData) {
                    window.exportAllData();
                }
            });

            ipcRenderer.on('import-data-request', () => {
                if (window.importAllData) {
                    window.importAllData();
                }
            });

            ipcRenderer.on('show-upgrade-dialog', () => {
                if (window.showUpgradeDialogHandler) {
                    window.showUpgradeDialogHandler();
                }
            });
        }

        // Helper functions for file-based data storage
        const loadDataFromFile = async () => {
            if (!ipcRenderer) {
                // Fallback to localStorage if not in Electron
                return {
                    projectCodes: JSON.parse(localStorage.getItem('projectCodes') || '[]'),
                    timeEntries: JSON.parse(localStorage.getItem('timeEntries') || '[]'),
                    recentProjects: JSON.parse(localStorage.getItem('recentProjects') || '[]'),
                    settings: JSON.parse(localStorage.getItem('settings') || '{}')
                };
            }

            try {
                const result = await ipcRenderer.invoke('load-data');
                if (result.success && result.data) {
                    return result.data;
                }
                return null;
            } catch (error) {
                console.error('Error loading data:', error);
                return null;
            }
        };

        const saveDataToFile = async (data) => {
            if (!ipcRenderer) {
                // Fallback to localStorage if not in Electron
                localStorage.setItem('projectCodes', JSON.stringify(data.projectCodes));
                localStorage.setItem('timeEntries', JSON.stringify(data.timeEntries));
                localStorage.setItem('recentProjects', JSON.stringify(data.recentProjects));
                localStorage.setItem('settings', JSON.stringify(data.settings));
                return;
            }

            try {
                await ipcRenderer.invoke('save-data', data);
            } catch (error) {
                console.error('Error saving data:', error);
            }
        };

        const TimeTracker = () => {
            const [projectCodes, setProjectCodes] = useState([]);
            const [timeEntries, setTimeEntries] = useState([]);
            const [selectedProject, setSelectedProject] = useState('');
            const [isTracking, setIsTracking] = useState(false);
            const [currentSession, setCurrentSession] = useState(null);
            const [elapsedTime, setElapsedTime] = useState(0);
            const [showSetup, setShowSetup] = useState(false);
            const [storageError, setStorageError] = useState(null);
            const [currentPage, setCurrentPage] = useState(1);
            const intervalRef = useRef(null);

            // New state for 4-field structure
            const [newClientName, setNewClientName] = useState('');
            const [newProjectName, setNewProjectName] = useState('');
            const [newTaskCode, setNewTaskCode] = useState('');
            const [newSubtaskCode, setNewSubtaskCode] = useState('');
            const [linkedCSVPath, setLinkedCSVPath] = useState(null);

            // New state for comments
            const [currentComment, setCurrentComment] = useState('');

            // New state for recent projects
            const [recentProjects, setRecentProjects] = useState([]);

            // New state for settings
            const [showSettingsMenu, setShowSettingsMenu] = useState(false);
            const [showGuideModal, setShowGuideModal] = useState(false);
            const [timeRounding, setTimeRounding] = useState('none');
            const [autoPauseEnabled, setAutoPauseEnabled] = useState(false);
            const [autoPauseMinutes, setAutoPauseMinutes] = useState(15);
            const [dailyGoalEnabled, setDailyGoalEnabled] = useState(false);
            const [dailyGoalHours, setDailyGoalHours] = useState(8);
            const [lastActivityTime, setLastActivityTime] = useState(Date.now());
            const [dailyProgressEnabled, setDailyProgressEnabled] = useState(true);
            const [timeSummaryEnabled, setTimeSummaryEnabled] = useState(true);
            const [recentProjectsEnabled, setRecentProjectsEnabled] = useState(true);
            const [timeSummaryExpanded, setTimeSummaryExpanded] = useState(true);
            const [shortcutsExpanded, setShortcutsExpanded] = useState(false);
            const [chartPeriod, setChartPeriod] = useState('week'); // 'day', 'week', 'month'

            // Branding settings
            const [businessLogo, setBusinessLogo] = useState('');
            const [invoiceHeaderColor, setInvoiceHeaderColor] = useState('green'); // 'green', 'blue', 'red', 'plain'
            const [invoiceGrouping, setInvoiceGrouping] = useState('task-subtask'); // 'none', 'task', 'task-subtask'

            // Invoice metadata (stored per-client and globally)
            const [invoiceMetadata, setInvoiceMetadata] = useState({
                companyName: '',
                streetAddress: '',
                city: '',
                phone: '',
                fax: '',
                contactInfo: '',
                payeeName: '',
                invoiceNotes: '1. Total payment due in 30 days\n2. Please include the invoice number on your check'
            });

            // Idle detection settings (Stop timer when user is idle while tracking)
            const [idleDetectionEnabled, setIdleDetectionEnabled] = useState(false);
            const [idleTimeoutMinutes, setIdleTimeoutMinutes] = useState(10);
            const [showIdlePrompt, setShowIdlePrompt] = useState(false);
            const [idleDuration, setIdleDuration] = useState(0);
            const [idleStartTime, setIdleStartTime] = useState(null);
            const [pausedByIdle, setPausedByIdle] = useState(false);
            const [pausedBySystem, setPausedBySystem] = useState(false);

            // Activity reminder settings (Remind user to start tracking when active but not tracking)
            const [activityReminderEnabled, setActivityReminderEnabled] = useState(false);
            const [reminderIntervalMinutes, setReminderIntervalMinutes] = useState(10);
            const [showTrackingReminder, setShowTrackingReminder] = useState(false);
            const [lastReminderTime, setLastReminderTime] = useState(null);

            // License tier state (FREE/TRIAL/PREMIUM)
            const [licenseState, setLicenseState] = useState(null);
            const [checkingLicense, setCheckingLicense] = useState(true);
            const [showUpgradeDialog, setShowUpgradeDialog] = useState(false);
            const [upgradeKeyInput, setUpgradeKeyInput] = useState('');
            const [upgradeError, setUpgradeError] = useState('');
            const [upgradeSuccess, setUpgradeSuccess] = useState(false);

            // Manual update check state
            const [updateCheckMessage, setUpdateCheckMessage] = useState('');
            const [showUpdateCheckModal, setShowUpdateCheckModal] = useState(false);

            // Notification settings
            const [fullDayNotificationEnabled, setFullDayNotificationEnabled] = useState(true);
            const [hourlyBreakNotificationEnabled, setHourlyBreakNotificationEnabled] = useState(true);
            const [floatingTimerEnabled, setFloatingTimerEnabled] = useState(false);
            const [lastFullDayNotification, setLastFullDayNotification] = useState(null);
            const [lastHourlyNotification, setLastHourlyNotification] = useState(null);
            const [activeNotification, setActiveNotification] = useState(null);

            // Edit entry state
            const [editingEntry, setEditingEntry] = useState(null);
            const [editFormData, setEditFormData] = useState({});

            // Update notification state
            const [updateAvailable, setUpdateAvailable] = useState(false);
            const [updateInfo, setUpdateInfo] = useState(null);

            // Feedback modal state
            const [showFeedbackModal, setShowFeedbackModal] = useState(false);
            const [feedbackType, setFeedbackType] = useState('suggestion');
            const [feedbackText, setFeedbackText] = useState('');
            const [downloadProgress, setDownloadProgress] = useState(0);
            const [isDownloading, setIsDownloading] = useState(false);
            const [updateDownloaded, setUpdateDownloaded] = useState(false);

            // Time entries search state
            const [timeEntriesSearchTerm, setTimeEntriesSearchTerm] = useState('');

            // Search and hierarchy state
            const [projectSearchTerm, setProjectSearchTerm] = useState('');
            const [expandedClients, setExpandedClients] = useState({});
            const [expandedProjects, setExpandedProjects] = useState({});
            const [expandedTasks, setExpandedTasks] = useState({});

            // Inline add form state
            const [showAddTaskForm, setShowAddTaskForm] = useState(null); // stores key like "client::project"
            const [showAddSubtaskForm, setShowAddSubtaskForm] = useState(null); // stores key like "client::project::task"
            const [inlineTaskCode, setInlineTaskCode] = useState('');
            const [inlineSubtaskCode, setInlineSubtaskCode] = useState('');

            // CSV filter state
            const [filterStartDate, setFilterStartDate] = useState('');
            const [filterEndDate, setFilterEndDate] = useState('');
            const [filterClient, setFilterClient] = useState('');
            const [filterProject, setFilterProject] = useState('');
            const [mergeEntries, setMergeEntries] = useState(true); // Merge entries with same date/task/subtask

            // Release to Project Manager state
            const [showReviewModal, setShowReviewModal] = useState(false);
            const [reviewEntries, setReviewEntries] = useState([]);
            const [emailProvider, setEmailProvider] = useState(null); // 'outlook' or 'gmail'
            const [showProviderSelection, setShowProviderSelection] = useState(false);

            // Export format selection state
            const [showExportDialog, setShowExportDialog] = useState(false);

            // Invoice generation state
            const [showInvoiceClientSelection, setShowInvoiceClientSelection] = useState(false);
            const [selectedInvoiceClients, setSelectedInvoiceClients] = useState([]);
            const [invoiceHourlyRate, setInvoiceHourlyRate] = useState('');
            const [useRateForAll, setUseRateForAll] = useState(true);
            const [clientRates, setClientRates] = useState({});

            // Invoice review state
            const [showInvoiceReview, setShowInvoiceReview] = useState(false);
            const [showInvoiceDetails, setShowInvoiceDetails] = useState(false);

            // Invoice details form state
            const [invoiceCompanyName, setInvoiceCompanyName] = useState('');
            const [invoiceStreetAddress, setInvoiceStreetAddress] = useState('');
            const [invoiceCityStateZip, setInvoiceCityStateZip] = useState('');
            const [invoicePhone, setInvoicePhone] = useState('');
            const [invoiceEmail, setInvoiceEmail] = useState('');
            const [invoiceClientCompanyName, setInvoiceClientCompanyName] = useState('');
            const [invoiceClientStreetAddress, setInvoiceClientStreetAddress] = useState('');
            const [invoiceClientCityStateZip, setInvoiceClientCityStateZip] = useState('');
            const [invoiceClientPhone, setInvoiceClientPhone] = useState('');
            const [invoiceNumber, setInvoiceNumber] = useState('');
            const [invoiceDueDate, setInvoiceDueDate] = useState('');
            const [invoiceContactInfo, setInvoiceContactInfo] = useState('');
            const [invoiceMemo, setInvoiceMemo] = useState('');
            const [invoiceTaxRate, setInvoiceTaxRate] = useState('');

            // Company and Client Profile Management
            const [companyProfiles, setCompanyProfiles] = useState([]); // Array of {id, name, streetAddress, cityStateZip, phone, email}
            const [clientProfiles, setClientProfiles] = useState([]); // Array of {id, name, streetAddress, cityStateZip, phone, taxRate}
            const [showCompanyManager, setShowCompanyManager] = useState(false);
            const [showClientManager, setShowClientManager] = useState(false);
            const [editingCompanyProfile, setEditingCompanyProfile] = useState(null);
            const [editingClientProfile, setEditingClientProfile] = useState(null);
            const [selectedUserCompany, setSelectedUserCompany] = useState('');
            const [selectedBillToCompany, setSelectedBillToCompany] = useState('');

            // Cascading dropdown state for Track Time
            const [selectedClient, setSelectedClient] = useState('');
            const [selectedProjectName, setSelectedProjectName] = useState('');
            const [selectedTaskCode, setSelectedTaskCode] = useState('');
            const [selectedSubtaskCode, setSelectedSubtaskCode] = useState('');

            // Expenses state
            const [expenses, setExpenses] = useState([]);
            const [expenseTrackingEnabled, setExpenseTrackingEnabled] = useState(false);
            const [showAddExpenseModal, setShowAddExpenseModal] = useState(false);
            const [showExpensesView, setShowExpensesView] = useState(false);
            const [editingExpense, setEditingExpense] = useState(null);
            const [expenseFormData, setExpenseFormData] = useState({
                projectCode: '',
                description: '',
                category: 'Office Supplies',
                vendor: '',
                purchaseDate: new Date().toISOString().split('T')[0],
                priceBeforeTax: '',
                taxAmount: '',
                totalExpense: 0
            });

            // Check license tier on startup and auto-activate trial if new user
            useEffect(() => {
                const checkLicenseStatus = async () => {
                    try {
                        const state = await ipcRenderer.invoke('get-license-state');
                        console.log('License state:', state);

                        if (state.state === 'new' && state.needsActivation) {
                            // New user - auto-activate trial
                            const trialResult = await ipcRenderer.invoke('activate-trial');
                            if (trialResult.success) {
                                console.log('Trial activated:', trialResult.message);
                                // Get updated state
                                const updatedState = await ipcRenderer.invoke('get-license-state');
                                setLicenseState(updatedState);
                            } else {
                                console.error('Trial activation failed:', trialResult.error);
                                setLicenseState(state);
                            }
                        } else {
                            setLicenseState(state);
                        }

                        setCheckingLicense(false);
                    } catch (error) {
                        console.error('Error checking license:', error);
                        setCheckingLicense(false);
                    }
                };

                checkLicenseStatus();
            }, []);

            // Load data from file system
            useEffect(() => {
                if (!licenseState) return; // Don't load data until license state is checked

                const loadData = async () => {
                    try {
                        const data = await loadDataFromFile();

                        if (data && data.projectCodes) {
                            setProjectCodes(data.projectCodes);
                            if (data.projectCodes.length === 0) {
                                setShowSetup(true);
                            }
                        } else {
                            setShowSetup(true);
                        }

                        if (data && data.timeEntries) {
                            setTimeEntries(data.timeEntries);
                        }

                        if (data && data.recentProjects) {
                            setRecentProjects(data.recentProjects);
                        } else {
                            // Initialize with empty array if not present
                            setRecentProjects([]);
                        }

                        if (data && data.expenses) {
                            setExpenses(data.expenses);
                        } else {
                            setExpenses([]);
                        }

                        if (data && data.linkedCSVPath) {
                            setLinkedCSVPath(data.linkedCSVPath);
                        }

                        if (data && data.settings) {
                            const settings = data.settings;
                            setTimeRounding(settings.timeRounding || 'none');
                            setAutoPauseEnabled(settings.autoPauseEnabled || false);
                            setAutoPauseMinutes(settings.autoPauseMinutes || 15);
                            setDailyGoalEnabled(settings.dailyGoalEnabled || false);
                            setDailyGoalHours(settings.dailyGoalHours || 8);
                            setFullDayNotificationEnabled(settings.fullDayNotificationEnabled !== undefined ? settings.fullDayNotificationEnabled : true);
                            setHourlyBreakNotificationEnabled(settings.hourlyBreakNotificationEnabled !== undefined ? settings.hourlyBreakNotificationEnabled : true);
                            setFloatingTimerEnabled(settings.floatingTimerEnabled || false);
                            setLastFullDayNotification(settings.lastFullDayNotification || null);
                            setLastHourlyNotification(settings.lastHourlyNotification || null);
                            setDailyProgressEnabled(settings.dailyProgressEnabled !== undefined ? settings.dailyProgressEnabled : true);
                            setTimeSummaryEnabled(settings.timeSummaryEnabled !== undefined ? settings.timeSummaryEnabled : true);
                            setRecentProjectsEnabled(settings.recentProjectsEnabled !== undefined ? settings.recentProjectsEnabled : true);
                            setTimeSummaryExpanded(settings.timeSummaryExpanded !== undefined ? settings.timeSummaryExpanded : true);
                            setEmailProvider(settings.emailProvider || null);
                            setIdleDetectionEnabled(settings.idleDetectionEnabled || false);
                            setIdleTimeoutMinutes(settings.idleTimeoutMinutes || 10);
                            setActivityReminderEnabled(settings.activityReminderEnabled || false);
                            setReminderIntervalMinutes(settings.reminderIntervalMinutes || 10);
                            setExpenseTrackingEnabled(settings.expenseTrackingEnabled || false);
                            setBusinessLogo(settings.businessLogo || '');
                            setInvoiceHeaderColor(settings.invoiceHeaderColor || 'green');
                            setInvoiceGrouping(settings.invoiceGrouping || 'task-subtask');
                        }

                        // Load company and client profiles
                        if (data && data.companyProfiles) {
                            setCompanyProfiles(data.companyProfiles);
                        }
                        if (data && data.clientProfiles) {
                            setClientProfiles(data.clientProfiles);
                        }

                        // Restore active session if it exists
                        if (data && data.activeSession) {
                            const session = data.activeSession;
                            console.log('Restoring active session:', session);
                            setCurrentSession(session);
                            setIsTracking(true);
                            setElapsedTime(session.elapsedTime || 0);
                            setCurrentComment(session.currentComment || '');
                            setLastActivityTime(Date.now());
                            setSelectedProject(session.projectId);
                        }
                    } catch (error) {
                        console.error('Error loading data:', error);
                        setStorageError('Failed to load data');
                        setShowSetup(true);
                    }
                };

                loadData();
            }, [licenseState]);

            // Save all data to file whenever anything changes
            useEffect(() => {
                const saveData = async () => {
                    try {
                        const settings = {
                            timeRounding,
                            autoPauseEnabled,
                            autoPauseMinutes,
                            dailyGoalEnabled,
                            dailyGoalHours,
                            fullDayNotificationEnabled,
                            hourlyBreakNotificationEnabled,
                            floatingTimerEnabled,
                            lastFullDayNotification,
                            lastHourlyNotification,
                            dailyProgressEnabled,
                            timeSummaryEnabled,
                            recentProjectsEnabled,
                            timeSummaryExpanded,
                            emailProvider,
                            idleDetectionEnabled,
                            idleTimeoutMinutes,
                            activityReminderEnabled,
                            reminderIntervalMinutes,
                            expenseTrackingEnabled,
                            businessLogo,
                            invoiceHeaderColor,
                            invoiceGrouping
                        };

                        // Save current session info if tracking
                        const activeSession = isTracking && currentSession ? {
                            ...currentSession,
                            elapsedTime: elapsedTime,
                            currentComment: currentComment
                        } : null;

                        await saveDataToFile({
                            projectCodes,
                            timeEntries,
                            recentProjects,
                            expenses,
                            linkedCSVPath,
                            settings,
                            activeSession,
                            companyProfiles,
                            clientProfiles
                        });
                    } catch (error) {
                        console.error('Failed to save data:', error);
                    }
                };

                // Debounce saves to avoid too many writes
                const timeoutId = setTimeout(saveData, 500);
                return () => clearTimeout(timeoutId);
            }, [projectCodes, timeEntries, recentProjects, expenses, linkedCSVPath, timeRounding, autoPauseEnabled, autoPauseMinutes, dailyGoalEnabled, dailyGoalHours, fullDayNotificationEnabled, hourlyBreakNotificationEnabled, floatingTimerEnabled, lastFullDayNotification, lastHourlyNotification, dailyProgressEnabled, timeSummaryEnabled, recentProjectsEnabled, timeSummaryExpanded, emailProvider, idleDetectionEnabled, idleTimeoutMinutes, activityReminderEnabled, reminderIntervalMinutes, expenseTrackingEnabled, businessLogo, invoiceHeaderColor, invoiceGrouping, isTracking, currentSession, elapsedTime, currentComment, companyProfiles, clientProfiles]);

            // Activity tracking for auto-pause
            useEffect(() => {
                const updateActivity = () => {
                    setLastActivityTime(Date.now());
                };

                if (autoPauseEnabled && isTracking) {
                    window.addEventListener('mousemove', updateActivity);
                    window.addEventListener('keydown', updateActivity);
                    window.addEventListener('click', updateActivity);

                    return () => {
                        window.removeEventListener('mousemove', updateActivity);
                        window.removeEventListener('keydown', updateActivity);
                        window.removeEventListener('click', updateActivity);
                    };
                }
            }, [autoPauseEnabled, isTracking]);

            // Timer effect with auto-pause check
            useEffect(() => {
                if (isTracking && currentSession) {
                    intervalRef.current = setInterval(() => {
                        setElapsedTime(Date.now() - currentSession.startTime);

                        // Check for idle time
                        if (autoPauseEnabled) {
                            const idleTime = Date.now() - lastActivityTime;
                            const idleThreshold = autoPauseMinutes * 60 * 1000;

                            if (idleTime > idleThreshold) {
                                clearInterval(intervalRef.current);
                                const confirmStop = window.confirm(
                                    "You've been idle for " + autoPauseMinutes + " minutes.\n\nWere you still working on \"" + currentSession.projectCode + "\"?"
                                );

                                if (!confirmStop) {
                                    setIsTracking(false);
                                    setCurrentSession(null);
                                    setElapsedTime(0);
                                    setCurrentComment('');
                                } else {
                                    setLastActivityTime(Date.now());
                                    if (isTracking && currentSession) {
                                        intervalRef.current = setInterval(() => {
                                            setElapsedTime(Date.now() - currentSession.startTime);
                                        }, 1000);
                                    }
                                }
                            }
                        }
                    }, 1000);
                } else {
                    if (intervalRef.current) {
                        clearInterval(intervalRef.current);
                    }
                }

                return () => {
                    if (intervalRef.current) {
                        clearInterval(intervalRef.current);
                    }
                };
            }, [isTracking, currentSession, autoPauseEnabled, autoPauseMinutes, lastActivityTime]);

            // Keyboard shortcuts for recent projects (1-9,0), Enter to start, Space to pause, Arrow keys to toggle pages
            useEffect(() => {
                const handleKeyPress = (e) => {
                    const key = e.key;
                    const isInputField = e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT';

                    // Left/Right Arrow keys - Toggle between Track Time and Manage Projects (works everywhere except input fields)
                    if ((key === 'ArrowLeft' || key === 'ArrowRight') && !isInputField) {
                        e.preventDefault();
                        if (key === 'ArrowLeft') {
                            setShowSetup(false); // Go to Track Time page
                        } else {
                            setShowSetup(true); // Go to Manage Projects page
                        }
                        return;
                    }

                    // Enter key - Start tracking selected project (works everywhere including input fields)
                    if (key === 'Enter' && !showSetup) {
                        if (!isTracking && selectedProject) {
                            e.preventDefault();
                            startTracking();
                            return;
                        }
                    }

                    // Only trigger other shortcuts if not typing in an input/textarea and on Track Time page
                    if (showSetup || isInputField) {
                        return;
                    }

                    // Space key - Pause/Resume timer
                    if (key === ' ') {
                        e.preventDefault();
                        if (isTracking) {
                            stopTracking();
                        } else if (selectedProject) {
                            startTracking();
                        }
                        return;
                    }

                    // Number keys 1-9 and 0 - Quick select recent projects (0 = 10th project)
                    if ((key >= '1' && key <= '9') || key === '0') {
                        const index = key === '0' ? 9 : parseInt(key) - 1;
                        if (index < recentProjects.length) {
                            const projectId = recentProjects[index];
                            const project = projectCodes.find(p => p.id === projectId);

                            if (project) {
                                if (isTracking) {
                                    const isCurrentProject = currentSession && currentSession.projectId === projectId;
                                    if (!isCurrentProject) {
                                        switchProject(projectId);
                                    }
                                } else {
                                    setSelectedProject(projectId.toString());
                                }
                            }
                        }
                    }
                };

                window.addEventListener('keydown', handleKeyPress);
                return () => window.removeEventListener('keydown', handleKeyPress);
            }, [showSetup, recentProjects, projectCodes, isTracking, currentSession, selectedProject]);

            // Notification check effect
            useEffect(() => {
                if (!isTracking) return;

                const checkInterval = setInterval(() => {
                    const now = Date.now();
                    const today = getLocalDateString();

                    // Check for 8-hour full day notification
                    if (fullDayNotificationEnabled) {
                        const todaysHours = getTodaysTotalHours();
                        if (todaysHours >= 8) {
                            const lastNotifDate = lastFullDayNotification ? getLocalDateString(new Date(lastFullDayNotification)) : null;
                            if (lastNotifDate !== today) {
                                showNotification("ðŸŽ‰ That's a full day's work! You've hit 8 hours. Time to take a break!", 'success');
                                setLastFullDayNotification(now);
                            }
                        }
                    }

                    // Check for hourly break reminder
                    if (hourlyBreakNotificationEnabled && currentSession) {
                        const sessionDuration = now - currentSession.startTime;
                        const hoursPassed = Math.floor(sessionDuration / (1000 * 60 * 60));

                        if (hoursPassed > 0) {
                            const lastNotifHour = lastHourlyNotification ? Math.floor((now - lastHourlyNotification) / (1000 * 60 * 60)) : 999;
                            if (lastNotifHour >= 1) {
                                showNotification("ðŸ’§ Time for a 5-minute break! Go grab a drink of water.", 'info');
                                setLastHourlyNotification(now);
                            }
                        }
                    }
                }, 30000); // Check every 30 seconds

                return () => clearInterval(checkInterval);
            }, [isTracking, fullDayNotificationEnabled, hourlyBreakNotificationEnabled, currentSession, lastFullDayNotification, lastHourlyNotification, timeEntries, elapsedTime]);

            // Idle detection with Electron powerMonitor
            useEffect(() => {
                if (!ipcRenderer || !idleDetectionEnabled) return;

                const checkIdleTime = async () => {
                    if (!isTracking || !currentSession) return;

                    try {
                        const idleTimeSeconds = await ipcRenderer.invoke('get-idle-time');
                        const idleTimeMinutes = idleTimeSeconds / 60;

                        if (idleTimeMinutes >= idleTimeoutMinutes && !pausedByIdle && !showIdlePrompt) {
                            // User has been idle for the threshold period
                            const idleMs = idleTimeMinutes * 60 * 1000;
                            setPausedByIdle(true);
                            setIdleStartTime(Date.now() - idleMs);
                            setIdleDuration(idleMs);
                            setShowIdlePrompt(true);

                            // Pause the timer - the timer useEffect will handle clearing interval
                            setIsTracking(false);

                            // Show external idle prompt window
                            if (ipcRenderer) {
                                ipcRenderer.send('show-idle-prompt', {
                                    type: 'idle',
                                    isSystemSleep: false,
                                    projectCode: currentSession.projectCode,
                                    idleMinutes: Math.floor(idleTimeMinutes)
                                });
                            }
                        }
                    } catch (error) {
                        console.error('Error checking idle time:', error);
                    }
                };

                // Check idle time every 10 seconds
                const idleCheckInterval = setInterval(checkIdleTime, 10000);

                return () => clearInterval(idleCheckInterval);
            }, [ipcRenderer, idleDetectionEnabled, idleTimeoutMinutes, isTracking, currentSession, pausedByIdle, showIdlePrompt]);

            // IDLE DETECTION SERVICE: System event listeners for sleep/wake/shutdown (when tracking)
            useEffect(() => {
                if (!ipcRenderer || !idleDetectionEnabled) return;

                const handleSystemSuspend = () => {
                    if (isTracking && currentSession && !pausedBySystem) {
                        console.log('[IDLE DETECTION] System suspend detected - pausing timer');
                        setPausedBySystem(true);
                        setIdleStartTime(Date.now());
                        setIsTracking(false);
                    }
                };

                const handleSystemResume = () => {
                    if (pausedBySystem && currentSession) {
                        const idleMs = Date.now() - (idleStartTime || Date.now());
                        console.log('[IDLE DETECTION] System resume detected - idle for', Math.floor(idleMs / (1000 * 60)), 'minutes');
                        setIdleDuration(idleMs);
                        setShowIdlePrompt(true);

                        // Show external idle prompt window
                        if (ipcRenderer) {
                            ipcRenderer.send('show-idle-prompt', {
                                type: 'idle',
                                isSystemSleep: true,
                                projectCode: currentSession.projectCode,
                                idleMinutes: Math.floor(idleMs / (1000 * 60))
                            });
                        }
                    }
                };

                const handleSystemShutdown = () => {
                    if (isTracking && currentSession && !pausedBySystem) {
                        console.log('[IDLE DETECTION] System shutdown detected - pausing timer');
                        setPausedBySystem(true);
                        setIdleStartTime(Date.now());
                        setIsTracking(false);
                    }
                };

                const handleSystemLock = () => {
                    // Same as suspend for idle detection purposes
                    if (isTracking && currentSession && !pausedBySystem) {
                        console.log('[IDLE DETECTION] System lock detected - pausing timer');
                        setPausedBySystem(true);
                        setIdleStartTime(Date.now());
                        setIsTracking(false);
                    }
                };

                ipcRenderer.on('system-suspend', handleSystemSuspend);
                ipcRenderer.on('system-resume', handleSystemResume);
                ipcRenderer.on('system-shutdown', handleSystemShutdown);
                ipcRenderer.on('system-lock', handleSystemLock);

                return () => {
                    ipcRenderer.removeListener('system-suspend', handleSystemSuspend);
                    ipcRenderer.removeListener('system-resume', handleSystemResume);
                    ipcRenderer.removeListener('system-shutdown', handleSystemShutdown);
                    ipcRenderer.removeListener('system-lock', handleSystemLock);
                };
            }, [ipcRenderer, idleDetectionEnabled, isTracking, currentSession, pausedBySystem, idleStartTime]);

            // ACTIVITY REMINDER SERVICE: Remind user to start tracking when active but not tracking
            useEffect(() => {
                if (!activityReminderEnabled || isTracking) return;

                let lastActivityCheck = Date.now();

                const checkActivity = () => {
                    // Don't show if already showing
                    if (showTrackingReminder) return;

                    const now = Date.now();
                    const timeSinceLastReminder = lastReminderTime ? now - lastReminderTime : Infinity;
                    const reminderIntervalMs = reminderIntervalMinutes * 60 * 1000;

                    // Show reminder if enough time has passed since last reminder
                    if (timeSinceLastReminder > reminderIntervalMs) {
                        console.log('[ACTIVITY REMINDER] Showing reminder - user active but not tracking');
                        setShowTrackingReminder(true);
                        setLastReminderTime(now);

                        // Show external activity reminder window
                        if (ipcRenderer) {
                            ipcRenderer.send('show-idle-prompt', {
                                type: 'activity-reminder'
                            });
                        }
                    }
                };

                // Check on mouse/keyboard activity with debouncing
                const handleActivity = () => {
                    const now = Date.now();
                    const timeSinceLastCheck = now - lastActivityCheck;

                    // Only check once every 2 minutes to avoid spam
                    if (timeSinceLastCheck > 2 * 60 * 1000) {
                        lastActivityCheck = now;
                        checkActivity();
                    }
                };

                window.addEventListener('mousemove', handleActivity);
                window.addEventListener('keydown', handleActivity);

                return () => {
                    window.removeEventListener('mousemove', handleActivity);
                    window.removeEventListener('keydown', handleActivity);
                };
            }, [activityReminderEnabled, reminderIntervalMinutes, isTracking, showTrackingReminder, lastReminderTime, ipcRenderer]);

            // ACTIVITY REMINDER SERVICE: Show reminder on system unlock (when not tracking)
            useEffect(() => {
                if (!ipcRenderer || !activityReminderEnabled) return;

                const handleSystemUnlock = async () => {
                    // Only show reminder if not tracking
                    if (!isTracking && !showTrackingReminder) {
                        const now = Date.now();
                        const timeSinceLastReminder = lastReminderTime ? now - lastReminderTime : Infinity;
                        const reminderIntervalMs = reminderIntervalMinutes * 60 * 1000;

                        // Only show reminder if enough time has passed
                        if (timeSinceLastReminder > reminderIntervalMs) {
                            setTimeout(async () => {
                                if (!isTracking) {
                                    // Check if main window is visible before showing reminder
                                    const isMainWindowVisible = await ipcRenderer.invoke('is-main-window-visible');

                                    if (!isMainWindowVisible) {
                                        console.log('[ACTIVITY REMINDER] System unlock - showing tracking reminder');
                                        setShowTrackingReminder(true);
                                        setLastReminderTime(now);

                                        // Show external activity reminder window
                                        if (ipcRenderer) {
                                            ipcRenderer.send('show-idle-prompt', {
                                                type: 'activity-reminder'
                                            });
                                        }
                                    } else {
                                        console.log('[ACTIVITY REMINDER] Main window already visible - skipping reminder');
                                    }
                                }
                            }, 2000); // Wait 2 seconds after unlock
                        }
                    }
                };

                ipcRenderer.on('system-unlock', handleSystemUnlock);

                return () => {
                    ipcRenderer.removeListener('system-unlock', handleSystemUnlock);
                };
            }, [ipcRenderer, activityReminderEnabled, reminderIntervalMinutes, isTracking, showTrackingReminder, lastReminderTime]);

            // Helper function to get local date string in YYYY-MM-DD format
            const getLocalDateString = (date = new Date()) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const formatTime = (milliseconds) => {
                const seconds = Math.floor(milliseconds / 1000);
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const remainingSeconds = seconds % 60;
                return hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0') + ':' + remainingSeconds.toString().padStart(2, '0');
            };

            const getTodaysTotalHours = () => {
                const today = getLocalDateString();
                const todaysEntries = timeEntries.filter(entry => entry.date === today);
                const totalHours = todaysEntries.reduce((sum, entry) => sum + entry.hours, 0);

                if (isTracking && currentSession && currentSession.date === today) {
                    const currentHours = elapsedTime / (1000 * 60 * 60);
                    return totalHours + currentHours;
                }
                return totalHours;
            };

            const getThisWeeksTotalHours = () => {
                const now = new Date();
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - now.getDay()); // Sunday
                const startDateStr = getLocalDateString(startOfWeek);

                const weekEntries = timeEntries.filter(entry => {
                    // String comparison to match export logic exactly
                    return entry.date >= startDateStr;
                });
                const totalHours = weekEntries.reduce((sum, entry) => sum + entry.hours, 0);

                if (isTracking && currentSession) {
                    if (currentSession.date >= startDateStr) {
                        const currentHours = elapsedTime / (1000 * 60 * 60);
                        return totalHours + currentHours;
                    }
                }
                return totalHours;
            };

            const getThisMonthsTotalHours = () => {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth() + 1; // 1-12
                const monthStr = year + '-' + String(month).padStart(2, '0');

                const monthEntries = timeEntries.filter(entry => {
                    // String comparison: entry.date is "YYYY-MM-DD", monthStr is "YYYY-MM"
                    return entry.date && entry.date.startsWith(monthStr);
                });
                const totalHours = monthEntries.reduce((sum, entry) => sum + entry.hours, 0);

                if (isTracking && currentSession) {
                    if (currentSession.date && currentSession.date.startsWith(monthStr)) {
                        const currentHours = elapsedTime / (1000 * 60 * 60);
                        return totalHours + currentHours;
                    }
                }
                return totalHours;
            };

            // Chart data functions
            const getChartData = () => {
                if (chartPeriod === 'day') {
                    return getTodayChartData();
                } else if (chartPeriod === 'week') {
                    return getWeekChartData();
                } else {
                    return getMonthChartData();
                }
            };

            const getTodayChartData = () => {
                const today = getLocalDateString();
                const todaysEntries = timeEntries.filter(entry => entry.date === today);
                const totalHours = todaysEntries.reduce((sum, entry) => sum + entry.hours, 0);
                const currentHours = (isTracking && currentSession && currentSession.date === today) ? elapsedTime / (1000 * 60 * 60) : 0;
                return [{ label: 'Today', hours: totalHours + currentHours }];
            };

            const getWeekChartData = () => {
                const now = new Date();
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - now.getDay());
                startOfWeek.setHours(0, 0, 0, 0);

                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const chartData = [];

                for (let i = 0; i < 7; i++) {
                    const date = new Date(startOfWeek);
                    date.setDate(startOfWeek.getDate() + i);
                    const dateStr = getLocalDateString(date);

                    const dayEntries = timeEntries.filter(entry => entry.date === dateStr);
                    let totalHours = dayEntries.reduce((sum, entry) => sum + entry.hours, 0);

                    if (isTracking && currentSession && currentSession.date === dateStr) {
                        totalHours += elapsedTime / (1000 * 60 * 60);
                    }

                    chartData.push({ label: days[i], hours: totalHours });
                }

                return chartData;
            };

            const getMonthChartData = () => {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

                const chartData = [];
                const weekData = {};

                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(currentYear, currentMonth, day);
                    const dateStr = getLocalDateString(date);
                    const weekNum = Math.ceil(day / 7);

                    const dayEntries = timeEntries.filter(entry => entry.date === dateStr);
                    let totalHours = dayEntries.reduce((sum, entry) => sum + entry.hours, 0);

                    if (isTracking && currentSession && currentSession.date === dateStr) {
                        totalHours += elapsedTime / (1000 * 60 * 60);
                    }

                    weekData[weekNum] = (weekData[weekNum] || 0) + totalHours;
                }

                for (let week in weekData) {
                    chartData.push({ label: `Week ${week}`, hours: weekData[week] });
                }

                return chartData;
            };

            const getProjectChartData = () => {
                const chartData = getChartData();
                const totalHours = chartData.reduce((sum, d) => sum + d.hours, 0);

                if (totalHours === 0) return [];

                let entries = [];
                if (chartPeriod === 'day') {
                    const today = getLocalDateString();
                    entries = timeEntries.filter(entry => entry.date === today);
                    if (isTracking && currentSession && currentSession.date === today) {
                        entries = [...entries, { ...currentSession, hours: elapsedTime / (1000 * 60 * 60) }];
                    }
                } else if (chartPeriod === 'week') {
                    const now = new Date();
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    startOfWeek.setHours(0, 0, 0, 0);
                    entries = timeEntries.filter(entry => new Date(entry.date) >= startOfWeek);
                    if (isTracking && currentSession) {
                        const sessionDate = new Date(currentSession.date);
                        if (sessionDate >= startOfWeek) {
                            entries = [...entries, { ...currentSession, hours: elapsedTime / (1000 * 60 * 60) }];
                        }
                    }
                } else {
                    const now = new Date();
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();
                    entries = timeEntries.filter(entry => {
                        const entryDate = new Date(entry.date);
                        return entryDate.getMonth() === currentMonth && entryDate.getFullYear() === currentYear;
                    });
                    if (isTracking && currentSession) {
                        const sessionDate = new Date(currentSession.date);
                        if (sessionDate.getMonth() === currentMonth && sessionDate.getFullYear() === currentYear) {
                            entries = [...entries, { ...currentSession, hours: elapsedTime / (1000 * 60 * 60) }];
                        }
                    }
                }

                const projectHours = {};
                entries.forEach(entry => {
                    // Group by project name (clientName - projectName) instead of task code
                    const projectName = entry.projectName || entry.clientName || 'Unknown';
                    projectHours[projectName] = (projectHours[projectName] || 0) + entry.hours;
                });

                return Object.entries(projectHours).map(([project, hours]) => ({
                    project,
                    hours,
                    percentage: (hours / totalHours * 100).toFixed(1)
                })).sort((a, b) => b.hours - a.hours);
            };

            const getChartTitle = () => {
                if (chartPeriod === 'day') {
                    const today = new Date();
                    return today.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                } else if (chartPeriod === 'week') {
                    const now = new Date();
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    return startOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' - ' + endOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                } else {
                    const now = new Date();
                    return now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                }
            };

            const roundTime = (milliseconds) => {
                if (timeRounding === 'none') return milliseconds;
                const minutes = milliseconds / (1000 * 60);
                const roundTo = parseInt(timeRounding);
                // Round UP to the nearest interval (ceiling)
                const roundedMinutes = Math.ceil(minutes / roundTo) * roundTo;
                return roundedMinutes * 60 * 1000;
            };

            const addProjectCode = () => {
                if (!newClientName.trim() || !newProjectName.trim() || !newTaskCode.trim() || !newSubtaskCode.trim()) {
                    setStorageError('Please fill in all 4 fields');
                    return;
                }

                const newProject = {
                    id: Date.now() + Math.random(),
                    clientName: newClientName.trim(),
                    projectName: newProjectName.trim(),
                    taskCode: newTaskCode.trim().toUpperCase(),
                    subtaskCode: newSubtaskCode.trim().toUpperCase(),
                    code: newTaskCode.trim().toUpperCase() + '-' + newSubtaskCode.trim().toUpperCase()
                };

                setProjectCodes(prev => [...prev, newProject]);
                setNewClientName('');
                setNewProjectName('');
                setNewTaskCode('');
                setNewSubtaskCode('');
                setStorageError(null);
            };

            // Add task inline to an existing project
            const addInlineTask = (clientName, projectName) => {
                if (!inlineTaskCode.trim()) {
                    return;
                }

                const newProject = {
                    id: Date.now() + Math.random(),
                    clientName: clientName,
                    projectName: projectName,
                    taskCode: inlineTaskCode.trim().toUpperCase(),
                    subtaskCode: 'NEW',
                    code: inlineTaskCode.trim().toUpperCase() + '-NEW'
                };

                setProjectCodes(prev => [...prev, newProject]);
                setInlineTaskCode('');
                setShowAddTaskForm(null);
                showNotification('Task added successfully! Add subtasks below.', 'success');
            };

            // Add subtask inline to an existing task
            const addInlineSubtask = (clientName, projectName, taskCode) => {
                if (!inlineSubtaskCode.trim()) {
                    return;
                }

                const newProject = {
                    id: Date.now() + Math.random(),
                    clientName: clientName,
                    projectName: projectName,
                    taskCode: taskCode,
                    subtaskCode: inlineSubtaskCode.trim().toUpperCase(),
                    code: taskCode + '-' + inlineSubtaskCode.trim().toUpperCase()
                };

                setProjectCodes(prev => [...prev, newProject]);
                setInlineSubtaskCode('');
                setShowAddSubtaskForm(null);
                showNotification('Subtask added successfully!', 'success');
            };

            const deleteProjectCode = (id) => {
                setProjectCodes(prev => prev.filter(project => project.id !== id));
            };

            // Unified Export function - opens review modal for both export types
            const startExportWorkflow = () => {
                if (timeEntries.length === 0) {
                    setStorageError('No time entries to export');
                    return;
                }

                // Filter entries based on current filters
                const filteredEntries = timeEntries.filter(entry => {
                    let matches = true;
                    if (filterStartDate && entry.date < filterStartDate) matches = false;
                    if (filterEndDate && entry.date > filterEndDate) matches = false;
                    if (filterClient && entry.clientName !== filterClient) matches = false;
                    if (filterProject && entry.projectName !== filterProject) matches = false;
                    return matches;
                });

                if (filteredEntries.length === 0) {
                    setStorageError('No entries match the filters');
                    return;
                }

                // Set review entries and show the review modal
                setReviewEntries(filteredEntries.map(entry => ({ ...entry })));
                setShowReviewModal(true);
            };

            // Legacy function kept for backwards compatibility
            const startReleaseWorkflow = startExportWorkflow;

            const updateReviewEntry = (index, field, value) => {
                setReviewEntries(prev => {
                    const updated = [...prev];
                    updated[index][field] = value;
                    return updated;
                });
            };

            const exportToExcelOnly = async () => {
                try {
                    // Use the shared workbook generation function with reviewEntries
                    const workbook = await generateExcelWorkbook(reviewEntries);

                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

                    // Create download link
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;

                    const startDateStr = filterStartDate || 'all';
                    const endDateStr = filterEndDate || 'dates';
                    a.download = `Timesheet_${startDateStr}_to_${endDateStr}.xlsx`;

                    a.click();
                    window.URL.revokeObjectURL(url);

                    setShowReviewModal(false);
                    showNotification('Timesheet exported successfully!', 'success');

                } catch (error) {
                    console.error('Error exporting to Excel:', error);
                    setStorageError('Failed to export to Excel: ' + error.message);
                }
            };

            const confirmAndCreateEmail = async () => {
                // Check if email provider is set
                if (!emailProvider) {
                    setShowProviderSelection(true);
                    return;
                }

                await createEmailDraft();
            };

            const selectEmailProvider = async (provider) => {
                setEmailProvider(provider);
                setShowProviderSelection(false);
                await createEmailDraft();
            };

            const createEmailDraft = async () => {
                try {
                    // Use the shared workbook generation function with reviewEntries
                    const workbook = await generateExcelWorkbook(reviewEntries);

                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

                    // Save to Documents/ThymeSheet folder for reliable access
                    const fs = window.require('fs');
                    const path = window.require('path');
                    const os = window.require('os');

                    // Ensure we have valid date strings for filename
                    const startDateStr = filterStartDate || new Date().toISOString().split('T')[0];
                    const endDateStr = filterEndDate || new Date().toISOString().split('T')[0];

                    // Try Documents folder first, then Desktop as fallback
                    let savePath;
                    let saveLocation;
                    const fileName = `Timesheet_${startDateStr}_to_${endDateStr}.xlsx`;

                    // Try Documents/ThymeSheet folder
                    const documentsPath = path.join(os.homedir(), 'Documents', 'ThymeSheet');
                    try {
                        if (!fs.existsSync(documentsPath)) {
                            fs.mkdirSync(documentsPath, { recursive: true });
                        }
                        savePath = path.join(documentsPath, fileName);
                        saveLocation = 'Documents\\ThymeSheet';
                    } catch (err) {
                        // Fallback to Desktop
                        const desktopPath = path.join(os.homedir(), 'Desktop');
                        savePath = path.join(desktopPath, fileName);
                        saveLocation = 'Desktop';
                    }

                    // Write file with error handling
                    const arrayBuffer = await blob.arrayBuffer();
                    const uint8Array = new Uint8Array(arrayBuffer);

                    try {
                        fs.writeFileSync(savePath, uint8Array);

                        // Verify file was created
                        if (!fs.existsSync(savePath)) {
                            throw new Error('File was not created successfully');
                        }
                    } catch (writeError) {
                        console.error('Error writing file:', writeError);
                        throw new Error(`Failed to save file to ${saveLocation}: ${writeError.message}`);
                    }

                    const filePath = savePath;

                    // Build dynamic subject based on filters
                    let subjectParts = ['Timesheet'];

                    // Add date range
                    if (filterStartDate && filterEndDate) {
                        subjectParts.push(`${filterStartDate} to ${filterEndDate}`);
                    } else if (filterStartDate) {
                        subjectParts.push(`from ${filterStartDate}`);
                    } else if (filterEndDate) {
                        subjectParts.push(`until ${filterEndDate}`);
                    }

                    // Add client if specified
                    if (filterClient) {
                        subjectParts.push(filterClient);
                    }

                    // Add project if specified
                    if (filterProject) {
                        subjectParts.push(filterProject);
                    }

                    const subject = subjectParts.join(' - ');

                    // Build email body
                    const dateRange = filterStartDate && filterEndDate
                        ? `${filterStartDate} to ${filterEndDate}`
                        : 'the reporting period';

                    let emailBody = `Hello,\n\nPlease find attached my timesheet for ${dateRange}`;

                    if (filterClient || filterProject) {
                        emailBody += '\n\nProject Details:';
                        if (filterClient) emailBody += `\nClient: ${filterClient}`;
                        if (filterProject) emailBody += `\nProject: ${filterProject}`;
                    }

                    emailBody += `\n\nBest regards`;

                    const { shell } = window.require('electron');

                    // Open Outlook with mailto link
                    try {
                        const mailto = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
                        shell.openExternal(mailto);

                        // Wait a moment then show the Excel file for attachment
                        setTimeout(() => {
                            shell.showItemInFolder(filePath);
                        }, 1000);

                        setShowReviewModal(false);

                        // Show success notification
                        setTimeout(() => {
                            showNotification(`Outlook opened! Attach ${fileName} from the folder.`, 'success');
                        }, 500);

                    } catch (err) {
                        console.error('Failed to open email:', err);
                        setStorageError('Failed to open email client: ' + err.message);
                    }

                } catch (error) {
                    console.error('Error creating email:', error);
                    setStorageError('Failed to create email draft: ' + error.message);
                }
            };

            const updateRecentProjects = (projectId) => {
                setRecentProjects(prev => {
                    const newRecent = [projectId, ...prev.filter(id => id !== projectId)].slice(0, 10);
                    return newRecent;
                });
            };

            const startTracking = () => {
                if (!selectedProject) {
                    setStorageError('Please select a project code');
                    return;
                }

                const project = projectCodes.find(p => p.id.toString() === selectedProject.toString());
                if (!project) return;

                const session = {
                    projectId: project.id,
                    projectCode: project.code,
                    clientName: project.clientName,
                    projectName: project.projectName,
                    taskCode: project.taskCode,
                    subtaskCode: project.subtaskCode,
                    startTime: Date.now(),
                    date: getLocalDateString()
                };

                setCurrentSession(session);
                setIsTracking(true);
                setElapsedTime(0);
                setStorageError(null);
                setLastActivityTime(Date.now());
                updateRecentProjects(project.id);
            };

            useEffect(() => {
                window.currentTimerToggle = () => {
                    if (isTracking) {
                        stopTracking();
                    } else if (selectedProject) {
                        startTracking();
                    }
                };

                window.openSettings = () => {
                    setShowSettingsMenu(true);
                };

                window.showGuide = () => {
                    setShowGuideModal(true);
                };

                window.navigateTo = (page) => {
                    setShowSetup(page === 'manage');
                };

                window.showUpgradeDialogFn = () => {
                    setShowUpgradeDialog(true);
                };

                window.exportAllData = async () => {
                    if (!ipcRenderer) return;
                    try {
                        const result = await ipcRenderer.invoke('export-data');
                        if (result.success && !result.canceled) {
                            setStorageError('Data exported successfully to: ' + result.path);
                            setTimeout(() => setStorageError(null), 5000);
                        }
                    } catch (error) {
                        setStorageError('Export failed: ' + error.message);
                    }
                };

                window.importAllData = async () => {
                    if (!ipcRenderer) return;
                    try {
                        const result = await ipcRenderer.invoke('import-data');
                        if (result.success && !result.canceled) {
                            // Reload data after import
                            const data = await loadDataFromFile();
                            if (data) {
                                setProjectCodes(data.projectCodes || []);
                                setTimeEntries(data.timeEntries || []);
                                setRecentProjects(data.recentProjects || []);
                                if (data.settings) {
                                    setTimeRounding(data.settings.timeRounding || 'none');
                                    setAutoPauseEnabled(data.settings.autoPauseEnabled || false);
                                    setAutoPauseMinutes(data.settings.autoPauseMinutes || 15);
                                    setCompactMode(data.settings.compactMode || false);
                                    setDailyGoalEnabled(data.settings.dailyGoalEnabled || false);
                                    setDailyGoalHours(data.settings.dailyGoalHours || 8);
                                    setIdleDetectionEnabled(data.settings.idleDetectionEnabled || false);
                                    setIdleTimeoutMinutes(data.settings.idleTimeoutMinutes || 10);
                                }
                                setStorageError('Data imported successfully! Please restart the app to see all changes.');
                                setTimeout(() => setStorageError(null), 5000);
                            }
                        }
                    } catch (error) {
                        setStorageError('Import failed: ' + error.message);
                    }
                };
            }, [isTracking, selectedProject]);

            // Listen for show-guide IPC event
            useEffect(() => {
                if (!ipcRenderer) return;

                const handleShowGuide = () => {
                    setShowGuideModal(true);
                };

                ipcRenderer.on('show-guide', handleShowGuide);

                return () => {
                    ipcRenderer.removeListener('show-guide', handleShowGuide);
                };
            }, []);

            // Listen for open-settings IPC event
            useEffect(() => {
                if (!ipcRenderer) return;

                const handleOpenSettings = () => {
                    setShowSettingsMenu(true);
                };

                ipcRenderer.on('open-settings', handleOpenSettings);

                return () => {
                    ipcRenderer.removeListener('open-settings', handleOpenSettings);
                };
            }, []);

            // Listen for update events
            useEffect(() => {
                if (!ipcRenderer) return;

                const handleUpdateAvailable = (event, info) => {
                    console.log('Update available:', info);
                    setUpdateAvailable(true);
                    setUpdateInfo(info);
                    setShowUpdateCheckModal(false); // Close manual check modal if open
                };

                const handleDownloadProgress = (event, progressObj) => {
                    console.log('Download progress:', progressObj);
                    setDownloadProgress(progressObj.percent);
                };

                const handleUpdateDownloaded = (event, info) => {
                    console.log('Update downloaded:', info);
                    setIsDownloading(false);
                    setUpdateDownloaded(true);
                };

                const handleUpdateError = (event, error) => {
                    console.error('Update error:', error);
                    setIsDownloading(false);
                };

                ipcRenderer.on('update-available', handleUpdateAvailable);
                ipcRenderer.on('download-progress', handleDownloadProgress);
                ipcRenderer.on('update-downloaded', handleUpdateDownloaded);
                ipcRenderer.on('update-error', handleUpdateError);

                const handleShowFeedback = () => {
                    setShowFeedbackModal(true);
                };
                ipcRenderer.on('show-feedback', handleShowFeedback);

                const handleManualCheckForUpdates = async () => {
                    setUpdateCheckMessage('Checking for updates...');
                    setShowUpdateCheckModal(true);
                    await ipcRenderer.invoke('check-for-updates');
                };
                ipcRenderer.on('manual-check-for-updates', handleManualCheckForUpdates);

                const handleUpdateNotAvailable = () => {
                    setUpdateCheckMessage('You are already running the latest version!');
                };
                ipcRenderer.on('update-not-available', handleUpdateNotAvailable);

                return () => {
                    ipcRenderer.removeListener('update-available', handleUpdateAvailable);
                    ipcRenderer.removeListener('download-progress', handleDownloadProgress);
                    ipcRenderer.removeListener('update-downloaded', handleUpdateDownloaded);
                    ipcRenderer.removeListener('update-error', handleUpdateError);
                    ipcRenderer.removeListener('show-feedback', handleShowFeedback);
                    ipcRenderer.removeListener('manual-check-for-updates', handleManualCheckForUpdates);
                    ipcRenderer.removeListener('update-not-available', handleUpdateNotAvailable);
                };
            }, []);

            // Handle floating timer window toggle
            useEffect(() => {
                if (!ipcRenderer) return;
                ipcRenderer.send('toggle-floating-timer', floatingTimerEnabled);
            }, [floatingTimerEnabled]);

            // Send tracking state to main process for background monitoring
            // Send tracking state to main process for background activity monitoring
            useEffect(() => {
                if (!ipcRenderer) return;

                ipcRenderer.send('tracking-state-update', {
                    isTracking,
                    activityReminderEnabled,
                    reminderInterval: reminderIntervalMinutes
                });
            }, [ipcRenderer, isTracking, activityReminderEnabled, reminderIntervalMinutes]);

            // Listen for idle prompt actions from external window
            useEffect(() => {
                if (!ipcRenderer) return;

                const handleIdlePromptAction = (_event, action, promptType) => {
                    if (action === 'resume') {
                        if (promptType === 'activity-reminder') {
                            // Activity reminder - show main window and navigate to Track Time page
                            console.log('[ACTIVITY REMINDER] User clicked Start Tracking - opening app');
                            setShowTrackingReminder(false);
                            setCurrentPage(1); // Navigate to Track Time page

                            // Tell main process to show and focus the window
                            if (ipcRenderer) {
                                ipcRenderer.send('show-main-window');
                            }
                        } else {
                            // Idle detection - resume tracking
                            handleResumeTracking();
                        }
                    } else if (action === 'assign') {
                        if (pausedByIdle || pausedBySystem) {
                            // Idle detection - assign idle time
                            handleAssignIdleTime();
                        } else {
                            // Activity reminder - just dismiss
                            console.log('[ACTIVITY REMINDER] User dismissed reminder');
                            setShowTrackingReminder(false);
                            setLastReminderTime(Date.now());
                        }
                    }
                };

                ipcRenderer.on('idle-prompt-action', handleIdlePromptAction);

                return () => {
                    ipcRenderer.removeListener('idle-prompt-action', handleIdlePromptAction);
                };
            }, [ipcRenderer, pausedByIdle, pausedBySystem]);

            // Send timer updates to floating window
            useEffect(() => {
                if (!ipcRenderer || !floatingTimerEnabled) return;

                if (isTracking && currentSession) {
                    const timerData = {
                        isTracking: true,
                        elapsedTime,
                        projectCode: currentSession.projectCode,
                        clientName: currentSession.clientName,
                        projectName: currentSession.projectName,
                        taskCode: currentSession.taskCode,
                        subtaskCode: currentSession.subtaskCode
                    };

                    ipcRenderer.send('update-floating-timer', timerData);
                } else {
                    // Send stopped state
                    ipcRenderer.send('update-floating-timer', {
                        isTracking: false,
                        elapsedTime: 0,
                        projectCode: 'Not tracking',
                        clientName: '',
                        projectName: '',
                        taskCode: '',
                        subtaskCode: ''
                    });
                }
            }, [floatingTimerEnabled, isTracking, currentSession, elapsedTime, ipcRenderer]);

            const stopTracking = () => {
                if (currentSession) {
                    const endTime = Date.now();
                    const duration = roundTime(endTime - currentSession.startTime);

                    const newEntry = {
                        id: Date.now() + Math.random(),
                        projectId: currentSession.projectId,
                        projectCode: currentSession.projectCode,
                        clientName: currentSession.clientName,
                        projectName: currentSession.projectName,
                        taskCode: currentSession.taskCode,
                        subtaskCode: currentSession.subtaskCode,
                        date: currentSession.date,
                        startTime: new Date(currentSession.startTime).toLocaleTimeString(),
                        endTime: new Date(endTime).toLocaleTimeString(),
                        duration: duration,
                        hours: duration / (1000 * 60 * 60),
                        comment: currentComment
                    };

                    setTimeEntries(prev => [...prev, newEntry]);
                    setIsTracking(false);
                    setCurrentSession(null);
                    setElapsedTime(0);
                    setCurrentComment('');
                }
            };

            const switchProject = (newProjectId) => {
                console.log('switchProject called with:', newProjectId, 'type:', typeof newProjectId);

                // Use loose equality (==) to handle type differences and compare using Math.floor for floating point issues
                const targetId = Math.floor(typeof newProjectId === 'string' ? parseFloat(newProjectId) : newProjectId);
                console.log('Normalized target ID:', targetId);

                const project = projectCodes.find(p => {
                    const projectId = Math.floor(typeof p.id === 'string' ? parseFloat(p.id) : p.id);
                    console.log('Checking project:', projectId, 'against', targetId, 'Match:', projectId == targetId);
                    return projectId == targetId;
                });

                console.log('Found project:', project);

                if (!project) {
                    console.error('Project not found!');
                    console.error('Available project IDs:', projectCodes.map(p => p.id));
                    return;
                }

                // Save the current session to create a time entry before switching
                if (isTracking && currentSession) {
                    console.log('Saving current session');
                    const endTime = Date.now();
                    const duration = roundTime(endTime - currentSession.startTime);

                    const newEntry = {
                        id: Date.now() + Math.random(),
                        projectId: currentSession.projectId,
                        projectCode: currentSession.projectCode,
                        clientName: currentSession.clientName,
                        projectName: currentSession.projectName,
                        taskCode: currentSession.taskCode,
                        subtaskCode: currentSession.subtaskCode,
                        date: currentSession.date,
                        startTime: new Date(currentSession.startTime).toLocaleTimeString(),
                        endTime: new Date(endTime).toLocaleTimeString(),
                        duration: duration,
                        hours: duration / (1000 * 60 * 60),
                        comment: currentComment
                    };

                    setTimeEntries(prev => [...prev, newEntry]);
                }

                // Create new session for the new project
                const newSession = {
                    projectId: project.id,
                    projectCode: project.code,
                    clientName: project.clientName,
                    projectName: project.projectName,
                    taskCode: project.taskCode,
                    subtaskCode: project.subtaskCode,
                    startTime: Date.now(),
                    date: getLocalDateString()
                };

                console.log('Setting new session:', newSession);

                // Update all states together
                setCurrentSession(newSession);
                setIsTracking(true);
                setElapsedTime(0);
                setCurrentComment('');
                setLastActivityTime(Date.now());
                updateRecentProjects(project.id);

                console.log('Switch complete!');
            };

            // Idle time handling functions
            const handleResumeTracking = () => {
                // Resume tracking from where we left off
                if (currentSession && (pausedByIdle || pausedBySystem)) {
                    setPausedByIdle(false);
                    setPausedBySystem(false);
                    setShowIdlePrompt(false);
                    setIdleDuration(0);
                    setIdleStartTime(null);

                    // Restart the timer
                    setIsTracking(true);
                    setLastActivityTime(Date.now());

                    showNotification('Tracking resumed for ' + currentSession.projectCode, 'success');
                }
            };

            const handleAssignIdleTime = () => {
                // Assign idle time to the last project
                if (currentSession && (pausedByIdle || pausedBySystem) && idleDuration > 0) {
                    const idleHours = idleDuration / (1000 * 60 * 60);

                    // Create a new entry for the idle time
                    const idleEntry = {
                        id: Date.now() + Math.random(),
                        projectId: currentSession.projectId,
                        projectCode: currentSession.projectCode,
                        clientName: currentSession.clientName,
                        projectName: currentSession.projectName,
                        taskCode: currentSession.taskCode,
                        subtaskCode: currentSession.subtaskCode,
                        date: currentSession.date,
                        startTime: new Date(idleStartTime || Date.now()).toLocaleTimeString(),
                        endTime: new Date(Date.now()).toLocaleTimeString(),
                        duration: idleDuration,
                        hours: idleHours,
                        comment: (currentComment || '') + (currentComment ? ' ' : '') + '(idle time assigned)'
                    };

                    setTimeEntries(prev => [...prev, idleEntry]);

                    // Reset idle state and resume tracking
                    setPausedByIdle(false);
                    setPausedBySystem(false);
                    setShowIdlePrompt(false);
                    setIdleDuration(0);
                    setIdleStartTime(null);

                    // Resume tracking
                    setIsTracking(true);
                    setLastActivityTime(Date.now());

                    const idleMinutes = Math.floor(idleDuration / (1000 * 60));
                    showNotification(`Assigned ${idleMinutes} minutes of idle time to ${currentSession.projectCode}`, 'success');
                }
            };

            const handleDismissTrackingReminder = () => {
                setShowTrackingReminder(false);
                // Update lastReminderTime so it doesn't show again immediately
                setLastReminderTime(Date.now());
            };

            const handleStartTrackingFromReminder = () => {
                setShowTrackingReminder(false);
                if (recentProjects.length > 0 && !selectedProject) {
                    // Auto-select the most recent project
                    setSelectedProject(recentProjects[0].toString());
                }
                // Switch to Track Time page if not already there
                setShowSetup(false);
            };

            const deleteEntry = (id) => {
                setTimeEntries(prev => prev.filter(entry => entry.id !== id));
            };

            const startEditEntry = (entry) => {
                // Convert locale time string (e.g., "3:45:30 PM") to 24-hour format (e.g., "15:45:30") for time input
                const convertToTimeInputFormat = (timeStr) => {
                    if (!timeStr) return '';
                    // If already in 24-hour format (HH:MM:SS), return as is
                    if (/^\d{2}:\d{2}(:\d{2})?$/.test(timeStr)) return timeStr;

                    // Parse locale time string
                    const today = getLocalDateString();
                    const dateTimeStr = today + ' ' + timeStr;
                    const date = new Date(dateTimeStr);

                    if (isNaN(date.getTime())) return timeStr; // Return original if parse fails

                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = String(date.getSeconds()).padStart(2, '0');
                    return `${hours}:${minutes}:${seconds}`;
                };

                setEditingEntry(entry.id);
                setEditFormData({
                    date: entry.date,
                    startTime: convertToTimeInputFormat(entry.startTime),
                    endTime: convertToTimeInputFormat(entry.endTime),
                    comment: entry.comment || '',
                    projectId: entry.projectId
                });
            };

            const cancelEditEntry = () => {
                setEditingEntry(null);
                setEditFormData({});
            };

            const saveEditEntry = () => {
                if (!editingEntry) return;

                setTimeEntries(prev => prev.map(entry => {
                    if (entry.id === editingEntry) {
                        // Parse times to calculate new duration
                        const [startHour, startMin, startSec] = editFormData.startTime.split(':').map(Number);
                        const [endHour, endMin, endSec] = editFormData.endTime.split(':').map(Number);

                        const startMs = (startHour * 3600 + startMin * 60 + (startSec || 0)) * 1000;
                        const endMs = (endHour * 3600 + endMin * 60 + (endSec || 0)) * 1000;

                        let duration = endMs - startMs;
                        if (duration < 0) duration += 24 * 3600 * 1000; // Handle overnight

                        // Get updated project information if project was changed
                        const project = projectCodes.find(p => p.id === editFormData.projectId);

                        return {
                            ...entry,
                            date: editFormData.date,
                            startTime: editFormData.startTime,
                            endTime: editFormData.endTime,
                            duration: duration,
                            hours: duration / (1000 * 60 * 60),
                            comment: editFormData.comment,
                            projectId: editFormData.projectId,
                            projectCode: project ? project.code : entry.projectCode,
                            clientName: project ? project.clientName : entry.clientName,
                            projectName: project ? project.projectName : entry.projectName,
                            taskCode: project ? project.taskCode : entry.taskCode,
                            subtaskCode: project ? project.subtaskCode : entry.subtaskCode
                        };
                    }
                    return entry;
                }));

                cancelEditEntry();
            };

            const showNotification = (message, type = 'info') => {
                console.log("showNotification called with:", message, type);
                const notif = { message, type };
                console.log("Setting activeNotification to:", notif);
                setActiveNotification(notif);
                setTimeout(() => {
                    console.log("Clearing notification");
                    setActiveNotification(null);
                }, 5000);
            };

            const addDemoData = () => {
                const demoProjects = [
                    { id: 1, clientName: 'Orbital', projectName: 'O2-X Habitat Offsetting Plan', taskCode: '1. MEETINGS AND DELIVERY', subtaskCode: '1.1 PROJECT', code: '1. MEETINGS AND DELIVERY-1.1 PROJECT' },
                    { id: 2, clientName: 'Orbital', projectName: 'O2-X Habitat Offsetting Plan', taskCode: '1. MEETINGS AND DELIVERY', subtaskCode: '1.2 INTERNAL', code: '1. MEETINGS AND DELIVERY-1.2 INTERNAL' },
                    { id: 3, clientName: 'Orbital', projectName: 'O2-X Habitat Offsetting Plan', taskCode: '1. MEETINGS AND DELIVERY', subtaskCode: '1.3 REGULATORY', code: '1. MEETINGS AND DELIVERY-1.3 REGULATORY' }
                ];
                setProjectCodes(demoProjects);
                setShowSetup(false);
            };

            const downloadCSVTemplate = () => {
                const csvContent = [
                    'Client Name,Project/Admin Name,Task Code,Subtask Code',
                    'Orbital,O2-X Habitat Offsetting Plan,1. Meetings and Delivery,1.1 Project',
                    'Orbital,O2-X Habitat Offsetting Plan,1. Meetings and Delivery,1.2 Internal',
                    'Orbital,O2-X Habitat Offsetting Plan,1. Meetings and Delivery,1.3 Regulatory'
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'timesheet-template.csv';
                a.click();
                window.URL.revokeObjectURL(url);
            };

            // Update handler functions
            const handleDownloadUpdate = async () => {
                setIsDownloading(true);
                await ipcRenderer.invoke('download-update');
            };

            const handleInstallUpdate = async () => {
                await ipcRenderer.invoke('install-update');
            };

            const handleDismissUpdate = () => {
                setUpdateAvailable(false);
                setUpdateDownloaded(false);
            };

            const handleCSVImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n').filter(line => line.trim());
                        const dataLines = lines.slice(1);

                        const importedProjects = dataLines.map((line, index) => {
                            const values = line.split(',').map(v => v.trim());
                            if (values.length < 4) {
                                throw new Error("Line " + (index + 2) + ": Expected 4 columns, got " + values.length);
                            }

                            const [clientName, projectName, taskCode, subtaskCode] = values;
                            return {
                                id: Date.now() + Math.random() + index,
                                clientName,
                                projectName,
                                taskCode: taskCode.toUpperCase(),
                                subtaskCode: subtaskCode.toUpperCase(),
                                code: taskCode.toUpperCase() + '-' + subtaskCode.toUpperCase()
                            };
                        });

                        setProjectCodes(prev => [...prev, ...importedProjects]);
                        console.log("Calling showNotification after file input import");
                        showNotification("Project code(s) successfully uploaded", 'success');

                        event.target.value = '';
                    } catch (error) {
                        console.log("Import error:", error);
                        showNotification("Import failed: " + error.message, 'info');
                    }
                };
                reader.readAsText(file);
            };

            const browseCSVFile = async () => {
                try {
                    const result = await window.require('electron').ipcRenderer.invoke('browse-csv-file');
                    if (result.success && result.content) {
                        const text = result.content;
                        const lines = text.split('\n').filter(line => line.trim());
                        const dataLines = lines.slice(1);

                        const importedProjects = dataLines.map((line, index) => {
                            const values = line.split(',').map(v => v.trim());
                            if (values.length < 4) {
                                throw new Error("Line " + (index + 2) + ": Expected 4 columns, got " + values.length);
                            }

                            const [clientName, projectName, taskCode, subtaskCode] = values;
                            return {
                                id: Date.now() + Math.random() + index,
                                clientName,
                                projectName,
                                taskCode: taskCode.toUpperCase(),
                                subtaskCode: subtaskCode.toUpperCase(),
                                code: taskCode.toUpperCase() + '-' + subtaskCode.toUpperCase()
                            };
                        });

                        setProjectCodes(prev => [...prev, ...importedProjects]);
                        setLinkedCSVPath(result.path);
                        console.log("Calling showNotification after browse CSV import");
                        showNotification("Project code(s) successfully uploaded and linked", 'success');
                    } else if (result.canceled) {
                        // User canceled, do nothing
                    } else {
                        showNotification("Failed to browse CSV file: " + (result.error || "Unknown error"), 'info');
                    }
                } catch (error) {
                    console.log("Browse CSV error:", error);
                    showNotification("Import failed: " + error.message, 'info');
                }
            };

            const refreshFromCSV = async () => {
                if (!linkedCSVPath) {
                    showNotification("No linked CSV file. Please browse and select a CSV file first.", 'info');
                    return;
                }

                try {
                    const fs = window.require('fs');
                    const csvContent = fs.readFileSync(linkedCSVPath, 'utf8');
                    const lines = csvContent.split('\n').filter(line => line.trim());
                    const dataLines = lines.slice(1);

                    const importedProjects = dataLines.map((line, index) => {
                        const values = line.split(',').map(v => v.trim());
                        if (values.length < 4) {
                            throw new Error("Line " + (index + 2) + ": Expected 4 columns, got " + values.length);
                        }

                        const [clientName, projectName, taskCode, subtaskCode] = values;
                        return {
                            id: Date.now() + Math.random() + index,
                            clientName,
                            projectName,
                            taskCode: taskCode.toUpperCase(),
                            subtaskCode: subtaskCode.toUpperCase(),
                            code: taskCode.toUpperCase() + '-' + subtaskCode.toUpperCase()
                        };
                    });

                    setProjectCodes(importedProjects);
                    showNotification("Refreshed " + importedProjects.length + " project code(s) from CSV", 'success');
                } catch (error) {
                    console.log("Refresh CSV error:", error);
                    showNotification("Failed to refresh from CSV: " + error.message, 'info');
                    // Clear invalid path
                    setLinkedCSVPath(null);
                }
            };

            const deleteAllByClient = (clientName) => {
                const confirmed = window.confirm("Delete all projects for client \"" + clientName + "\"?\n\nThis cannot be undone.");
                if (confirmed) {
                    const remaining = projectCodes.filter(p => p.clientName !== clientName);
                    const deleted = projectCodes.length - remaining.length;
                    setProjectCodes(remaining);
                    setStorageError("Deleted " + deleted + " project(s) for " + clientName);
                }
            };

            const deleteAllByProject = (clientName, projectName) => {
                const confirmed = window.confirm("Delete all codes for \"" + projectName + "\" under client \"" + clientName + "\"?\n\nThis cannot be undone.");
                if (confirmed) {
                    const remaining = projectCodes.filter(p => !(p.clientName === clientName && p.projectName === projectName));
                    const deleted = projectCodes.length - remaining.length;
                    setProjectCodes(remaining);
                    setStorageError("Deleted " + deleted + " code(s) for " + projectName);
                }
            };

            const toggleClient = (clientName) => {
                setExpandedClients(prev => ({
                    ...prev,
                    [clientName]: !prev[clientName]
                }));
            };

            const toggleProject = (clientName, projectName) => {
                const key = clientName + "::" + projectName;
                setExpandedProjects(prev => ({
                    ...prev,
                    [key]: !prev[key]
                }));
            };

            const toggleTask = (clientName, projectName, taskCode) => {
                const key = clientName + "::" + projectName + "::" + taskCode;
                setExpandedTasks(prev => ({
                    ...prev,
                    [key]: !prev[key]
                }));
            };

            const organizeProjectsByHierarchy = () => {
                const searchLower = projectSearchTerm.toLowerCase();
                const filtered = projectCodes.filter(p =>
                    !projectSearchTerm ||
                    p.clientName.toLowerCase().includes(searchLower) ||
                    p.projectName.toLowerCase().includes(searchLower) ||
                    p.code.toLowerCase().includes(searchLower)
                );

                const hierarchy = {};
                filtered.forEach(project => {
                    if (!hierarchy[project.clientName]) {
                        hierarchy[project.clientName] = {};
                    }
                    if (!hierarchy[project.clientName][project.projectName]) {
                        hierarchy[project.clientName][project.projectName] = {};
                    }
                    if (!hierarchy[project.clientName][project.projectName][project.taskCode]) {
                        hierarchy[project.clientName][project.projectName][project.taskCode] = [];
                    }
                    hierarchy[project.clientName][project.projectName][project.taskCode].push(project);
                });

                return hierarchy;
            };

            const exportToCSV = () => {
                if (timeEntries.length === 0) {
                    setStorageError('No entries to export');
                    return;
                }

                const filteredEntries = timeEntries.filter(entry => {
                    let matches = true;
                    if (filterStartDate && entry.date < filterStartDate) matches = false;
                    if (filterEndDate && entry.date > filterEndDate) matches = false;
                    if (filterClient && entry.clientName !== filterClient) matches = false;
                    if (filterProject && entry.projectName !== filterProject) matches = false;
                    return matches;
                });

                if (filteredEntries.length === 0) {
                    setStorageError('No entries match the filters');
                    return;
                }

                const dateRange = filterStartDate && filterEndDate
                    ? filterStartDate + " to " + filterEndDate
                    : 'All Dates';

                // Sort entries by date
                const sortedEntries = [...filteredEntries].sort((a, b) => a.date.localeCompare(b.date));

                // Consolidate duplicate entries based on user preference
                let entriesToExport = sortedEntries;
                if (mergeEntries) {
                    const consolidatedEntries = [];
                    const entryMap = {};

                    sortedEntries.forEach(entry => {
                        // Create a unique key based on date and relevant fields (excluding comment)
                        const key = [
                            entry.date,
                            entry.clientName || '',
                            entry.projectName,
                            entry.taskCode,
                            entry.subtaskCode
                        ].join('|');

                        if (entryMap[key]) {
                            // Add hours to existing entry
                            entryMap[key].hours += entry.hours;
                            // Combine comments
                            if (entry.comment) {
                                if (entryMap[key].comment && entryMap[key].comment !== entry.comment) {
                                    entryMap[key].comment += '; ' + entry.comment;
                                } else if (!entryMap[key].comment) {
                                    entryMap[key].comment = entry.comment;
                                }
                            }
                        } else {
                            // Create new consolidated entry
                            entryMap[key] = { ...entry };
                            consolidatedEntries.push(entryMap[key]);
                        }
                    });
                    entriesToExport = consolidatedEntries;
                }

                const projectSummary = {};
                entriesToExport.forEach(entry => {
                    const key = entry.projectCode;
                    if (!projectSummary[key]) {
                        projectSummary[key] = {
                            code: entry.projectCode,
                            client: entry.clientName,
                            project: entry.projectName,
                            totalHours: 0
                        };
                    }
                    projectSummary[key].totalHours += entry.hours;
                });

                const summaryHeaders = ['Project Code', 'Client', 'Project', 'Total Hours'];
                const summaryRows = Object.values(projectSummary).map(proj => [
                    proj.code,
                    proj.client,
                    proj.project,
                    proj.totalHours.toFixed(2)
                ]);

                const detailHeaders = ['Date', 'Project Code', 'Client', 'Project', 'Task', 'Subtask', 'Start', 'End', 'Hours', 'Comment'];
                const detailRows = entriesToExport.map(entry => [
                    entry.date,
                    entry.projectCode,
                    entry.clientName,
                    entry.projectName,
                    entry.taskCode,
                    entry.subtaskCode,
                    entry.startTime || (mergeEntries ? 'Multiple' : ''),
                    entry.endTime || (mergeEntries ? 'Multiple' : ''),
                    entry.hours.toFixed(2),
                    entry.comment || ''
                ]);

                const csvContent = [
                    "Timesheet Export - " + dateRange,
                    filterClient ? "Client: " + filterClient : '',
                    filterProject ? "Project: " + filterProject : '',
                    '',
                    'PROJECT SUMMARY',
                    summaryHeaders.join(','),
                    ...summaryRows.map(row => row.join(',')),
                    '',
                    "Total Hours: " + filteredEntries.reduce((sum, e) => sum + e.hours, 0).toFixed(2),
                    '',
                    'DETAILED ENTRIES',
                    detailHeaders.join(','),
                    ...detailRows.map(row => row.join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "timesheet-" + (filterStartDate || 'all') + "-" + (filterEndDate || 'dates') + ".csv";
                a.click();
                window.URL.revokeObjectURL(url);
            };

            // EXPENSE MANAGEMENT FUNCTIONS
            const addExpense = async (expenseData) => {
                const newExpense = {
                    id: `exp-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    ...expenseData,
                    priceBeforeTax: parseFloat(expenseData.priceBeforeTax),
                    taxAmount: parseFloat(expenseData.taxAmount),
                    totalExpense: parseFloat(expenseData.totalExpense),
                    paid: false,
                    createdAt: new Date().toISOString(),
                    clientName: expenseData.projectCode.split('::')[0] || '',
                    projectName: expenseData.projectCode.split('::')[1] || ''
                };

                const updatedExpenses = [...expenses, newExpense];
                setExpenses(updatedExpenses);

                await saveDataToFile({
                    projectCodes,
                    timeEntries,
                    recentProjects,
                    expenses: updatedExpenses,
                    linkedCSVPath,
                    settings: {
                        timeRounding,
                        autoPauseEnabled,
                        autoPauseMinutes,
                        dailyGoalEnabled,
                        dailyGoalHours,
                        fullDayNotificationEnabled,
                        hourlyBreakNotificationEnabled,
                        floatingTimerEnabled,
                        lastFullDayNotification,
                        lastHourlyNotification,
                        dailyProgressEnabled,
                        timeSummaryEnabled,
                        timeSummaryExpanded,
                        emailProvider,
                        idleDetectionEnabled,
                        idleTimeoutMinutes,
                        activityReminderEnabled,
                        reminderIntervalMinutes
                    },
                    activeSession: null
                });
            };

            const toggleExpensePaidStatus = async (expenseId) => {
                const updatedExpenses = expenses.map(exp =>
                    exp.id === expenseId ? { ...exp, paid: !exp.paid } : exp
                );
                setExpenses(updatedExpenses);

                await saveDataToFile({
                    projectCodes,
                    timeEntries,
                    recentProjects,
                    expenses: updatedExpenses,
                    linkedCSVPath,
                    settings: {
                        timeRounding,
                        autoPauseEnabled,
                        autoPauseMinutes,
                        dailyGoalEnabled,
                        dailyGoalHours,
                        fullDayNotificationEnabled,
                        hourlyBreakNotificationEnabled,
                        floatingTimerEnabled,
                        lastFullDayNotification,
                        lastHourlyNotification,
                        dailyProgressEnabled,
                        timeSummaryEnabled,
                        timeSummaryExpanded,
                        emailProvider,
                        idleDetectionEnabled,
                        idleTimeoutMinutes,
                        activityReminderEnabled,
                        reminderIntervalMinutes
                    },
                    activeSession: null
                });
            };

            const deleteExpense = async (expenseId) => {
                if (!confirm('Are you sure you want to delete this expense?')) return;

                const updatedExpenses = expenses.filter(exp => exp.id !== expenseId);
                setExpenses(updatedExpenses);

                await saveDataToFile({
                    projectCodes,
                    timeEntries,
                    recentProjects,
                    expenses: updatedExpenses,
                    linkedCSVPath,
                    settings: {
                        timeRounding,
                        autoPauseEnabled,
                        autoPauseMinutes,
                        dailyGoalEnabled,
                        dailyGoalHours,
                        fullDayNotificationEnabled,
                        hourlyBreakNotificationEnabled,
                        floatingTimerEnabled,
                        lastFullDayNotification,
                        lastHourlyNotification,
                        dailyProgressEnabled,
                        timeSummaryEnabled,
                        timeSummaryExpanded,
                        emailProvider,
                        idleDetectionEnabled,
                        idleTimeoutMinutes,
                        activityReminderEnabled,
                        reminderIntervalMinutes
                    },
                    activeSession: null
                });
            };

            // INVOICE GENERATION FUNCTIONS
            const startInvoiceGeneration = () => {
                // Check if "All Clients" is selected
                if (!filterClient || filterClient === '') {
                    // Get unique clients from filtered time entries
                    const filteredEntries = timeEntries.filter(entry => {
                        let matches = true;
                        if (filterStartDate && entry.date < filterStartDate) matches = false;
                        if (filterEndDate && entry.date > filterEndDate) matches = false;
                        if (filterProject && entry.projectName !== filterProject) matches = false;
                        return matches;
                    });

                    const uniqueClients = [...new Set(filteredEntries.map(e => e.clientName))].filter(Boolean).sort();

                    if (uniqueClients.length === 0) {
                        setStorageError('No entries found for invoice generation');
                        return;
                    }

                    if (uniqueClients.length > 1) {
                        // Show client selection modal first
                        setSelectedInvoiceClients(uniqueClients); // Pre-select all
                        setShowInvoiceClientSelection(true);
                    } else {
                        // Only one client - show invoice metadata modal
                        setSelectedInvoiceClients([uniqueClients[0]]);
                        setShowInvoiceClientSelection(true);
                    }
                } else {
                    // Single client selected - show invoice metadata modal
                    setSelectedInvoiceClients([filterClient]);
                    setShowInvoiceClientSelection(true);
                }
            };

            const generateInvoiceWorkbook = async (clientsToInvoice, hourlyRate, clientRatesMap = {}, invoiceDetails = {}) => {
                try {
                    const ExcelJS = window.require('exceljs');
                    const workbook = new ExcelJS.Workbook();
                    const defaultRate = parseFloat(hourlyRate) || 0;

                    // Filter entries
                    const filteredEntries = timeEntries.filter(entry => {
                        let matches = true;
                        if (filterStartDate && entry.date < filterStartDate) matches = false;
                        if (filterEndDate && entry.date > filterEndDate) matches = false;
                        if (filterProject && entry.projectName !== filterProject) matches = false;
                        if (!clientsToInvoice.includes(entry.clientName)) matches = false;
                        return matches;
                    });

                    if (filteredEntries.length === 0) {
                        setStorageError('No entries found for selected clients');
                        return;
                    }

                    // Filter expenses
                    const filteredExpenses = expenses.filter(expense => {
                        let matches = true;
                        if (filterStartDate && expense.purchaseDate < filterStartDate) matches = false;
                        if (filterEndDate && expense.purchaseDate > filterEndDate) matches = false;
                        if (filterProject && expense.projectName !== filterProject) matches = false;
                        if (!clientsToInvoice.includes(expense.clientName)) matches = false;
                        return matches;
                    });

                    // Generate full timesheet format using the same function as Export Timesheet
                    const fullTimesheetWorkbook = await generateExcelWorkbook(filteredEntries);

                    // Copy the comprehensive timesheet sheet to our invoice workbook
                    const sourceTimesheetSheet = fullTimesheetWorkbook.getWorksheet('ThymeSheet (ALL)');
                    const allSheet = workbook.addWorksheet('ThymeSheet (ALL)');

                    // Copy all rows, formulas, and formatting
                    sourceTimesheetSheet.eachRow((row, rowNumber) => {
                        const newRow = allSheet.getRow(rowNumber);
                        newRow.height = row.height;
                        row.eachCell({ includeEmpty: true }, (cell, colNumber) => {
                            const newCell = newRow.getCell(colNumber);
                            if (cell.formula) {
                                newCell.value = { formula: cell.formula };
                            } else {
                                newCell.value = cell.value;
                            }
                            if (cell.style) {
                                newCell.style = cell.style;
                            }
                        });
                        newRow.commit();
                    });

                    // Copy column widths and properties
                    sourceTimesheetSheet.columns.forEach((col, idx) => {
                        const targetCol = allSheet.getColumn(idx + 1);
                        if (col.width) targetCol.width = col.width;
                    });

                    const dateRange = (filterStartDate || 'All') + ' to ' + (filterEndDate || 'All');

                    // Now create per-client sheets: Timesheet then Invoice
                    for (const client of clientsToInvoice.sort()) {
                        const clientEntries = filteredEntries.filter(e => e.clientName === client);
                        const clientExpenses = filteredExpenses.filter(e => e.clientName === client);

                        if (clientEntries.length === 0) continue;

                        // CLIENT TIMESHEET
                        const timesheetName = client.substring(0, 25) + ' - Time';
                        const timesheet = workbook.addWorksheet(timesheetName);

                        timesheet.addRow([client.toUpperCase() + ' - TIMESHEET']);
                        timesheet.getCell('A1').font = { bold: true, size: 14 };
                        timesheet.addRow(['Period: ' + dateRange]);
                        timesheet.addRow([]);

                        const timeHeaderRow = timesheet.addRow(['Date', 'Project', 'Task', 'Subtask', 'Hours', 'Comment']);
                        timeHeaderRow.font = { bold: true };
                        timeHeaderRow.eachCell((cell) => {
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4A7C59' } };
                            cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                            cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                        });

                        clientEntries.sort((a, b) => a.date.localeCompare(b.date)).forEach(entry => {
                            const row = timesheet.addRow([
                                entry.date,
                                entry.projectName,
                                entry.taskCode,
                                entry.subtaskCode,
                                entry.hours.toFixed(2),
                                entry.comment || ''
                            ]);
                            row.eachCell((cell) => {
                                cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                            });
                        });

                        const totalRow = timesheet.addRow(['', '', '', 'TOTAL HOURS:', clientEntries.reduce((sum, e) => sum + e.hours, 0).toFixed(2), '']);
                        totalRow.font = { bold: true };
                        totalRow.eachCell((cell) => {
                            cell.border = { top: { style: 'medium' }, left: { style: 'thin' }, bottom: { style: 'medium' }, right: { style: 'thin' } };
                        });

                        timesheet.columns.forEach((column) => {
                            let maxLength = 0;
                            column.eachCell({ includeEmpty: false }, (cell) => {
                                const columnLength = cell.value ? cell.value.toString().length : 10;
                                if (columnLength > maxLength) maxLength = columnLength;
                            });
                            column.width = Math.min(Math.max(maxLength + 2, 12), 50);
                        });

                        // CLIENT INVOICE - Professional Format
                        const invoiceName = client.substring(0, 25) + ' - Inv';
                        const invoice = workbook.addWorksheet(invoiceName);

                        // Apply invoice header color from settings
                        const colorMap = {
                            'green': 'FF4A7C59',
                            'blue': 'FF2563EB',
                            'red': 'FFDC2626',
                            'plain': 'FFFFFFFF'
                        };
                        const headerColor = colorMap[invoiceHeaderColor] || 'FF4A7C59';
                        const headerFontColor = invoiceHeaderColor === 'plain' ? 'FF000000' : 'FFFFFFFF';

                        // SECTION 1: Company Name and Contact Info (Top-Left)
                        let logoRowsUsed = 0;
                        if (businessLogo) {
                            // If logo exists, add it with proper aspect ratio preservation
                            try {
                                const logoId = workbook.addImage({
                                    base64: businessLogo.split(',')[1],
                                    extension: businessLogo.includes('png') ? 'png' : 'jpeg',
                                });
                                // Add logo with better sizing - smaller to reduce congestion
                                invoice.addImage(logoId, {
                                    tl: { col: 0, row: 0, colOff: '0.1in', rowOff: '0.1in' },
                                    ext: { width: 180, height: 60 },
                                    editAs: 'absolute'
                                });
                                logoRowsUsed = 4;
                                // Start contact info below logo with more space
                                const contactStartRow = 5;
                                const addressCell = invoice.getCell(`A${contactStartRow}`);
                                addressCell.value = (invoiceDetails.streetAddress && invoiceDetails.streetAddress.trim()) || '[Street Address]';
                                if (!invoiceDetails.streetAddress || !invoiceDetails.streetAddress.trim()) addressCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF00' } };

                                const cityCell = invoice.getCell(`A${contactStartRow + 1}`);
                                cityCell.value = (invoiceDetails.cityStateZip && invoiceDetails.cityStateZip.trim()) || '[City, ST ZIP]';
                                if (!invoiceDetails.cityStateZip || !invoiceDetails.cityStateZip.trim()) cityCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF00' } };

                                const phoneCell = invoice.getCell(`A${contactStartRow + 2}`);
                                phoneCell.value = 'Phone: ' + ((invoiceDetails.phone && invoiceDetails.phone.trim()) || '[000-000-0000]');
                                if (!invoiceDetails.phone || !invoiceDetails.phone.trim()) phoneCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF00' } };
                            } catch (e) {
                                console.error('Logo error:', e);
                                // If logo fails, fallback to text with yellow highlight
                                const companyCell = invoice.getCell('A1');
                                companyCell.value = (invoiceDetails.companyName && invoiceDetails.companyName.trim()) || '[Company Name]';
                                companyCell.font = { bold: true, size: 20 };
                                if (!invoiceDetails.companyName || !invoiceDetails.companyName.trim()) companyCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF00' } };

                                const addressCell = invoice.getCell('A2');
                                addressCell.value = (invoiceDetails.streetAddress && invoiceDetails.streetAddress.trim()) || '[Street Address]';
                                if (!invoiceDetails.streetAddress || !invoiceDetails.streetAddress.trim()) addressCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF00' } };

                                const cityCell = invoice.getCell('A3');
                                cityCell.value = (invoiceDetails.cityStateZip && invoiceDetails.cityStateZip.trim()) || '[City, ST ZIP]';
                                if (!invoiceDetails.cityStateZip || !invoiceDetails.cityStateZip.trim()) cityCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF00' } };

                                const phoneCell = invoice.getCell('A4');
                                phoneCell.value = 'Phone: ' + ((invoiceDetails.phone && invoiceDetails.phone.trim()) || '[000-000-0000]');
                                if (!invoiceDetails.phone || !invoiceDetails.phone.trim()) phoneCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF00' } };

                                logoRowsUsed = 0;
                            }
                        } else {
                            // No logo, use text with yellow highlight for placeholders
                            const companyCell = invoice.getCell('A1');
                            companyCell.value = (invoiceDetails.companyName && invoiceDetails.companyName.trim()) || '[Company Name]';
                            companyCell.font = { bold: true, size: 20 };
                            if (!invoiceDetails.companyName || !invoiceDetails.companyName.trim()) companyCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF00' } };

                            const addressCell = invoice.getCell('A2');
                            addressCell.value = (invoiceDetails.streetAddress && invoiceDetails.streetAddress.trim()) || '[Street Address]';
                            if (!invoiceDetails.streetAddress || !invoiceDetails.streetAddress.trim()) addressCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF00' } };

                            const cityCell = invoice.getCell('A3');
                            cityCell.value = (invoiceDetails.cityStateZip && invoiceDetails.cityStateZip.trim()) || '[City, ST ZIP]';
                            if (!invoiceDetails.cityStateZip || !invoiceDetails.cityStateZip.trim()) cityCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF00' } };

                            const phoneCell = invoice.getCell('A4');
                            phoneCell.value = 'Phone: ' + ((invoiceDetails.phone && invoiceDetails.phone.trim()) || '[000-000-0000]');
                            if (!invoiceDetails.phone || !invoiceDetails.phone.trim()) phoneCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF00' } };

                            logoRowsUsed = 0;
                        }

                        // SECTION 2: INVOICE Label and Metadata (Top-Right)
                        invoice.getCell('F1').value = 'INVOICE';
                        invoice.getCell('F1').font = { bold: true, size: 20 };
                        invoice.getCell('F1').alignment = { horizontal: 'right' };

                        // Metadata table
                        invoice.getCell('E2').value = 'DATE';
                        invoice.getCell('E2').alignment = { horizontal: 'right' };
                        invoice.getCell('F2').value = new Date().toLocaleDateString();
                        invoice.getCell('F2').border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };

                        const invoiceNumber = (invoiceDetails.invoiceNumber && invoiceDetails.invoiceNumber.trim()) || Date.now().toString().slice(-6);
                        invoice.getCell('E3').value = 'INVOICE #';
                        invoice.getCell('E3').alignment = { horizontal: 'right' };
                        invoice.getCell('F3').value = invoiceNumber;
                        invoice.getCell('F3').border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                        if (!invoiceDetails.invoiceNumber || !invoiceDetails.invoiceNumber.trim()) invoice.getCell('F3').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF00' } };

                        invoice.getCell('E4').value = 'CUSTOMER ID';
                        invoice.getCell('E4').alignment = { horizontal: 'right' };
                        invoice.getCell('F4').value = client.substring(0, 10);
                        invoice.getCell('F4').border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };

                        invoice.getCell('E5').value = 'DUE DATE';
                        invoice.getCell('E5').alignment = { horizontal: 'right' };
                        const dueDate = (invoiceDetails.dueDate && invoiceDetails.dueDate.trim()) ? new Date(invoiceDetails.dueDate) : (() => { const d = new Date(); d.setDate(d.getDate() + 30); return d; })();
                        invoice.getCell('F5').value = dueDate.toLocaleDateString();
                        invoice.getCell('F5').border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                        if (!invoiceDetails.dueDate || !invoiceDetails.dueDate.trim()) invoice.getCell('F5').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF00' } };

                        // SECTION 3: BILL TO Banner and Info
                        const billToRow = businessLogo ? 10 : 8;
                        invoice.mergeCells(`A${billToRow}:D${billToRow}`);
                        const billToHeaderCell = invoice.getCell(`A${billToRow}`);
                        billToHeaderCell.value = 'BILL TO';
                        billToHeaderCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFFFF' } };
                        billToHeaderCell.font = { bold: true, color: { argb: 'FF000000' } };
                        billToHeaderCell.alignment = { vertical: 'middle', horizontal: 'left' };

                        invoice.getCell(`A${billToRow + 1}`).value = client;

                        const companyNameCell = invoice.getCell(`A${billToRow + 2}`);
                        companyNameCell.value = (invoiceDetails.clientCompanyName && invoiceDetails.clientCompanyName.trim()) || '[Company Name]';
                        if (!invoiceDetails.clientCompanyName || !invoiceDetails.clientCompanyName.trim()) companyNameCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF00' } };

                        const streetAddressCell = invoice.getCell(`A${billToRow + 3}`);
                        streetAddressCell.value = (invoiceDetails.clientStreetAddress && invoiceDetails.clientStreetAddress.trim()) || '[Street Address]';
                        if (!invoiceDetails.clientStreetAddress || !invoiceDetails.clientStreetAddress.trim()) streetAddressCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF00' } };

                        const cityCell = invoice.getCell(`A${billToRow + 4}`);
                        cityCell.value = (invoiceDetails.clientCityStateZip && invoiceDetails.clientCityStateZip.trim()) || '[City, ST ZIP]';
                        if (!invoiceDetails.clientCityStateZip || !invoiceDetails.clientCityStateZip.trim()) cityCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF00' } };

                        const phoneCell = invoice.getCell(`A${billToRow + 5}`);
                        phoneCell.value = (invoiceDetails.clientPhone && invoiceDetails.clientPhone.trim()) || '[Phone]';
                        if (!invoiceDetails.clientPhone || !invoiceDetails.clientPhone.trim()) phoneCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF00' } };

                        // SECTION 4: Item Table Header (4-column format: DESCRIPTION, HOURS, RATE, AMOUNT)
                        const tableHeaderRow = billToRow + 7;  // Added 1 row spacing
                        invoice.mergeCells(`A${tableHeaderRow}:C${tableHeaderRow}`); // Description column spans A-C
                        const descHeaderCell = invoice.getCell(`A${tableHeaderRow}`);
                        descHeaderCell.value = 'DESCRIPTION';
                        descHeaderCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFFFF' } };
                        descHeaderCell.font = { bold: true, color: { argb: 'FF000000' } };
                        descHeaderCell.alignment = { vertical: 'middle', horizontal: 'center' };
                        descHeaderCell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };

                        const hoursHeaderCell = invoice.getCell(`D${tableHeaderRow}`);
                        hoursHeaderCell.value = 'HOURS';
                        hoursHeaderCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFFFF' } };
                        hoursHeaderCell.font = { bold: true, color: { argb: 'FF000000' } };
                        hoursHeaderCell.alignment = { vertical: 'middle', horizontal: 'center' };
                        hoursHeaderCell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };

                        const rateHeaderCell = invoice.getCell(`E${tableHeaderRow}`);
                        rateHeaderCell.value = 'RATE';
                        rateHeaderCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFFFF' } };
                        rateHeaderCell.font = { bold: true, color: { argb: 'FF000000' } };
                        rateHeaderCell.alignment = { vertical: 'middle', horizontal: 'center' };
                        rateHeaderCell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };

                        const amountHeaderCell = invoice.getCell(`F${tableHeaderRow}`);
                        amountHeaderCell.value = 'AMOUNT';
                        amountHeaderCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFFFF' } };
                        amountHeaderCell.font = { bold: true, color: { argb: 'FF000000' } };
                        amountHeaderCell.alignment = { vertical: 'middle', horizontal: 'center' };
                        amountHeaderCell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };

                        // Get client rate (use client-specific rate or default)
                        const clientRate = clientRatesMap[client] || defaultRate;

                        // Group by Project > Task > Subtask
                        const projectBreakdown = {};
                        clientEntries.forEach(entry => {
                            const projectKey = entry.projectName;
                            if (!projectBreakdown[projectKey]) {
                                projectBreakdown[projectKey] = {};
                            }
                            const taskKey = `${entry.taskCode}`;
                            if (!projectBreakdown[projectKey][taskKey]) {
                                projectBreakdown[projectKey][taskKey] = {};
                            }
                            const subtaskKey = entry.subtaskCode;
                            if (!projectBreakdown[projectKey][taskKey][subtaskKey]) {
                                projectBreakdown[projectKey][taskKey][subtaskKey] = { hours: 0, entries: [] };
                            }
                            projectBreakdown[projectKey][taskKey][subtaskKey].hours += entry.hours;
                            projectBreakdown[projectKey][taskKey][subtaskKey].entries.push(entry);
                        });

                        // Add line items in 4-column format with alternating row colors
                        let currentRow = tableHeaderRow + 1;
                        let rowIndex = 0;
                        const lineItemRows = [];

                        Object.keys(projectBreakdown).sort().forEach(project => {
                            const tasks = projectBreakdown[project];

                            Object.keys(tasks).sort().forEach(task => {
                                const subtasks = tasks[task];
                                Object.keys(subtasks).sort().forEach(subtask => {
                                    const data = subtasks[subtask];

                                    // Description column (merged A-C)
                                    invoice.mergeCells(`A${currentRow}:C${currentRow}`);
                                    const descCell = invoice.getCell(`A${currentRow}`);
                                    descCell.value = `${project} - ${task} - ${subtask}`;
                                    descCell.alignment = { vertical: 'middle', horizontal: 'left' };
                                    descCell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };

                                    // Hours column - use actual calculated hours value
                                    const hoursCell = invoice.getCell(`D${currentRow}`);
                                    hoursCell.value = data.hours;
                                    hoursCell.numFmt = '0.00';
                                    hoursCell.alignment = { vertical: 'middle', horizontal: 'center' };
                                    hoursCell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };

                                    // Rate column
                                    const rateCell = invoice.getCell(`E${currentRow}`);
                                    rateCell.value = clientRate > 0 ? clientRate : 0;
                                    rateCell.numFmt = '$#,##0.00';
                                    rateCell.alignment = { vertical: 'middle', horizontal: 'center' };
                                    rateCell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };

                                    // Amount column with formula (Hours Ã— Rate)
                                    const amountCell = invoice.getCell(`F${currentRow}`);
                                    amountCell.value = { formula: `D${currentRow}*E${currentRow}` };
                                    amountCell.numFmt = '$#,##0.00';
                                    amountCell.alignment = { vertical: 'middle', horizontal: 'right' };
                                    amountCell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };

                                    // Alternating row color
                                    if (rowIndex % 2 === 1) {
                                        descCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF2F2F2' } };
                                        hoursCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF2F2F2' } };
                                        rateCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF2F2F2' } };
                                        amountCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF2F2F2' } };
                                    }

                                    lineItemRows.push(currentRow);
                                    currentRow++;
                                    rowIndex++;
                                });
                            });
                        });

                        // Add empty rows to reach 15 total line items
                        while (rowIndex < 15) {
                            invoice.mergeCells(`A${currentRow}:C${currentRow}`);
                            const descCell = invoice.getCell(`A${currentRow}`);
                            descCell.value = '';
                            descCell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };

                            const hoursCell = invoice.getCell(`D${currentRow}`);
                            hoursCell.value = '';
                            hoursCell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };

                            const rateCell = invoice.getCell(`E${currentRow}`);
                            rateCell.value = '';
                            rateCell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };

                            const amountCell = invoice.getCell(`F${currentRow}`);
                            amountCell.value = '';
                            amountCell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };

                            // Alternating row color
                            if (rowIndex % 2 === 1) {
                                descCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF2F2F2' } };
                                hoursCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF2F2F2' } };
                                rateCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF2F2F2' } };
                                amountCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF2F2F2' } };
                            }

                            currentRow++;
                            rowIndex++;
                        }

                        // SECTION 5: Price Summary Block (bottom-right aligned with F column)
                        const totalsStartRow = currentRow + 2;
                        const firstLineRow = tableHeaderRow + 1;
                        const lastLineRow = currentRow - 1;

                        invoice.getCell(`E${totalsStartRow}`).value = 'Subtotal';
                        invoice.getCell(`E${totalsStartRow}`).alignment = { horizontal: 'left' };
                        invoice.getCell(`F${totalsStartRow}`).value = { formula: `SUM(F${firstLineRow}:F${lastLineRow})` };
                        invoice.getCell(`F${totalsStartRow}`).numFmt = '$#,##0.00';
                        invoice.getCell(`F${totalsStartRow}`).alignment = { horizontal: 'right' };

                        invoice.getCell(`E${totalsStartRow + 1}`).value = 'Tax rate';
                        invoice.getCell(`E${totalsStartRow + 1}`).alignment = { horizontal: 'left' };
                        const taxRateValue = invoiceDetails.taxRate ? parseFloat(invoiceDetails.taxRate) / 100 : 0;
                        invoice.getCell(`F${totalsStartRow + 1}`).value = taxRateValue;
                        invoice.getCell(`F${totalsStartRow + 1}`).numFmt = '0.000%';
                        invoice.getCell(`F${totalsStartRow + 1}`).alignment = { horizontal: 'right' };

                        invoice.getCell(`E${totalsStartRow + 2}`).value = 'Tax due';
                        invoice.getCell(`E${totalsStartRow + 2}`).alignment = { horizontal: 'left' };
                        invoice.getCell(`F${totalsStartRow + 2}`).value = { formula: `F${totalsStartRow}*F${totalsStartRow + 1}` };
                        invoice.getCell(`F${totalsStartRow + 2}`).numFmt = '$#,##0.00';
                        invoice.getCell(`F${totalsStartRow + 2}`).alignment = { horizontal: 'right' };

                        invoice.getCell(`E${totalsStartRow + 3}`).value = 'Other';
                        invoice.getCell(`E${totalsStartRow + 3}`).alignment = { horizontal: 'left' };
                        invoice.getCell(`F${totalsStartRow + 3}`).value = 'â€”';
                        invoice.getCell(`F${totalsStartRow + 3}`).alignment = { horizontal: 'right' };

                        // TOTAL row with border (formula: Subtotal + Tax due + Other)
                        invoice.getCell(`E${totalsStartRow + 4}`).value = 'TOTAL';
                        invoice.getCell(`E${totalsStartRow + 4}`).alignment = { horizontal: 'right' };
                        invoice.getCell(`E${totalsStartRow + 4}`).font = { bold: true };

                        invoice.getCell(`F${totalsStartRow + 4}`).value = { formula: `F${totalsStartRow}+F${totalsStartRow + 2}` };
                        invoice.getCell(`F${totalsStartRow + 4}`).numFmt = '$#,##0.00';
                        invoice.getCell(`F${totalsStartRow + 4}`).alignment = { horizontal: 'right' };
                        invoice.getCell(`F${totalsStartRow + 4}`).font = { bold: true };
                        invoice.getCell(`F${totalsStartRow + 4}`).border = { top: { style: 'medium' }, left: { style: 'medium' }, bottom: { style: 'medium' }, right: { style: 'medium' } };

                        // SECTION 6: Payment instructions below totals
                        invoice.getCell(`E${totalsStartRow + 6}`).value = 'Make all checks payable to';
                        invoice.getCell(`E${totalsStartRow + 6}`).alignment = { horizontal: 'center' };
                        invoice.mergeCells(`E${totalsStartRow + 6}:F${totalsStartRow + 6}`);

                        const payeeCell = invoice.getCell(`E${totalsStartRow + 7}`);
                        payeeCell.value = (invoiceDetails.companyName && invoiceDetails.companyName.trim()) || '[Company Name]';
                        payeeCell.alignment = { horizontal: 'center' };
                        payeeCell.font = { bold: true };
                        if (!invoiceDetails.companyName || !invoiceDetails.companyName.trim()) payeeCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF00' } };
                        invoice.mergeCells(`E${totalsStartRow + 7}:F${totalsStartRow + 7}`);

                        // SECTION 7: OTHER COMMENTS Block (lower-left)
                        const commentsRow = totalsStartRow;
                        invoice.mergeCells(`A${commentsRow}:C${commentsRow}`);
                        const commentsHeaderCell = invoice.getCell(`A${commentsRow}`);
                        commentsHeaderCell.value = 'OTHER COMMENTS';
                        commentsHeaderCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFFFF' } };
                        commentsHeaderCell.font = { bold: true, color: { argb: 'FF000000' } };
                        commentsHeaderCell.alignment = { vertical: 'middle', horizontal: 'left' };

                        invoice.mergeCells(`A${commentsRow + 1}:C${commentsRow + 4}`);
                        const commentsCell = invoice.getCell(`A${commentsRow + 1}`);
                        commentsCell.value = (invoiceDetails.memo && invoiceDetails.memo.trim()) || '1. Total payment due in 30 days\n2. Please include the invoice number on your check';
                        commentsCell.alignment = { vertical: 'top', horizontal: 'left', wrapText: true };
                        commentsCell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                        if (!invoiceDetails.memo || !invoiceDetails.memo.trim()) commentsCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF00' } };

                        // SECTION 8: Closing message (bottom-center)
                        const footerRow = totalsStartRow + 9;
                        invoice.mergeCells(`A${footerRow}:F${footerRow}`);
                        invoice.getCell(`A${footerRow}`).value = 'Thank You For Your Business!';
                        invoice.getCell(`A${footerRow}`).alignment = { horizontal: 'center' };
                        invoice.getCell(`A${footerRow}`).font = { bold: true, italic: true };

                        // Set column widths (A-D for description 70%, E for taxed 10%, F for amount 20%)
                        invoice.getColumn('A').width = 20;
                        invoice.getColumn('B').width = 20;
                        invoice.getColumn('C').width = 20;
                        invoice.getColumn('D').width = 20;
                        invoice.getColumn('E').width = 12;
                        invoice.getColumn('F').width = 15;
                    }

                    // EXPENSES SHEET (last sheet)
                    if (filteredExpenses.length > 0) {
                        const expensesWorksheet = workbook.addWorksheet('Expenses');
                        expensesWorksheet.addRow(['ALL EXPENSES']);
                        expensesWorksheet.getCell('A1').font = { bold: true, size: 14 };
                        expensesWorksheet.addRow([]);

                        const expenseHeaderRow = expensesWorksheet.addRow([
                            'Date', 'Client Name', 'Project Name', 'Category', 'Vendor', 'Description',
                            'Price Before Tax', 'Tax Amount', 'Total Expense', 'Paid Status'
                        ]);
                        expenseHeaderRow.font = { bold: true };
                        expenseHeaderRow.eachCell((cell) => {
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4A7C59' } };
                            cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                            cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                        });

                        filteredExpenses.sort((a, b) => a.purchaseDate.localeCompare(b.purchaseDate)).forEach(expense => {
                            const dateParts = expense.purchaseDate.split('-');
                            const year = parseInt(dateParts[0]);
                            const month = parseInt(dateParts[1]) - 1;
                            const day = parseInt(dateParts[2]);
                            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                               'July', 'August', 'September', 'October', 'November', 'December'];
                            const formattedDate = monthNames[month] + ' ' + day + ', ' + year;

                            const row = expensesWorksheet.addRow([
                                formattedDate, expense.clientName || '', expense.projectName || '',
                                expense.category, expense.vendor, expense.description,
                                parseFloat(expense.priceBeforeTax.toFixed(2)),
                                parseFloat(expense.taxAmount.toFixed(2)),
                                parseFloat(expense.totalExpense.toFixed(2)),
                                expense.paid ? 'Paid' : 'Unpaid'
                            ]);

                            const paidStatusCell = row.getCell(10);
                            if (expense.paid) {
                                paidStatusCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE8F5E9' } };
                            } else {
                                paidStatusCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF3E0' } };
                            }

                            row.eachCell((cell) => {
                                cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                            });
                        });

                        const expenseTotalRow = expensesWorksheet.addRow([
                            '', '', '', '', '', 'TOTAL:',
                            { formula: `SUM(G4:G${expensesWorksheet.rowCount})` },
                            { formula: `SUM(H4:H${expensesWorksheet.rowCount})` },
                            { formula: `SUM(I4:I${expensesWorksheet.rowCount})` },
                            ''
                        ]);
                        expenseTotalRow.font = { bold: true };
                        expenseTotalRow.eachCell((cell) => {
                            cell.border = { top: { style: 'medium' }, left: { style: 'thin' }, bottom: { style: 'medium' }, right: { style: 'thin' } };
                        });

                        expensesWorksheet.columns.forEach((column) => {
                            let maxLength = 0;
                            column.eachCell({ includeEmpty: false }, (cell) => {
                                const columnLength = cell.value ? cell.value.toString().length : 10;
                                if (columnLength > maxLength) maxLength = columnLength;
                            });
                            column.width = Math.min(Math.max(maxLength + 2, 12), 50);
                        });
                    }

                    // Save workbook
                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = "invoice-" + (filterStartDate || 'all') + "-" + (filterEndDate || 'dates') + ".xlsx";
                    a.click();
                    window.URL.revokeObjectURL(url);

                    setShowInvoiceClientSelection(false);
                    setSelectedInvoiceClients([]);
                    setClientRates({});
                } catch (error) {
                    console.error('Invoice generation error:', error);
                    setStorageError('Failed to generate invoice: ' + error.message);
                }
            };

            // Shared function to generate Excel workbook from time entries
            const generateExcelWorkbook = async (entriesToUse) => {
                const ExcelJS = window.require('exceljs');
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('ThymeSheet (ALL)');

                const filteredEntries = entriesToUse;

                    // Calculate hierarchical project summary
                    const hierarchicalSummary = {};
                    let grandTotal = 0;

                    filteredEntries.forEach(entry => {
                        const projectName = entry.projectName;
                        const taskCode = entry.taskCode;
                        const subtaskCode = entry.subtaskCode;

                        // Initialize project if needed
                        if (!hierarchicalSummary[projectName]) {
                            hierarchicalSummary[projectName] = {
                                total: 0,
                                tasks: {}
                            };
                        }

                        // Initialize task if needed
                        if (!hierarchicalSummary[projectName].tasks[taskCode]) {
                            hierarchicalSummary[projectName].tasks[taskCode] = {
                                total: 0,
                                subtasks: {}
                            };
                        }

                        // Initialize subtask if needed
                        if (!hierarchicalSummary[projectName].tasks[taskCode].subtasks[subtaskCode]) {
                            hierarchicalSummary[projectName].tasks[taskCode].subtasks[subtaskCode] = 0;
                        }

                        // Add hours at all levels
                        hierarchicalSummary[projectName].tasks[taskCode].subtasks[subtaskCode] += entry.hours;
                        hierarchicalSummary[projectName].tasks[taskCode].total += entry.hours;
                        hierarchicalSummary[projectName].total += entry.hours;
                        grandTotal += entry.hours;
                    });

                    // HIERARCHICAL PROJECT SUMMARY TABLE
                    worksheet.addRow(['PROJECT SUMMARY - HOURS BY PROJECT, TASK, AND SUBTASK']);
                    worksheet.getCell('A1').font = { bold: true, size: 14 };
                    worksheet.addRow([]);

                    const summaryHeaderRow = worksheet.addRow(['Project / Task / Subtask', 'Hours']);
                    summaryHeaderRow.font = { bold: true };
                    summaryHeaderRow.eachCell((cell) => {
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FF4A7C59' }
                        };
                        cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                        cell.border = {
                            top: { style: 'thin' },
                            left: { style: 'thin' },
                            bottom: { style: 'thin' },
                            right: { style: 'thin' }
                        };
                    });

                    let currentRow = 4;

                    // Sort projects alphabetically
                    const sortedProjects = Object.keys(hierarchicalSummary).sort();

                    sortedProjects.forEach(projectName => {
                        const project = hierarchicalSummary[projectName];

                        // Add project row (bold, with background color)
                        const projectRow = worksheet.addRow([projectName, parseFloat(project.total.toFixed(2))]);
                        projectRow.font = { bold: true };
                        projectRow.getCell(1).fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFE8F5E9' } // Light green
                        };
                        projectRow.eachCell((cell) => {
                            cell.border = {
                                top: { style: 'thin' },
                                left: { style: 'thin' },
                                bottom: { style: 'thin' },
                                right: { style: 'thin' }
                            };
                        });
                        currentRow++;

                        // Sort tasks
                        const sortedTasks = Object.keys(project.tasks).sort();

                        sortedTasks.forEach(taskCode => {
                            const task = project.tasks[taskCode];

                            // Add task row (indented, semi-bold)
                            const taskRow = worksheet.addRow(['  ' + taskCode, parseFloat(task.total.toFixed(2))]);
                            taskRow.font = { bold: true, italic: true };
                            taskRow.getCell(1).fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: { argb: 'FFF1F8F4' } // Very light green
                            };
                            taskRow.eachCell((cell) => {
                                cell.border = {
                                    top: { style: 'thin' },
                                    left: { style: 'thin' },
                                    bottom: { style: 'thin' },
                                    right: { style: 'thin' }
                                };
                            });
                            currentRow++;

                            // Sort subtasks
                            const sortedSubtasks = Object.keys(task.subtasks).sort();

                            sortedSubtasks.forEach(subtaskCode => {
                                const subtaskHours = task.subtasks[subtaskCode];

                                // Add subtask row (double indented, normal weight)
                                const subtaskRow = worksheet.addRow(['    ' + subtaskCode, parseFloat(subtaskHours.toFixed(2))]);
                                subtaskRow.eachCell((cell) => {
                                    cell.border = {
                                        top: { style: 'thin' },
                                        left: { style: 'thin' },
                                        bottom: { style: 'thin' },
                                        right: { style: 'thin' }
                                    };
                                });
                                currentRow++;
                            });
                        });
                    });

                    // Add grand total row
                    const grandTotalRow = worksheet.addRow(['GRAND TOTAL', parseFloat(grandTotal.toFixed(2))]);
                    grandTotalRow.font = { bold: true, size: 12 };
                    grandTotalRow.getCell(1).fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FF4A7C59' } // Dark green
                    };
                    grandTotalRow.getCell(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
                    grandTotalRow.getCell(2).fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FF4A7C59' }
                    };
                    grandTotalRow.getCell(2).font = { bold: true, color: { argb: 'FFFFFFFF' } };
                    grandTotalRow.eachCell((cell) => {
                        cell.border = {
                            top: { style: 'medium' },
                            left: { style: 'thin' },
                            bottom: { style: 'medium' },
                            right: { style: 'thin' }
                        };
                    });

                    const summaryLastRow = currentRow + 1;

                    // DETAILED TIMESHEET TABLE
                    const detailStartRow = summaryLastRow + 3;
                    worksheet.addRow([]);
                    worksheet.getCell('A' + detailStartRow).value = 'DETAILED TIMESHEET';
                    worksheet.getCell('A' + detailStartRow).font = { bold: true, size: 14 };

                    worksheet.addRow([]);

                    const detailHeaderRow = worksheet.addRow([
                        'Week of Month',
                        'Date',
                        'Client Name',
                        'Project Name',
                        'Task Name',
                        'Subtask Name',
                        'Hours',
                        'Comment',
                        'Daily Total',
                        'Weekly Total'
                    ]);
                    detailHeaderRow.font = { bold: true };
                    detailHeaderRow.eachCell((cell) => {
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FF4A7C59' }
                        };
                        cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                        cell.border = {
                            top: { style: 'thin' },
                            left: { style: 'thin' },
                            bottom: { style: 'thin' },
                            right: { style: 'thin' }
                        };
                    });

                    // Sort entries by date
                    const sortedEntries = [...filteredEntries].sort((a, b) => a.date.localeCompare(b.date));

                    // Consolidate duplicate entries based on user preference
                    const consolidatedEntries = [];
                    const entryMap = {};

                    sortedEntries.forEach(entry => {
                        // Create a unique key based on date and relevant fields
                        // If mergeEntries is true, exclude comment from key to merge entries with same date/task/subtask
                        const keyFields = [
                            entry.date,
                            entry.clientName || '',
                            entry.projectName,
                            entry.taskCode,
                            entry.subtaskCode
                        ];

                        // Only include comment in key if NOT merging entries
                        if (!mergeEntries) {
                            keyFields.push(entry.comment || '');
                        }

                        const key = keyFields.join('|');

                        if (entryMap[key]) {
                            // Add hours to existing entry
                            entryMap[key].hours += entry.hours;
                            // Combine comments if merging
                            if (mergeEntries && entry.comment) {
                                if (entryMap[key].comment && entryMap[key].comment !== entry.comment) {
                                    entryMap[key].comment += '; ' + entry.comment;
                                } else if (!entryMap[key].comment) {
                                    entryMap[key].comment = entry.comment;
                                }
                            }
                        } else {
                            // Create new consolidated entry
                            entryMap[key] = { ...entry };
                            consolidatedEntries.push(entryMap[key]);
                        }
                    });

                    // Calculate daily and weekly totals
                    const dailyTotals = {};
                    const weeklyTotals = {};
                    sortedEntries.forEach(entry => {
                        // Daily totals
                        if (!dailyTotals[entry.date]) {
                            dailyTotals[entry.date] = 0;
                        }
                        dailyTotals[entry.date] += entry.hours;

                        // Weekly totals (week starting Sunday)
                        const entryDate = new Date(entry.date);
                        const dayOfWeek = entryDate.getDay();
                        const weekStart = new Date(entryDate);
                        weekStart.setDate(entryDate.getDate() - dayOfWeek);
                        const weekKey = getLocalDateString(weekStart);

                        if (!weeklyTotals[weekKey]) {
                            weeklyTotals[weekKey] = 0;
                        }
                        weeklyTotals[weekKey] += entry.hours;
                    });

                    // Function to get week of month (calendar-based: week changes every Sunday)
                    const getWeekOfMonth = (dateStr) => {
                        // Parse date string directly to avoid timezone issues
                        const parts = dateStr.split('-');
                        const dayOfMonth = parseInt(parts[2]);

                        // Simply calculate week based on day of month
                        // Week 1: days 1-7, Week 2: days 8-14, Week 3: days 15-21, Week 4: days 22-28, Week 5: days 29+
                        return Math.ceil(dayOfMonth / 7);
                    };

                    // Function to get week start date (always Sunday)
                    const getWeekStart = (dateStr) => {
                        const date = new Date(dateStr);
                        const dayOfWeek = date.getDay(); // 0=Sunday
                        const weekStart = new Date(date);
                        weekStart.setDate(date.getDate() - dayOfWeek);
                        return getLocalDateString(weekStart);
                    };

                    // Function to check if two dates are in the same week of the month
                    const isSameWeekOfMonth = (dateStr1, dateStr2) => {
                        return getWeekOfMonth(dateStr1) === getWeekOfMonth(dateStr2);
                    };

                    // Add detail rows
                    let currentWeekStart = null;
                    let currentWeekOfMonth = null;
                    let currentDate = null;
                    const detailDataStartRow = detailHeaderRow.number + 1;

                    consolidatedEntries.forEach((entry, index) => {
                        const weekStart = getWeekStart(entry.date);
                        const weekOfMonth = getWeekOfMonth(entry.date);
                        const isNewWeek = weekOfMonth !== currentWeekOfMonth;
                        const isNewDay = entry.date !== currentDate;

                        currentWeekStart = weekStart;
                        currentWeekOfMonth = weekOfMonth;
                        currentDate = entry.date;

                        // Format date as "Month Day, Year" (using string parsing to avoid timezone issues)
                        const dateParts = entry.date.split('-');
                        const year = parseInt(dateParts[0]);
                        const month = parseInt(dateParts[1]) - 1; // 0-indexed for month names
                        const day = parseInt(dateParts[2]);
                        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                           'July', 'August', 'September', 'October', 'November', 'December'];
                        const formattedDate = monthNames[month] + ' ' + day + ', ' + year;

                        // Check if this is the first entry for this date
                        const isFirstEntryForDate = index === 0 || consolidatedEntries[index - 1].date !== entry.date;

                        // Check if this is the first entry for this week of month
                        const prevWeekOfMonth = index === 0 ? null : getWeekOfMonth(consolidatedEntries[index - 1].date);
                        const isFirstEntryForWeek = index === 0 || prevWeekOfMonth !== weekOfMonth;

                        // Check if this is the last entry for this week of month
                        const nextWeekOfMonth = index === consolidatedEntries.length - 1 ? null : getWeekOfMonth(consolidatedEntries[index + 1].date);
                        const isLastEntryForWeek = index === consolidatedEntries.length - 1 || nextWeekOfMonth !== weekOfMonth;

                        const row = worksheet.addRow([
                            weekOfMonth,
                            formattedDate,
                            entry.clientName || '',
                            entry.projectName,
                            entry.taskCode,
                            entry.subtaskCode,
                            parseFloat(entry.hours.toFixed(2)),
                            entry.comment || '',
                            '', // Daily Total - will be formula
                            ''  // Weekly Total - will be formula
                        ]);

                        const currentRowNum = row.number;

                        // Add Excel formula for Daily Total (column I = 9)
                        // Formula: =IF(COUNTIF($B$[firstRow]:B[currentRow], B[currentRow])=1, SUMIFS($G:$G, $B:$B, B[currentRow]), "")
                        const dailyFormulaFirstRow = detailDataStartRow;
                        row.getCell(9).value = {
                            formula: `IF(COUNTIF($B$${dailyFormulaFirstRow}:B${currentRowNum},B${currentRowNum})=1,SUMIFS($G:$G,$B:$B,B${currentRowNum}),"")`
                        };

                        // Add Excel formula for Weekly Total (column J = 10)
                        // Formula: =IF(COUNTIF($A$[firstRow]:A[currentRow], A[currentRow])=1, SUMIFS($G:$G, $A:$A, A[currentRow]), "")
                        row.getCell(10).value = {
                            formula: `IF(COUNTIF($A$${dailyFormulaFirstRow}:A${currentRowNum},A${currentRowNum})=1,SUMIFS($G:$G,$A:$A,A${currentRowNum}),"")`
                        };

                        // Apply borders - bold borders for week-of-month boundaries
                        row.eachCell((cell) => {
                            cell.border = {
                                top: { style: isFirstEntryForWeek ? 'medium' : 'thin' },
                                left: { style: 'thin' },
                                bottom: { style: isLastEntryForWeek ? 'medium' : 'thin' },
                                right: { style: 'thin' }
                            };
                        });
                    });

                    // Add grand total row for detailed timesheet
                    const detailGrandTotalRow = worksheet.addRow([
                        '', '', '', '', '', '', '', '', 'GRAND TOTAL:', parseFloat(grandTotal.toFixed(2))
                    ]);
                    detailGrandTotalRow.font = { bold: true };
                    detailGrandTotalRow.getCell(9).font = { bold: true };
                    detailGrandTotalRow.getCell(10).font = { bold: true };
                    detailGrandTotalRow.eachCell((cell) => {
                        cell.border = {
                            top: { style: 'thin' },
                            left: { style: 'thin' },
                            bottom: { style: 'thin' },
                            right: { style: 'thin' }
                        };
                    });

                    // Auto-fit columns
                    worksheet.columns.forEach((column) => {
                        let maxLength = 0;
                        column.eachCell({ includeEmpty: false }, (cell) => {
                            const cellValue = cell.value ? cell.value.toString() : '';
                            if (cellValue.length > maxLength) {
                                maxLength = cellValue.length;
                            }
                        });
                        column.width = Math.min(Math.max(maxLength + 2, 10), 50);
                    });

                    // ========================================
                    // WORLEY (FOR JEREMY) SHEET - Horizontal format with dates as columns
                    // ========================================
                    const worleyEntries = filteredEntries.filter(entry =>
                        entry.clientName && entry.clientName.toLowerCase().includes('worley')
                    );

                    if (worleyEntries.length > 0) {
                        const worleySheet = workbook.addWorksheet('Worley (for Jeremy)');

                        // Generate ALL dates in the range (not just dates with hours)
                        const allDates = [];
                        if (filterStartDate && filterEndDate) {
                            // Use string manipulation to avoid timezone issues
                            let currentDate = filterStartDate;
                            const endDate = filterEndDate;
                            while (currentDate <= endDate) {
                                allDates.push(currentDate);
                                // Increment date by adding one day
                                const parts = currentDate.split('-');
                                const year = parseInt(parts[0]);
                                const month = parseInt(parts[1]) - 1;
                                const day = parseInt(parts[2]);
                                const nextDate = new Date(year, month, day + 1);
                                currentDate = nextDate.getFullYear() + '-' +
                                             String(nextDate.getMonth() + 1).padStart(2, '0') + '-' +
                                             String(nextDate.getDate()).padStart(2, '0');
                            }
                        } else {
                            // If no date filter, use dates from entries
                            const uniqueDatesSet = new Set(worleyEntries.map(e => e.date));
                            allDates.push(...Array.from(uniqueDatesSet).sort());
                        }

                        // Format dates as M/D/YYYY (using string parsing to avoid timezone issues)
                        const formattedDates = allDates.map(dateStr => {
                            const parts = dateStr.split('-');
                            const year = parseInt(parts[0]);
                            const month = parseInt(parts[1]);
                            const day = parseInt(parts[2]);
                            return month + '/' + day + '/' + year;
                        });

                        // Group Worley entries by Work Item, Project No (task code), and Task Code (subtask code)
                        const worleyData = {};
                        worleyEntries.forEach(entry => {
                            const key = entry.projectName + '|' + entry.taskCode + '|' + entry.subtaskCode;
                            if (!worleyData[key]) {
                                worleyData[key] = {
                                    workItem: entry.projectName,
                                    projectNo: entry.taskCode,
                                    taskCode: entry.subtaskCode,
                                    dateHours: {},
                                    total: 0
                                };
                            }
                            if (!worleyData[key].dateHours[entry.date]) {
                                worleyData[key].dateHours[entry.date] = 0;
                            }
                            worleyData[key].dateHours[entry.date] += entry.hours;
                            worleyData[key].total += entry.hours;
                        });

                        // Build header row
                        const worleyHeaders = ['Work Item', 'Project No.', 'Task Code', ...formattedDates, 'Total'];
                        const worleyHeaderRow = worleySheet.addRow(worleyHeaders);

                        // Style header row (green like ThymeSheet)
                        worleyHeaderRow.font = { bold: true };
                        worleyHeaderRow.eachCell((cell) => {
                            cell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: { argb: 'FF4A7C59' }
                            };
                            cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                            cell.border = {
                                top: { style: 'thin' },
                                left: { style: 'thin' },
                                bottom: { style: 'thin' },
                                right: { style: 'thin' }
                            };
                        });

                        // Add data rows
                        Object.values(worleyData).forEach(item => {
                            const rowData = [
                                item.workItem,
                                item.projectNo,
                                item.taskCode
                            ];

                            // Add hours for each date (including 0 for dates with no hours)
                            allDates.forEach(date => {
                                const hours = item.dateHours[date] || 0;
                                rowData.push(hours);
                            });

                            // Add total
                            rowData.push(item.total);

                            const row = worleySheet.addRow(rowData);
                            row.eachCell((cell) => {
                                cell.border = {
                                    top: { style: 'thin' },
                                    left: { style: 'thin' },
                                    bottom: { style: 'thin' },
                                    right: { style: 'thin' }
                                };
                            });
                        });

                        // Add Total row at bottom
                        const totalRowData = ['', '', 'Total'];
                        const worleyDailyTotals = {};
                        allDates.forEach(date => {
                            worleyDailyTotals[date] = 0;
                        });

                        worleyEntries.forEach(entry => {
                            if (worleyDailyTotals[entry.date] !== undefined) {
                                worleyDailyTotals[entry.date] += entry.hours;
                            }
                        });

                        let worleyGrandTotal = 0;
                        allDates.forEach(date => {
                            totalRowData.push(worleyDailyTotals[date]);
                            worleyGrandTotal += worleyDailyTotals[date];
                        });
                        totalRowData.push(worleyGrandTotal);

                        const totalRow = worleySheet.addRow(totalRowData);
                        totalRow.font = { bold: true };
                        totalRow.eachCell((cell) => {
                            cell.border = {
                                top: { style: 'thin' },
                                left: { style: 'thin' },
                                bottom: { style: 'thin' },
                                right: { style: 'thin' }
                            };
                        });

                        // Auto-fit columns in Worley sheet
                        worleySheet.columns.forEach((column) => {
                            let maxLength = 0;
                            column.eachCell({ includeEmpty: false }, (cell) => {
                                const cellValue = cell.value ? cell.value.toString() : '';
                                if (cellValue.length > maxLength) {
                                    maxLength = cellValue.length;
                                }
                            });
                            column.width = Math.min(Math.max(maxLength + 2, 12), 50);
                        });
                    }

                    // INVOICE REMOVED - Use "Generate Invoice" button instead
                    // (Invoice sheet generation removed - users should use the dedicated "Generate Invoice" feature)

                    // ========================================
                    // CREATE CLIENT-SPECIFIC SHEETS
                    // ========================================
                    // Get unique clients from filtered entries (excluding empty client names)
                    const clientNames = [...new Set(filteredEntries.map(e => e.clientName || 'No Client').filter(c => c))].sort();

                    clientNames.forEach(clientName => {
                        const clientEntries = filteredEntries.filter(e => (e.clientName || 'No Client') === clientName);

                        // Create worksheet with sanitized name (Excel sheet names have limits)
                        // Special case: Rename Worley to "Worley (generic)" to distinguish from "Worley (for Jeremy)"
                        let sanitizedName = clientName.substring(0, 31).replace(/[:\\/?*\[\]]/g, '_');
                        if (clientName.toLowerCase().includes('worley')) {
                            sanitizedName = 'Worley (generic)';
                        }
                        const clientSheet = workbook.addWorksheet(sanitizedName);

                        // Add title
                        clientSheet.mergeCells('A1:J1');
                        const titleCell = clientSheet.getCell('A1');
                        titleCell.value = `TIMESHEET - ${clientName}`;
                        titleCell.font = { bold: true, size: 14 };
                        titleCell.alignment = { horizontal: 'center' };
                        clientSheet.addRow([]);

                        // Add header row
                        const clientHeaderRow = clientSheet.addRow([
                            'Week of Month',
                            'Date',
                            'Client Name',
                            'Project Name',
                            'Task Name',
                            'Subtask Name',
                            'Hours',
                            'Comment',
                            'Daily Total',
                            'Weekly Total'
                        ]);
                        clientHeaderRow.font = { bold: true };
                        clientHeaderRow.eachCell((cell) => {
                            cell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: { argb: 'FF4A7C59' }
                            };
                            cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                            cell.border = {
                                top: { style: 'thin' },
                                left: { style: 'thin' },
                                bottom: { style: 'thin' },
                                right: { style: 'thin' }
                            };
                        });

                        // Sort client entries by date
                        const sortedClientEntries = [...clientEntries].sort((a, b) => a.date.localeCompare(b.date));

                        // Consolidate duplicate entries
                        const clientConsolidatedEntries = [];
                        const clientEntryMap = {};

                        sortedClientEntries.forEach(entry => {
                            const keyFields = [
                                entry.date,
                                entry.clientName || '',
                                entry.projectName,
                                entry.taskCode,
                                entry.subtaskCode
                            ];

                            if (!mergeEntries) {
                                keyFields.push(entry.comment || '');
                            }

                            const key = keyFields.join('|');

                            if (clientEntryMap[key]) {
                                clientEntryMap[key].hours += entry.hours;
                                if (mergeEntries && entry.comment) {
                                    if (clientEntryMap[key].comment && clientEntryMap[key].comment !== entry.comment) {
                                        clientEntryMap[key].comment += '; ' + entry.comment;
                                    } else if (!clientEntryMap[key].comment) {
                                        clientEntryMap[key].comment = entry.comment;
                                    }
                                }
                            } else {
                                clientEntryMap[key] = { ...entry };
                                clientConsolidatedEntries.push(clientEntryMap[key]);
                            }
                        });

                        // Add data rows with formulas
                        let clientGrandTotal = 0;
                        const clientDataStartRow = clientHeaderRow.number + 1;

                        clientConsolidatedEntries.forEach((entry, index) => {
                            const weekStart = getWeekStart(entry.date);
                            const weekOfMonth = getWeekOfMonth(entry.date);

                            // Format date
                            const dateParts = entry.date.split('-');
                            const year = parseInt(dateParts[0]);
                            const month = parseInt(dateParts[1]) - 1;
                            const day = parseInt(dateParts[2]);
                            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                               'July', 'August', 'September', 'October', 'November', 'December'];
                            const formattedDate = monthNames[month] + ' ' + day + ', ' + year;

                            const isFirstEntryForDate = index === 0 || clientConsolidatedEntries[index - 1].date !== entry.date;
                            const prevWeekOfMonth = index === 0 ? null : getWeekOfMonth(clientConsolidatedEntries[index - 1].date);
                            const isFirstEntryForWeek = index === 0 || prevWeekOfMonth !== weekOfMonth;
                            const nextWeekOfMonth = index === clientConsolidatedEntries.length - 1 ? null : getWeekOfMonth(clientConsolidatedEntries[index + 1].date);
                            const isLastEntryForWeek = index === clientConsolidatedEntries.length - 1 || nextWeekOfMonth !== weekOfMonth;

                            const row = clientSheet.addRow([
                                weekOfMonth,
                                formattedDate,
                                entry.clientName || '',
                                entry.projectName,
                                entry.taskCode,
                                entry.subtaskCode,
                                parseFloat(entry.hours.toFixed(2)),
                                entry.comment || '',
                                '',
                                ''
                            ]);

                            const currentRowNum = row.number;

                            // Add Excel formulas using COUNTIF and SUMIFS
                            // Daily Total: =IF(COUNTIF($B$4:B[row], B[row])=1, SUMIFS($G:$G, $B:$B, B[row]), "")
                            row.getCell(9).value = {
                                formula: `IF(COUNTIF($B$${clientDataStartRow}:B${currentRowNum},B${currentRowNum})=1,SUMIFS($G:$G,$B:$B,B${currentRowNum}),"")`
                            };

                            // Weekly Total: =IF(COUNTIF($A$4:A[row], A[row])=1, SUMIFS($G:$G, $A:$A, A[row]), "")
                            row.getCell(10).value = {
                                formula: `IF(COUNTIF($A$${clientDataStartRow}:A${currentRowNum},A${currentRowNum})=1,SUMIFS($G:$G,$A:$A,A${currentRowNum}),"")`
                            };

                            // Apply borders
                            row.eachCell((cell) => {
                                cell.border = {
                                    top: { style: isFirstEntryForWeek ? 'medium' : 'thin' },
                                    left: { style: 'thin' },
                                    bottom: { style: isLastEntryForWeek ? 'medium' : 'thin' },
                                    right: { style: 'thin' }
                                };
                            });

                            clientGrandTotal += entry.hours;
                        });

                        // Add grand total row
                        const clientGrandTotalRow = clientSheet.addRow([
                            '', '', '', '', '', '', '', '', 'GRAND TOTAL:', parseFloat(clientGrandTotal.toFixed(2))
                        ]);
                        clientGrandTotalRow.font = { bold: true };
                        clientGrandTotalRow.getCell(9).font = { bold: true };
                        clientGrandTotalRow.getCell(10).font = { bold: true };
                        clientGrandTotalRow.eachCell((cell) => {
                            cell.border = {
                                top: { style: 'thin' },
                                left: { style: 'thin' },
                                bottom: { style: 'thin' },
                                right: { style: 'thin' }
                            };
                        });

                        // Auto-fit columns
                        clientSheet.columns.forEach((column) => {
                            let maxLength = 0;
                            column.eachCell({ includeEmpty: false }, (cell) => {
                                const cellValue = cell.value ? cell.value.toString() : '';
                                if (cellValue.length > maxLength) {
                                    maxLength = cellValue.length;
                                }
                            });
                            column.width = Math.min(Math.max(maxLength + 2, 10), 50);
                        });
                    });

                    // EXPENSES TAB
                    // Filter expenses by the same date/client/project filters as time entries
                    const filteredExpenses = expenses.filter(expense => {
                        let matches = true;
                        if (filterStartDate && expense.purchaseDate < filterStartDate) matches = false;
                        if (filterEndDate && expense.purchaseDate > filterEndDate) matches = false;
                        if (filterClient && expense.clientName !== filterClient) matches = false;
                        if (filterProject && expense.projectName !== filterProject) matches = false;
                        return matches;
                    });

                    if (filteredExpenses.length > 0) {
                        const expensesWorksheet = workbook.addWorksheet('Expenses');

                        // Title
                        expensesWorksheet.addRow(['EXPENSES']);
                        expensesWorksheet.getCell('A1').font = { bold: true, size: 14 };
                        expensesWorksheet.addRow([]);

                        // Header row
                        const expenseHeaderRow = expensesWorksheet.addRow([
                            'Date',
                            'Client Name',
                            'Project Name',
                            'Category',
                            'Vendor',
                            'Description',
                            'Price Before Tax',
                            'Tax Amount',
                            'Total Expense',
                            'Paid Status'
                        ]);
                        expenseHeaderRow.font = { bold: true };
                        expenseHeaderRow.eachCell((cell) => {
                            cell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: { argb: 'FF4A7C59' }
                            };
                            cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                            cell.border = {
                                top: { style: 'thin' },
                                left: { style: 'thin' },
                                bottom: { style: 'thin' },
                                right: { style: 'thin' }
                            };
                        });

                        // Sort expenses by date
                        const sortedExpenses = [...filteredExpenses].sort((a, b) =>
                            a.purchaseDate.localeCompare(b.purchaseDate)
                        );

                        // Data rows
                        sortedExpenses.forEach(expense => {
                            // Format date
                            const dateParts = expense.purchaseDate.split('-');
                            const year = parseInt(dateParts[0]);
                            const month = parseInt(dateParts[1]) - 1;
                            const day = parseInt(dateParts[2]);
                            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                               'July', 'August', 'September', 'October', 'November', 'December'];
                            const formattedDate = monthNames[month] + ' ' + day + ', ' + year;

                            const row = expensesWorksheet.addRow([
                                formattedDate,
                                expense.clientName || '',
                                expense.projectName || '',
                                expense.category,
                                expense.vendor,
                                expense.description,
                                parseFloat(expense.priceBeforeTax.toFixed(2)),
                                parseFloat(expense.taxAmount.toFixed(2)),
                                parseFloat(expense.totalExpense.toFixed(2)),
                                expense.paid ? 'Paid' : 'Unpaid'
                            ]);

                            // Style paid status cell
                            const paidStatusCell = row.getCell(10);
                            if (expense.paid) {
                                paidStatusCell.fill = {
                                    type: 'pattern',
                                    pattern: 'solid',
                                    fgColor: { argb: 'FFE8F5E9' }
                                };
                            } else {
                                paidStatusCell.fill = {
                                    type: 'pattern',
                                    pattern: 'solid',
                                    fgColor: { argb: 'FFFFF3E0' }
                                };
                            }

                            // Add borders
                            row.eachCell((cell) => {
                                cell.border = {
                                    top: { style: 'thin' },
                                    left: { style: 'thin' },
                                    bottom: { style: 'thin' },
                                    right: { style: 'thin' }
                                };
                            });
                        });

                        // Totals row
                        const expenseTotalRow = expensesWorksheet.addRow([
                            '', '', '', '', '', 'TOTAL:',
                            { formula: `SUM(G4:G${expensesWorksheet.rowCount})` },
                            { formula: `SUM(H4:H${expensesWorksheet.rowCount})` },
                            { formula: `SUM(I4:I${expensesWorksheet.rowCount})` },
                            ''
                        ]);
                        expenseTotalRow.font = { bold: true };
                        expenseTotalRow.getCell(6).font = { bold: true };
                        expenseTotalRow.eachCell((cell) => {
                            cell.border = {
                                top: { style: 'medium' },
                                left: { style: 'thin' },
                                bottom: { style: 'medium' },
                                right: { style: 'thin' }
                            };
                        });

                        // Auto-fit columns
                        expensesWorksheet.columns.forEach((column) => {
                            let maxLength = 0;
                            column.eachCell({ includeEmpty: false }, (cell) => {
                                const columnLength = cell.value ? cell.value.toString().length : 10;
                                if (columnLength > maxLength) {
                                    maxLength = columnLength;
                                }
                            });
                            column.width = Math.min(Math.max(maxLength + 2, 12), 50);
                        });
                    }

                    // Return the workbook
                    return workbook;
            };

            const exportToExcel = async () => {
                if (timeEntries.length === 0) {
                    setStorageError('No entries to export');
                    return;
                }

                const filteredEntries = timeEntries.filter(entry => {
                    let matches = true;
                    if (filterStartDate && entry.date < filterStartDate) matches = false;
                    if (filterEndDate && entry.date > filterEndDate) matches = false;
                    if (filterClient && entry.clientName !== filterClient) matches = false;
                    if (filterProject && entry.projectName !== filterProject) matches = false;
                    return matches;
                });

                if (filteredEntries.length === 0) {
                    setStorageError('No entries match the filters');
                    return;
                }

                try {
                    // Use the shared workbook generation function
                    const workbook = await generateExcelWorkbook(filteredEntries);

                    // Generate file and download
                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = "timesheet-" + (filterStartDate || 'all') + "-" + (filterEndDate || 'dates') + ".xlsx";
                    a.click();
                    window.URL.revokeObjectURL(url);

                } catch (error) {
                    console.error('Excel export error:', error);
                    setStorageError('Failed to export to Excel: ' + error.message);
                }
            };

            const exportToInvoice = async () => {
                if (timeEntries.length === 0) {
                    setStorageError('No entries to export');
                    return;
                }

                const filteredEntries = timeEntries.filter(entry => {
                    let matches = true;
                    if (filterStartDate && entry.date < filterStartDate) matches = false;
                    if (filterEndDate && entry.date > filterEndDate) matches = false;
                    if (filterClient && entry.clientName !== filterClient) matches = false;
                    if (filterProject && entry.projectName !== filterProject) matches = false;
                    return matches;
                });

                if (filteredEntries.length === 0) {
                    setStorageError('No entries match the filters');
                    return;
                }

                try {
                    // Import jsPDF - check if available
                    if (!window.jspdf) {
                        setStorageError('PDF library not loaded. Please refresh the page and try again.');
                        console.error('jsPDF not found on window object');
                        return;
                    }

                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();

                    // Company Header
                    doc.setFontSize(20);
                    doc.setFont('helvetica', 'bold');
                    doc.text('[YOUR COMPANY NAME]', 105, 20, { align: 'center' });

                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text('[Your Address Line 1]', 105, 27, { align: 'center' });
                    doc.text('[City, State, ZIP]', 105, 32, { align: 'center' });
                    doc.text('GST #: [YOUR GST NUMBER]', 105, 37, { align: 'center' });

                    // Client Information
                    const firstEntry = filteredEntries[0];
                    const clientName = firstEntry.clientName || '[Client Name]';
                    const projectName = firstEntry.projectName || '[Project Name]';

                    doc.setFontSize(10);
                    doc.text(clientName, 14, 55);
                    doc.text('[Client Address]', 14, 60);
                    doc.text('[City, State, ZIP]', 14, 65);

                    // Invoice Details (right side)
                    const invoiceDate = new Date().toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: '2-digit' });
                    const invoiceNumber = 'INV-' + Date.now().toString().slice(-6);

                    doc.text(invoiceDate, pageWidth - 14, 55, { align: 'right' });
                    doc.text(invoiceNumber, pageWidth - 14, 60, { align: 'right' });

                    // Project Information
                    doc.text('Project: ' + projectName, 14, 75);
                    doc.text('Contract Number: [YOUR CONTRACT NUMBER]', 14, 80);

                    // Period
                    const periodStart = filterStartDate || filteredEntries[0].date;
                    const periodEnd = filterEndDate || filteredEntries[filteredEntries.length - 1].date;
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Professional Services for the period ending ${new Date(periodEnd).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`, 14, 90);

                    // Group entries by task and subtask
                    const taskGroups = {};
                    filteredEntries.forEach(entry => {
                        const taskKey = `${entry.taskCode || 'General'}`;
                        const subtaskKey = entry.subtaskCode || 'No Subtask';

                        if (!taskGroups[taskKey]) {
                            taskGroups[taskKey] = {};
                        }
                        if (!taskGroups[taskKey][subtaskKey]) {
                            taskGroups[taskKey][subtaskKey] = [];
                        }
                        taskGroups[taskKey][subtaskKey].push(entry);
                    });

                    let yPos = 100;
                    let invoiceTotal = 0;

                    Object.keys(taskGroups).forEach(taskKey => {
                        // Task Header
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`Task: ${taskKey}`, 14, yPos);
                        yPos += 7;

                        Object.keys(taskGroups[taskKey]).forEach(subtaskKey => {
                            const entries = taskGroups[taskKey][subtaskKey];

                            // Subtask Header
                            doc.setFont('helvetica', 'bold');
                            doc.text(`  Sub Task: ${subtaskKey}`, 14, yPos);
                            yPos += 5;

                            doc.setFont('helvetica', 'normal');
                            doc.text('  Professional Personnel', 14, yPos);
                            yPos += 5;

                            // Table header
                            doc.setFontSize(9);
                            doc.text('Hours', 80, yPos);
                            doc.text('Rate', 110, yPos);
                            doc.text('Amount', 150, yPos);
                            yPos += 5;

                            // Group by person (if you track that)
                            const totalHours = entries.reduce((sum, e) => sum + e.hours, 0);
                            const rate = 175.00; // Default rate - you can make this dynamic
                            const amount = totalHours * rate;

                            doc.text('[Your Name]', 20, yPos);
                            doc.text(totalHours.toFixed(1), 80, yPos);
                            doc.text(`$${rate.toFixed(2)}`, 110, yPos);
                            doc.text(`$${amount.toFixed(2)}`, 150, yPos);
                            yPos += 5;

                            // Totals row
                            doc.setFont('helvetica', 'bold');
                            doc.text('Total Labor', 60, yPos);
                            doc.text(`$ ${amount.toFixed(2)}`, 150, yPos);
                            yPos += 7;

                            doc.text(`Total this Sub Task: $ ${amount.toFixed(2)}`, 120, yPos);
                            yPos += 5;

                            invoiceTotal += amount;
                        });

                        // Task total
                        const taskTotal = Object.values(taskGroups[taskKey]).flat().reduce((sum, e) => sum + e.hours * 175, 0);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`Total this Task: $ ${taskTotal.toFixed(2)}`, 120, yPos);
                        yPos += 10;

                        // Check if we need a new page
                        if (yPos > pageHeight - 40) {
                            doc.addPage();
                            yPos = 20;
                        }
                    });

                    // Invoice Total
                    doc.setDrawColor(0);
                    doc.setLineWidth(0.5);
                    doc.line(14, yPos, pageWidth - 14, yPos);
                    yPos += 7;

                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Invoice Total: $ ${invoiceTotal.toFixed(2)}`, pageWidth - 14, yPos, { align: 'right' });

                    // Save the PDF
                    const filename = `invoice-${invoiceNumber}-${invoiceDate.replace(/\s/g, '-')}.pdf`;
                    doc.save(filename);

                    setStorageError(`Invoice ${invoiceNumber} exported successfully!`);
                    setTimeout(() => setStorageError(null), 5000);

                } catch (error) {
                    console.error('Invoice export error:', error);
                    setStorageError('Failed to export invoice: ' + error.message);
                }
            };

            const getUniqueClients = () => {
                const clients = new Set(timeEntries.map(e => e.clientName));
                return Array.from(clients).sort();
            };

            const getUniqueProjects = () => {
                const projects = new Set(timeEntries.map(e => e.projectName));
                return Array.from(projects).sort();
            };

            // Helper functions for cascading dropdowns
            const getAvailableClients = () => {
                const clients = new Set(projectCodes.map(p => p.clientName));
                return Array.from(clients).sort();
            };

            const getAvailableProjectNames = (clientName) => {
                if (!clientName) return [];
                const projects = new Set(
                    projectCodes
                        .filter(p => p.clientName === clientName)
                        .map(p => p.projectName)
                );
                return Array.from(projects).sort();
            };

            const getAvailableTaskCodes = (clientName, projectName) => {
                if (!clientName || !projectName) return [];
                const tasks = new Set(
                    projectCodes
                        .filter(p => p.clientName === clientName && p.projectName === projectName)
                        .map(p => p.taskCode)
                );
                return Array.from(tasks).sort();
            };

            const getAvailableSubtaskCodes = (clientName, projectName, taskCode) => {
                if (!clientName || !projectName || !taskCode) return [];
                const subtasks = projectCodes
                    .filter(p =>
                        p.clientName === clientName &&
                        p.projectName === projectName &&
                        p.taskCode === taskCode
                    )
                    .map(p => ({
                        id: p.id,
                        subtaskCode: p.subtaskCode,
                        code: p.code
                    }));

                // Remove duplicates by keeping only unique subtask codes
                const uniqueSubtasks = [];
                const seenCodes = new Set();

                for (const subtask of subtasks) {
                    if (!seenCodes.has(subtask.code)) {
                        seenCodes.add(subtask.code);
                        uniqueSubtasks.push(subtask);
                    }
                }

                return uniqueSubtasks.sort((a, b) => a.subtaskCode.localeCompare(b.subtaskCode));
            };

            // Handle cascading dropdown selection
            const handleClientChange = (clientName) => {
                setSelectedClient(clientName);
                setSelectedProjectName('');
                setSelectedTaskCode('');
                setSelectedSubtaskCode('');
                setSelectedProject('');
            };

            const handleProjectNameChange = (projectName) => {
                setSelectedProjectName(projectName);
                setSelectedTaskCode('');
                setSelectedSubtaskCode('');
                setSelectedProject('');
            };

            const handleTaskCodeChange = (taskCode) => {
                setSelectedTaskCode(taskCode);
                setSelectedSubtaskCode('');
                setSelectedProject('');
            };

            const handleSubtaskCodeChange = (subtaskId) => {
                const subtask = projectCodes.find(p => p.id.toString() === subtaskId);
                if (subtask) {
                    setSelectedSubtaskCode(subtask.subtaskCode);
                    setSelectedProject(subtaskId);
                }
            };

            // Show loading screen while checking license
            if (checkingLicense) {
                return React.createElement('div', { className: "min-h-screen bg-off-white flex items-center justify-center" },
                    React.createElement('div', { className: "text-center" },
                        React.createElement('div', { className: "text-xl text-eggplant mb-4" }, "Loading ThymeSheet..."),
                        React.createElement('div', { className: "text-gray-600" }, "Please wait")
                    )
                );
            }

            if (showSetup) {
                return React.createElement('div', { className: "min-h-screen" },
                    isTracking && currentSession && React.createElement('div', { className: "sticky top-0 z-50 mb-6 bg-white border-2 border-deep-green rounded-subtle shadow-md max-w-7xl mx-auto" },
                        React.createElement('div', { className: "p-3 flex items-center justify-between gap-4" },
                            React.createElement('div', { className: "flex items-center gap-3" },
                                React.createElement('div', { className: "w-2 h-2 bg-deep-green rounded-full animate-pulse" }),
                                React.createElement('div', { className: "text-xl font-mono font-semibold text-deep-green tabular-nums" }, formatTime(elapsedTime))
                            ),
                            React.createElement('div', { className: "flex-1 text-sm text-gray-700 truncate" },
                                React.createElement('span', { className: "font-semibold text-deep-green" }, currentSession.projectCode)
                            ),
                            React.createElement('div', { className: "flex items-center gap-2" },
                                React.createElement('select', {
                                    key: currentSession ? currentSession.projectId : 'no-session',
                                    value: "",
                                    onChange: (e) => {
                                        const value = e.target.value;
                                        console.log('Dropdown changed, value:', value);
                                        if (value && value !== "") {
                                            const projectId = parseInt(value);
                                            console.log('Switching to project ID:', projectId);
                                            if (!isNaN(projectId)) {
                                                switchProject(projectId);
                                            }
                                        }
                                    },
                                    className: "px-3 py-1.5 text-xs border border-soft-gray rounded-subtle bg-white text-gray-700 hover:border-deep-green focus:outline-none focus:border-deep-green transition-colors cursor-pointer"
                                },
                                    React.createElement('option', { value: "" }, "Switch to..."),
                                    (() => {
                                        const availableProjects = projectCodes.filter(p => p.id !== currentSession.projectId);
                                        const recentAvailable = recentProjects
                                            .filter(id => id !== currentSession.projectId)
                                            .map(id => availableProjects.find(p => p.id === id))
                                            .filter(p => p);
                                        const otherProjects = availableProjects.filter(p => !recentProjects.includes(p.id));

                                        let result = [];

                                        // Add recent projects with marker
                                        if (recentAvailable.length > 0) {
                                            result.push(React.createElement('option', { key: 'recent-header', disabled: true, style: { fontWeight: 'bold' } }, 'â”€â”€ Recent Projects â”€â”€'));
                                            recentAvailable.slice(0, 9).forEach(project => {
                                                result.push(React.createElement('option', { key: project.id, value: project.id }, 'â­ ' + project.code));
                                            });
                                        }

                                        // Add separator and other projects
                                        if (otherProjects.length > 0) {
                                            if (recentAvailable.length > 0) {
                                                result.push(React.createElement('option', { key: 'other-header', disabled: true, style: { fontWeight: 'bold' } }, 'â”€â”€ All Projects â”€â”€'));
                                            }
                                            otherProjects.forEach(project => {
                                                result.push(React.createElement('option', { key: project.id, value: project.id }, project.code));
                                            });
                                        }

                                        return result;
                                    })()
                                ),
                                React.createElement('button', {
                                    onClick: stopTracking,
                                    className: "flex items-center gap-1.5 px-3 py-1.5 bg-deep-green text-white rounded-subtle hover:bg-opacity-90 transition-all font-medium text-xs"
                                },
                                    React.createElement(Square, { size: 14 }),
                                    "Stop"
                                )
                            )
                        ),
                        React.createElement('div', { className: "px-3 pb-3 pt-0 border-t border-soft-gray" },
                            React.createElement('input', {
                                type: "text",
                                value: currentComment,
                                onChange: (e) => setCurrentComment(e.target.value),
                                placeholder: "Add comment (optional)...",
                                className: "w-full px-3 py-1.5 text-xs border border-soft-gray rounded-subtle focus:outline-none focus:border-deep-green bg-white text-gray-700"
                            })
                        )
                    ),
                    React.createElement('div', { className: "sticky top-0 z-40 bg-white border-b border-soft-gray shadow-sm mb-10" },
                        React.createElement('div', { className: "max-w-7xl mx-auto px-4 sm:px-8 flex flex-wrap justify-between items-center py-4 gap-4" },
                            React.createElement('div', { className: "bg-white rounded px-2 py-1 flex-shrink-0" },
                                React.createElement('img', {
                                    src: "logo.png",
                                    alt: "Timesheet Logo",
                                    className: "h-12 sm:h-16 w-auto"
                                })
                            ),
                            React.createElement('div', { className: "flex items-center gap-2 sm:gap-3 flex-wrap" },
                                React.createElement('button', {
                                    onClick: () => setShowFeedbackModal(true),
                                    className: "p-2 text-gray-500 hover:text-deep-green hover:bg-soft-gray rounded-full transition-all",
                                    title: "Send Feedback"
                                },
                                    React.createElement(MessageSquare)
                                ),
                                React.createElement('div', { className: "inline-flex bg-soft-gray rounded-full p-1" },
                                        React.createElement('button', {
                                            onClick: () => setShowSetup(false),
                                            className: "flex items-center gap-2 px-6 py-2 rounded-full transition-all font-medium " + (!showSetup ? "bg-deep-green text-white" : "text-gray-600 hover:text-gray-800")
                                        },
                                            React.createElement(Clock),
                                            "Track Time"
                                        ),
                                    React.createElement('button', {
                                        onClick: () => setShowSetup(true),
                                        className: "flex items-center gap-2 px-6 py-2 rounded-full transition-all font-medium " + (showSetup ? "bg-eggplant text-white" : "text-gray-600 hover:text-gray-800")
                                    },
                                        React.createElement(Building),
                                        "Manage Projects"
                                    )
                                )
                            )
                        )
                    ),
                    React.createElement('div', { className: "max-w-7xl mx-auto px-8 pb-8" },

                    showSettingsMenu && React.createElement('div', {
                        className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",
                        onClick: () => setShowSettingsMenu(false)
                    },
                        React.createElement('div', {
                            className: "bg-white rounded-subtle p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto",
                            onClick: (e) => e.stopPropagation()
                        },
                            React.createElement('div', { className: "flex justify-between items-center mb-6" },
                                React.createElement('div', null,
                                    React.createElement('h2', { className: "text-2xl font-bold text-eggplant" }, "Settings"),
                                    React.createElement('p', { className: "text-xs text-gray-500 mt-1" }, "ThymeSheet v2.0.4")
                                ),
                                React.createElement('button', {
                                    onClick: () => setShowSettingsMenu(false),
                                    className: "text-gray-400 hover:text-eggplant text-2xl"
                                }, "Ã—")
                            ),

                            React.createElement('div', { className: "space-y-6" },
                                React.createElement('div', { className: "border-b border-soft-gray pb-6" },
                                    React.createElement('h3', { className: "text-lg font-semibold text-eggplant mb-3" }, "Time Rounding"),
                                    React.createElement('p', { className: "text-sm text-gray-600 mb-3" }, "Automatically round up time entries for cleaner billing"),
                                    React.createElement('select', {
                                        value: timeRounding,
                                        onChange: (e) => setTimeRounding(e.target.value),
                                        className: "w-full px-4 py-2 border border-soft-gray rounded-subtle focus:outline-none focus:border-eggplant"
                                    },
                                        React.createElement('option', { value: "none" }, "No rounding"),
                                        React.createElement('option', { value: "5" }, "Round up to nearest 5 minutes"),
                                        React.createElement('option', { value: "10" }, "Round up to nearest 10 minutes"),
                                        React.createElement('option', { value: "15" }, "Round up to nearest 15 minutes")
                                    )
                                ),

                                React.createElement('div', { className: "border-b border-soft-gray pb-6" },
                                    React.createElement('div', { className: "flex items-center justify-between mb-3" },
                                        React.createElement('h3', { className: "text-lg font-semibold text-eggplant" }, "Stop Timer on Idle"),
                                        React.createElement('label', { className: "relative inline-flex items-center cursor-pointer" },
                                            React.createElement('input', {
                                                type: "checkbox",
                                                checked: idleDetectionEnabled,
                                                onChange: (e) => setIdleDetectionEnabled(e.target.checked),
                                                className: "sr-only peer"
                                            }),
                                            React.createElement('div', { className: "w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-deep-green" })
                                        )
                                    ),
                                    React.createElement('p', { className: "text-sm text-gray-600 mb-3" }, "Automatically pause timer when you're idle, or when computer sleeps/shuts down/locks. Prevents over-billing for inactive time."),
                                    idleDetectionEnabled && React.createElement('div', { className: "flex items-center gap-3" },
                                        React.createElement('span', { className: "text-gray-700" }, "Pause after"),
                                        React.createElement('input', {
                                            type: "number",
                                            min: "5",
                                            max: "60",
                                            value: idleTimeoutMinutes,
                                            onChange: (e) => setIdleTimeoutMinutes(Math.max(5, Math.min(60, parseInt(e.target.value) || 10))),
                                            className: "w-20 px-4 py-2 border border-soft-gray rounded-subtle focus:outline-none focus:border-eggplant"
                                        }),
                                        React.createElement('span', { className: "text-gray-700" }, "minutes idle")
                                    )
                                ),

                                React.createElement('div', { className: "border-b border-soft-gray pb-6" },
                                    React.createElement('div', { className: "flex items-center justify-between mb-3" },
                                        React.createElement('h3', { className: "text-lg font-semibold text-eggplant" }, "Activity Reminders"),
                                        React.createElement('label', { className: "relative inline-flex items-center cursor-pointer" },
                                            React.createElement('input', {
                                                type: "checkbox",
                                                checked: activityReminderEnabled,
                                                onChange: (e) => setActivityReminderEnabled(e.target.checked),
                                                className: "sr-only peer"
                                            }),
                                            React.createElement('div', { className: "w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-deep-green" })
                                        )
                                    ),
                                    React.createElement('p', { className: "text-sm text-gray-600 mb-3" }, "Remind you to start tracking when you're working but the timer isn't running. Don't miss billable hours!"),
                                    activityReminderEnabled && React.createElement('div', { className: "flex items-center gap-3" },
                                        React.createElement('span', { className: "text-gray-700" }, "Remind every"),
                                        React.createElement('input', {
                                            type: "number",
                                            min: "10",
                                            max: "120",
                                            value: reminderIntervalMinutes,
                                            onChange: (e) => setReminderIntervalMinutes(Math.max(10, Math.min(120, parseInt(e.target.value) || 10))),
                                            className: "w-20 px-4 py-2 border border-soft-gray rounded-subtle focus:outline-none focus:border-eggplant"
                                        }),
                                        React.createElement('span', { className: "text-gray-700" }, "minutes")
                                    )
                                ),

                                React.createElement('div', { className: "border-b border-soft-gray pb-6" },
                                    React.createElement('div', { className: "flex items-center justify-between mb-3" },
                                        React.createElement('h3', { className: "text-lg font-semibold text-eggplant" }, "Daily Goal"),
                                        React.createElement('label', { className: "relative inline-flex items-center cursor-pointer" },
                                            React.createElement('input', {
                                                type: "checkbox",
                                                checked: dailyGoalEnabled,
                                                onChange: (e) => setDailyGoalEnabled(e.target.checked),
                                                className: "sr-only peer"
                                            }),
                                            React.createElement('div', { className: "w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-deep-green" })
                                        )
                                    ),
                                    React.createElement('p', { className: "text-sm text-gray-600 mb-3" }, "Set a daily hours target and track your progress"),
                                    dailyGoalEnabled && React.createElement('div', { className: "flex items-center gap-3" },
                                        React.createElement('input', {
                                            type: "number",
                                            min: "1",
                                            max: "24",
                                            value: dailyGoalHours,
                                            onChange: (e) => setDailyGoalHours(parseInt(e.target.value)),
                                            className: "w-20 px-4 py-2 border border-soft-gray rounded-subtle focus:outline-none focus:border-eggplant"
                                        }),
                                        React.createElement('span', { className: "text-gray-700" }, "hours per day")
                                    )
                                ),

                                React.createElement('div', { className: "border-t border-soft-gray pt-6 pb-6" },
                                    React.createElement('div', { className: "flex items-center justify-between mb-3" },
                                        React.createElement('h3', { className: "text-lg font-semibold text-eggplant" }, "Daily Progress"),
                                        React.createElement('label', { className: "relative inline-flex items-center cursor-pointer" },
                                            React.createElement('input', {
                                                type: "checkbox",
                                                checked: dailyProgressEnabled,
                                                onChange: (e) => setDailyProgressEnabled(e.target.checked),
                                                className: "sr-only peer"
                                            }),
                                            React.createElement('div', { className: "w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-deep-green" })
                                        )
                                    ),
                                    React.createElement('p', { className: "text-sm text-gray-600" }, "Show progress bar with hours worked today vs daily goal")
                                ),

                                React.createElement('div', { className: "border-t border-soft-gray pt-6 pb-6" },
                                    React.createElement('div', { className: "flex items-center justify-between mb-3" },
                                        React.createElement('h3', { className: "text-lg font-semibold text-eggplant" }, "Time Summary Widget"),
                                        React.createElement('label', { className: "relative inline-flex items-center cursor-pointer" },
                                            React.createElement('input', {
                                                type: "checkbox",
                                                checked: timeSummaryEnabled,
                                                onChange: (e) => setTimeSummaryEnabled(e.target.checked),
                                                className: "sr-only peer"
                                            }),
                                            React.createElement('div', { className: "w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-deep-green" })
                                        )
                                    ),
                                    React.createElement('p', { className: "text-sm text-gray-600" }, "Show daily, weekly, and monthly hour totals on Track Time page")
                                ),

                                React.createElement('div', { className: "border-t border-soft-gray pt-6 pb-6" },
                                    React.createElement('div', { className: "flex items-center justify-between mb-3" },
                                        React.createElement('h3', { className: "text-lg font-semibold text-eggplant" }, "Full Day Notification"),
                                        React.createElement('label', { className: "relative inline-flex items-center cursor-pointer" },
                                            React.createElement('input', {
                                                type: "checkbox",
                                                checked: fullDayNotificationEnabled,
                                                onChange: (e) => setFullDayNotificationEnabled(e.target.checked),
                                                className: "sr-only peer"
                                            }),
                                            React.createElement('div', { className: "w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-deep-green" })
                                        )
                                    ),
                                    React.createElement('p', { className: "text-sm text-gray-600" }, "Get notified after 8 hours of work to take a break")
                                ),

                                React.createElement('div', { className: "border-t border-soft-gray pt-6 pb-6" },
                                    React.createElement('div', { className: "flex items-center justify-between mb-3" },
                                        React.createElement('h3', { className: "text-lg font-semibold text-eggplant" }, "Hourly Break Reminder"),
                                        React.createElement('label', { className: "relative inline-flex items-center cursor-pointer" },
                                            React.createElement('input', {
                                                type: "checkbox",
                                                checked: hourlyBreakNotificationEnabled,
                                                onChange: (e) => setHourlyBreakNotificationEnabled(e.target.checked),
                                                className: "sr-only peer"
                                            }),
                                            React.createElement('div', { className: "w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-deep-green" })
                                        )
                                    ),
                                    React.createElement('p', { className: "text-sm text-gray-600" }, "Get reminded every hour to take a 5-minute break")
                                ),

                                React.createElement('div', { className: "pb-6" },
                                    React.createElement('div', { className: "flex items-center justify-between mb-3" },
                                        React.createElement('h3', { className: "text-lg font-semibold text-eggplant" }, "Floating Timer Window"),
                                        React.createElement('label', { className: "relative inline-flex items-center cursor-pointer" },
                                            React.createElement('input', {
                                                type: "checkbox",
                                                checked: floatingTimerEnabled,
                                                onChange: (e) => setFloatingTimerEnabled(e.target.checked),
                                                className: "sr-only peer"
                                            }),
                                            React.createElement('div', { className: "w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-deep-green" })
                                        )
                                    ),
                                    React.createElement('p', { className: "text-sm text-gray-600" }, "Show a small always-on-top window with timer while tracking")
                                )
                            )
                        )
                    ),

                    showFeedbackModal && React.createElement('div', {
                        className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",
                        onClick: () => setShowFeedbackModal(false)
                    },
                        React.createElement('div', {
                            className: "bg-white rounded-subtle p-8 max-w-lg w-full mx-4",
                            onClick: (e) => e.stopPropagation()
                        },
                            React.createElement('div', { className: "flex justify-between items-center mb-6" },
                                React.createElement('h2', { className: "text-2xl font-bold text-deep-green" }, "Send Feedback"),
                                React.createElement('button', {
                                    onClick: () => setShowFeedbackModal(false),
                                    className: "text-gray-400 hover:text-deep-green text-2xl"
                                }, "Ã—")
                            ),
                            React.createElement('div', { className: "space-y-4" },
                                React.createElement('div', null,
                                    React.createElement('label', { className: "block text-sm font-semibold text-gray-700 mb-2" }, "What type of feedback?"),
                                    React.createElement('select', {
                                        value: feedbackType,
                                        onChange: (e) => setFeedbackType(e.target.value),
                                        className: "w-full px-4 py-2 border border-soft-gray rounded-subtle focus:outline-none focus:border-deep-green"
                                    },
                                        React.createElement('option', { value: "suggestion" }, "ðŸ’¡ Suggestion"),
                                        React.createElement('option', { value: "bug" }, "ðŸ› Bug Report"),
                                        React.createElement('option', { value: "feature" }, "âœ¨ Feature Request"),
                                        React.createElement('option', { value: "other" }, "ðŸ’¬ Other")
                                    )
                                ),
                                React.createElement('div', null,
                                    React.createElement('label', { className: "block text-sm font-semibold text-gray-700 mb-2" }, "Your feedback"),
                                    React.createElement('textarea', {
                                        value: feedbackText,
                                        onChange: (e) => setFeedbackText(e.target.value),
                                        placeholder: "Tell us what you think...",
                                        rows: 6,
                                        className: "w-full px-4 py-2 border border-soft-gray rounded-subtle focus:outline-none focus:border-deep-green resize-none"
                                    })
                                ),
                                React.createElement('div', { className: "flex justify-end gap-3 pt-4" },
                                    React.createElement('button', {
                                        onClick: () => setShowFeedbackModal(false),
                                        className: "px-6 py-2 border border-soft-gray text-gray-700 rounded-subtle hover:bg-soft-gray transition-colors"
                                    }, "Cancel"),
                                    React.createElement('button', {
                                        onClick: () => {
                                            if (feedbackText.trim()) {
                                                const feedbackUrl = `https://docs.google.com/forms/d/e/1FAIpQLSeNFOTEUzh4y2cSDU9ndxzLFH066hQZRSZQOoGCSynuTuLI4w/viewform?usp=pp_url&entry.560510887=${encodeURIComponent(feedbackType)}&entry.1928926751=${encodeURIComponent(feedbackText)}`;
                                                require('electron').shell.openExternal(feedbackUrl);
                                                setFeedbackText('');
                                                setShowFeedbackModal(false);
                                                setActiveNotification({ type: 'success', message: 'Thank you for your feedback!' });
                                            }
                                        },
                                        disabled: !feedbackText.trim(),
                                        className: "px-6 py-2 bg-deep-green text-white rounded-subtle hover:bg-opacity-90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                    }, "Send Feedback")
                                )
                            )
                        )
                    ),

                    showUpdateCheckModal && React.createElement('div', {
                        className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",
                        onClick: () => setShowUpdateCheckModal(false)
                    },
                        React.createElement('div', {
                            className: "bg-white rounded-subtle p-8 max-w-md w-full mx-4",
                            onClick: (e) => e.stopPropagation()
                        },
                            React.createElement('div', { className: "flex justify-between items-center mb-6" },
                                React.createElement('h2', { className: "text-2xl font-bold text-deep-green" }, "Check for Updates"),
                                React.createElement('button', {
                                    onClick: () => setShowUpdateCheckModal(false),
                                    className: "text-gray-400 hover:text-deep-green text-2xl"
                                }, "Ã—")
                            ),
                            React.createElement('div', { className: "text-center py-4" },
                                React.createElement('p', { className: "text-gray-700" }, updateCheckMessage)
                            ),
                            React.createElement('div', { className: "flex justify-end pt-4" },
                                React.createElement('button', {
                                    onClick: () => setShowUpdateCheckModal(false),
                                    className: "px-6 py-2 bg-deep-green text-white rounded-subtle hover:bg-opacity-90 transition-colors"
                                }, "Close")
                            )
                        )
                    ),

                    showGuideModal && React.createElement('div', {
                        className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",
                        onClick: () => setShowGuideModal(false)
                    },
                        React.createElement('div', {
                            className: "bg-white rounded-subtle p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto",
                            onClick: (e) => e.stopPropagation()
                        },
                            React.createElement('div', { className: "flex justify-between items-center mb-6" },
                                React.createElement('h2', { className: "text-3xl font-bold text-eggplant" }, "Getting Started with ThymeSheet"),
                                React.createElement('button', {
                                    onClick: () => setShowGuideModal(false),
                                    className: "text-gray-400 hover:text-eggplant text-3xl leading-none"
                                }, "Ã—")
                            ),

                            React.createElement('div', { className: "space-y-8" },
                                React.createElement('section', null,
                                    React.createElement('h3', { className: "text-xl font-semibold text-deep-green mb-4 flex items-center gap-2" },
                                        React.createElement('span', { className: "bg-deep-green text-white w-8 h-8 rounded-full flex items-center justify-center text-sm" }, "1"),
                                        "Setting Up Your Projects"
                                    ),
                                    React.createElement('div', { className: "ml-10 space-y-3 text-gray-700" },
                                        React.createElement('p', { className: "leading-relaxed" }, "Before you can track time, you need to add your projects. ThymeSheet uses a 4-field structure for maximum organization:"),
                                        React.createElement('ul', { className: "list-disc ml-6 space-y-2" },
                                            React.createElement('li', null, React.createElement('strong', null, "Client Name:"), " The company or organization you're working for (e.g., \"Orbital\")"),
                                            React.createElement('li', null, React.createElement('strong', null, "Project/Admin Name:"), " The specific project or administrative category (e.g., \"O2-X Habitat Offsetting Plan\")"),
                                            React.createElement('li', null, React.createElement('strong', null, "Task Code:"), " The main task category (e.g., \"1. Meetings and Delivery\")"),
                                            React.createElement('li', null, React.createElement('strong', null, "Subtask Code:"), " The specific subtask (e.g., \"1.1 Project\")")
                                        ),
                                        React.createElement('div', { className: "bg-pearl p-4 rounded-subtle mt-4" },
                                            React.createElement('p', { className: "font-semibold text-eggplant mb-2" }, "ðŸ’¡ Quick Tip:"),
                                            React.createElement('p', null, "Navigate to ", React.createElement('strong', null, "View â†’ Manage Projects"), " or click the ", React.createElement('strong', null, "\"Manage Projects\""), " toggle to add projects one by one, or use ", React.createElement('strong', null, "\"Download Template\""), " to bulk import via CSV.")
                                        )
                                    )
                                ),

                                React.createElement('section', null,
                                    React.createElement('h3', { className: "text-xl font-semibold text-deep-green mb-4 flex items-center gap-2" },
                                        React.createElement('span', { className: "bg-deep-green text-white w-8 h-8 rounded-full flex items-center justify-center text-sm" }, "2"),
                                        "Tracking Your Time"
                                    ),
                                    React.createElement('div', { className: "ml-10 space-y-3 text-gray-700" },
                                        React.createElement('p', { className: "leading-relaxed" }, "Once your projects are set up, tracking time is simple:"),
                                        React.createElement('ol', { className: "list-decimal ml-6 space-y-2" },
                                            React.createElement('li', null, "Navigate to ", React.createElement('strong', null, "View â†’ Track Time"), " or click the ", React.createElement('strong', null, "\"Track Time\""), " toggle"),
                                            React.createElement('li', null, "Select your project from the dropdown menu"),
                                            React.createElement('li', null, "Optionally add a comment describing what you're working on"),
                                            React.createElement('li', null, "Click ", React.createElement('strong', { className: "text-deep-green" }, "\"Start Timer\""), " to begin tracking"),
                                            React.createElement('li', null, "When you're done, click ", React.createElement('strong', { className: "text-eggplant" }, "\"Stop Timer\""), " to save the entry")
                                        ),
                                        React.createElement('div', { className: "bg-pearl p-4 rounded-subtle mt-4" },
                                            React.createElement('p', { className: "font-semibold text-eggplant mb-2" }, "âš¡ Power Features:"),
                                            React.createElement('ul', { className: "list-disc ml-6 space-y-1" },
                                                React.createElement('li', null, React.createElement('strong', null, "Recent Projects:"), " Your last 10 projects appear at the top for quick access"),
                                                React.createElement('li', null, React.createElement('strong', null, "Quick Switch:"), " Use the dropdown in the running timer bar to switch projects without stopping"),
                                                React.createElement('li', null, React.createElement('strong', null, "Always Visible Timer:"), " The compact timer bar stays visible on both pages")
                                            )
                                        )
                                    )
                                ),

                                React.createElement('section', null,
                                    React.createElement('h3', { className: "text-xl font-semibold text-deep-green mb-4 flex items-center gap-2" },
                                        React.createElement('span', { className: "bg-deep-green text-white w-8 h-8 rounded-full flex items-center justify-center text-sm" }, "3"),
                                        "Keyboard Shortcuts"
                                    ),
                                    React.createElement('div', { className: "ml-10 space-y-3 text-gray-700" },
                                        React.createElement('p', { className: "leading-relaxed mb-3" }, "Work faster with these global hotkeys (work even when app is minimized):"),
                                        React.createElement('div', { className: "grid grid-cols-2 gap-4" },
                                            React.createElement('div', { className: "flex items-center gap-3 bg-soft-gray p-3 rounded-subtle" },
                                                React.createElement('kbd', { className: "px-3 py-2 bg-white border-2 border-gray-300 rounded font-mono text-sm" }, "Ctrl+Shift+Z"),
                                                React.createElement('span', null, "Show/Hide window")
                                            ),
                                            React.createElement('div', { className: "flex items-center gap-3 bg-soft-gray p-3 rounded-subtle" },
                                                React.createElement('kbd', { className: "px-3 py-2 bg-white border-2 border-gray-300 rounded font-mono text-sm" }, "Ctrl+Shift+Space"),
                                                React.createElement('span', null, "Start/Stop timer")
                                            ),
                                            React.createElement('div', { className: "flex items-center gap-3 bg-soft-gray p-3 rounded-subtle" },
                                                React.createElement('kbd', { className: "px-3 py-2 bg-white border-2 border-gray-300 rounded font-mono text-sm" }, "Ctrl+,"),
                                                React.createElement('span', null, "Open Settings")
                                            ),
                                            React.createElement('div', { className: "flex items-center gap-3 bg-soft-gray p-3 rounded-subtle" },
                                                React.createElement('kbd', { className: "px-3 py-2 bg-white border-2 border-gray-300 rounded font-mono text-sm" }, "Ctrl+H"),
                                                React.createElement('span', null, "Hide to tray")
                                            )
                                        )
                                    )
                                ),

                                React.createElement('section', null,
                                    React.createElement('h3', { className: "text-xl font-semibold text-deep-green mb-4 flex items-center gap-2" },
                                        React.createElement('span', { className: "bg-deep-green text-white w-8 h-8 rounded-full flex items-center justify-center text-sm" }, "4"),
                                        "Configuring Settings"
                                    ),
                                    React.createElement('div', { className: "ml-10 space-y-3 text-gray-700" },
                                        React.createElement('p', { className: "leading-relaxed mb-3" }, "Access ", React.createElement('strong', null, "Settings â†’ All Settings"), " from the menu to configure:"),
                                        React.createElement('div', { className: "space-y-3" },
                                            React.createElement('div', null,
                                                React.createElement('h4', { className: "font-semibold text-eggplant mb-1" }, "â±ï¸ Time Rounding"),
                                                React.createElement('p', null, "Automatically round up your time entries to 5, 10, or 15-minute intervals for cleaner billing. Perfect for hourly billing requirements.")
                                            ),
                                            React.createElement('div', null,
                                                React.createElement('h4', { className: "font-semibold text-eggplant mb-1" }, "â¸ï¸ Stop Timer on Idle"),
                                                React.createElement('p', null, "Automatically pauses timer when you're idle or when your computer sleeps/shuts down/locks. You can choose to resume tracking or assign the idle time to your project. Prevents accidental over-billing.")
                                            ),
                                            React.createElement('div', null,
                                                React.createElement('h4', { className: "font-semibold text-eggplant mb-1" }, "ðŸ”” Activity Reminders"),
                                                React.createElement('p', null, "Get reminded to start tracking when you're working but the timer isn't running. Helps you never miss billable hours! Configurable reminder interval.")
                                            ),
                                            React.createElement('div', null,
                                                React.createElement('h4', { className: "font-semibold text-eggplant mb-1" }, "ðŸŽ¯ Daily Goal"),
                                                React.createElement('p', null, "Set a target number of hours per day. ThymeSheet shows a live progress bar with your current hours, percentage complete, and hours remaining. Motivating and informative!")
                                            )
                                        )
                                    )
                                ),

                                React.createElement('section', null,
                                    React.createElement('h3', { className: "text-xl font-semibold text-deep-green mb-4 flex items-center gap-2" },
                                        React.createElement('span', { className: "bg-deep-green text-white w-8 h-8 rounded-full flex items-center justify-center text-sm" }, "5"),
                                        "Exporting Your Data"
                                    ),
                                    React.createElement('div', { className: "ml-10 space-y-3 text-gray-700" },
                                        React.createElement('p', { className: "leading-relaxed" }, "ThymeSheet provides flexible export options for your timesheet data:"),
                                        React.createElement('div', { className: "space-y-3" },
                                            React.createElement('div', null,
                                                React.createElement('h4', { className: "font-semibold text-eggplant mb-1" }, "ðŸ“Š CSV Export"),
                                                React.createElement('p', null, "Exports a detailed CSV with both a project summary and detailed entries. Filter by date range, client, or project before exporting.")
                                            ),
                                            React.createElement('div', null,
                                                React.createElement('h4', { className: "font-semibold text-eggplant mb-1" }, "ðŸ’¼ QuickBooks Online (QBO) Export"),
                                                React.createElement('p', null, "Exports in QBO-compatible format for easy import into QuickBooks. Includes service items, quantities, and customer mapping.")
                                            )
                                        ),
                                        React.createElement('div', { className: "bg-deep-green bg-opacity-10 border-l-4 border-deep-green p-4 rounded-subtle mt-4" },
                                            React.createElement('p', { className: "font-semibold text-deep-green mb-2" }, "ðŸ“ Pro Tip:"),
                                            React.createElement('p', null, "Use the date range filters to export specific billing periods. Comments are included in CSV exports, so add context to your time entries!")
                                        )
                                    )
                                ),

                                React.createElement('section', null,
                                    React.createElement('h3', { className: "text-xl font-semibold text-deep-green mb-4 flex items-center gap-2" },
                                        React.createElement('span', { className: "bg-deep-green text-white w-8 h-8 rounded-full flex items-center justify-center text-sm" }, "6"),
                                        "System Tray Integration"
                                    ),
                                    React.createElement('div', { className: "ml-10 space-y-3 text-gray-700" },
                                        React.createElement('p', { className: "leading-relaxed" }, "ThymeSheet lives in your system tray for always-available access:"),
                                        React.createElement('ul', { className: "list-disc ml-6 space-y-2" },
                                            React.createElement('li', null, React.createElement('strong', null, "Double-click the tray icon"), " to show/hide the window"),
                                            React.createElement('li', null, React.createElement('strong', null, "Right-click the tray icon"), " for quick actions:"),
                                            React.createElement('ul', { className: "list-circle ml-6 mt-1" },
                                                React.createElement('li', null, "Show ThymeSheet"),
                                                React.createElement('li', null, "Start/Stop Timer"),
                                                React.createElement('li', null, "Quit")
                                            ),
                                            React.createElement('li', null, "The app stays running in the tray even when you close the window, so you can quickly pop it back up with ", React.createElement('kbd', { className: "px-2 py-1 bg-soft-gray rounded text-sm" }, "Ctrl+Shift+Z"))
                                        )
                                    )
                                ),

                                React.createElement('section', { className: "border-t border-soft-gray pt-6" },
                                    React.createElement('h3', { className: "text-xl font-semibold text-eggplant mb-4" }, "ðŸ’¡ Best Practices"),
                                    React.createElement('div', { className: "space-y-2 text-gray-700" },
                                        React.createElement('ul', { className: "list-disc ml-6 space-y-2" },
                                            React.createElement('li', null, React.createElement('strong', null, "Set up all your projects at the start"), " to avoid interruptions during actual work"),
                                            React.createElement('li', null, React.createElement('strong', null, "Use descriptive comments"), " - your future self will thank you when reviewing entries"),
                                            React.createElement('li', null, React.createElement('strong', null, "Enable auto-pause"), " to prevent accidentally leaving the timer running"),
                                            React.createElement('li', null, React.createElement('strong', null, "Set a daily goal"), " to stay motivated and aware of your workload"),
                                            React.createElement('li', null, React.createElement('strong', null, "Export regularly"), " - weekly or bi-weekly exports make billing and invoicing smoother"),
                                            React.createElement('li', null, React.createElement('strong', null, "Use the Recent Projects"), " feature for recurring work - it saves valuable clicks!")
                                        )
                                    )
                                )
                            ),

                            React.createElement('div', { className: "mt-8 text-center" },
                                React.createElement('button', {
                                    onClick: () => setShowGuideModal(false),
                                    className: "px-8 py-3 bg-deep-green text-white rounded-subtle hover:bg-opacity-90 transition-all font-semibold"
                                }, "Got It!")
                            )
                        )
                    ),

                    storageError && React.createElement('div', { className: "mb-8 p-5 bg-white border-l-4 border-eggplant rounded-subtle shadow-sm" },
                        React.createElement('span', { className: "text-eggplant" }, storageError),
                        React.createElement('button', {
                            onClick: () => setStorageError(null),
                            className: "ml-3 text-eggplant hover:opacity-60 transition-opacity"
                        }, "Ã—")
                    ),

                    React.createElement('div', { className: "bg-white border-l-4 border-deep-green rounded-subtle shadow-sm mb-8" },
                        React.createElement('div', {
                            className: "flex justify-between items-center p-4 cursor-pointer hover:bg-off-white transition-colors",
                            onClick: () => setShortcutsExpanded(!shortcutsExpanded)
                        },
                            React.createElement('h3', { className: "text-sm font-semibold text-eggplant uppercase tracking-wider" }, "Keyboard Shortcuts"),
                            React.createElement('div', {
                                className: "transform transition-transform " + (shortcutsExpanded ? "" : "rotate-180")
                            }, React.createElement(ChevronDown))
                        ),
                        shortcutsExpanded && React.createElement('div', { className: "px-4 pb-4 border-t border-soft-gray pt-4" },
                            React.createElement('div', { className: "grid grid-cols-2 gap-6" },
                                React.createElement('div', null,
                                    React.createElement('h4', { className: "text-xs font-semibold text-deep-green mb-3 uppercase tracking-wide" }, "ðŸŒ Global (works anywhere)"),
                                    React.createElement('div', { className: "space-y-2 text-sm" },
                                        React.createElement('div', { className: "flex justify-between items-center" },
                                            React.createElement('span', { className: "text-gray-600" }, "Show/Hide window"),
                                            React.createElement('kbd', { className: "px-2 py-1 bg-soft-gray border border-gray-300 rounded text-eggplant text-xs font-mono" }, "Ctrl+Shift+Z")
                                        ),
                                        React.createElement('div', { className: "flex justify-between items-center" },
                                            React.createElement('span', { className: "text-gray-600" }, "Start/Stop timer"),
                                            React.createElement('kbd', { className: "px-2 py-1 bg-soft-gray border border-gray-300 rounded text-eggplant text-xs font-mono" }, "Ctrl+Shift+Space")
                                        )
                                    )
                                ),
                                React.createElement('div', null,
                                    React.createElement('h4', { className: "text-xs font-semibold text-deep-green mb-3 uppercase tracking-wide" }, "â±ï¸ Track Time Page"),
                                    React.createElement('div', { className: "space-y-2 text-sm" },
                                        React.createElement('div', { className: "flex justify-between items-center" },
                                            React.createElement('span', { className: "text-gray-600" }, "Select recent project"),
                                            React.createElement('kbd', { className: "px-2 py-1 bg-soft-gray border border-gray-300 rounded text-eggplant text-xs font-mono" }, "1-9, 0")
                                        ),
                                        React.createElement('div', { className: "flex justify-between items-center" },
                                            React.createElement('span', { className: "text-gray-600" }, "Start/Resume tracking"),
                                            React.createElement('kbd', { className: "px-2 py-1 bg-soft-gray border border-gray-300 rounded text-eggplant text-xs font-mono" }, "Enter")
                                        ),
                                        React.createElement('div', { className: "flex justify-between items-center" },
                                            React.createElement('span', { className: "text-gray-600" }, "Pause/Stop timer"),
                                            React.createElement('kbd', { className: "px-2 py-1 bg-soft-gray border border-gray-300 rounded text-eggplant text-xs font-mono" }, "Space")
                                        ),
                                        React.createElement('div', { className: "flex justify-between items-center" },
                                            React.createElement('span', { className: "text-gray-600" }, "Switch pages"),
                                            React.createElement('div', { className: "flex gap-1" },
                                                React.createElement('kbd', { className: "px-2 py-1 bg-soft-gray border border-gray-300 rounded text-eggplant text-xs font-mono" }, "â†"),
                                                React.createElement('kbd', { className: "px-2 py-1 bg-soft-gray border border-gray-300 rounded text-eggplant text-xs font-mono" }, "â†’")
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    ),
                    React.createElement('div', { className: "bg-white border-l-4 border-eggplant rounded-subtle p-10 mb-8 shadow-sm" },
                        React.createElement('h2', { className: "text-xl font-semibold text-eggplant mb-8" }, "Add a project and start tracking"),
                        React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" },
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-sm font-medium text-eggplant mb-3" }, "Client Name"),
                                React.createElement('input', {
                                    type: "text",
                                    value: newClientName,
                                    onChange: (e) => setNewClientName(e.target.value),
                                    placeholder: "Orbital",
                                    className: "w-full px-4 py-3 border-b-2 border-soft-gray focus:outline-none focus:border-eggplant bg-transparent text-gray-800 transition-colors"
                                })
                            ),
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-sm font-medium text-eggplant mb-3" }, "Project/Admin Name"),
                                React.createElement('input', {
                                    type: "text",
                                    value: newProjectName,
                                    onChange: (e) => setNewProjectName(e.target.value),
                                    placeholder: "O2-X Habitat Offsetting Plan",
                                    className: "w-full px-4 py-3 border-b-2 border-soft-gray focus:outline-none focus:border-eggplant bg-transparent text-gray-800 transition-colors"
                                })
                            ),
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-sm font-medium text-eggplant mb-3" }, "Task Code"),
                                React.createElement('input', {
                                    type: "text",
                                    value: newTaskCode,
                                    onChange: (e) => setNewTaskCode(e.target.value.toUpperCase()),
                                    placeholder: "1. Meetings and Delivery",
                                    className: "w-full px-4 py-3 border-b-2 border-soft-gray focus:outline-none focus:border-eggplant bg-transparent text-gray-800 transition-colors"
                                })
                            ),
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-sm font-medium text-eggplant mb-3" }, "Subtask Code"),
                                React.createElement('input', {
                                    type: "text",
                                    value: newSubtaskCode,
                                    onChange: (e) => setNewSubtaskCode(e.target.value.toUpperCase()),
                                    placeholder: "1.1 Project",
                                    className: "w-full px-4 py-3 border-b-2 border-soft-gray focus:outline-none focus:border-eggplant bg-transparent text-gray-800 transition-colors"
                                })
                            )
                        ),
                        React.createElement('div', { className: "flex gap-4" },
                            React.createElement('button', {
                                onClick: addProjectCode,
                                className: "flex items-center gap-2 px-6 py-3 bg-deep-green text-white rounded-subtle hover:bg-opacity-90 transition-all font-medium"
                            },
                                React.createElement(Plus),
                                "Add Project"
                            ),
                            React.createElement('button', {
                                onClick: addDemoData,
                                className: "px-6 py-3 border-2 border-eggplant text-eggplant rounded-subtle hover:bg-eggplant hover:text-white transition-all font-medium"
                            }, "Load Demo Data")
                        )
                    ),
                    React.createElement('div', { className: "flex items-center gap-4 mb-8" },
                        React.createElement('div', { className: "flex-1 h-px bg-soft-gray" }),
                        React.createElement('span', { className: "text-gray-500 text-sm uppercase tracking-wider" }, "or"),
                        React.createElement('div', { className: "flex-1 h-px bg-soft-gray" })
                    ),
                    React.createElement('div', { className: "bg-white border-l-4 border-deep-green rounded-subtle p-8 mb-8 shadow-sm" },
                        React.createElement('div', { className: "flex items-center gap-3 mb-6" },
                            React.createElement(Upload),
                            React.createElement('h3', { className: "text-xl font-semibold text-eggplant" }, "Bulk Import Projects from Spreadsheet")
                        ),
                        React.createElement('p', { className: "text-gray-700 mb-6 leading-relaxed" }, "Save time by importing multiple projects at once. Upload a CSV or Excel file with your project data."),

                        React.createElement('div', { className: "bg-soft-gray p-6 rounded-subtle mb-6" },
                            React.createElement('h4', { className: "font-semibold text-eggplant mb-3" }, "Required Format"),
                            React.createElement('p', { className: "text-sm text-gray-600 mb-4" }, "Your file must have exactly 4 columns in this order:"),
                            React.createElement('div', { className: "overflow-x-auto" },
                                React.createElement('table', { className: "w-full text-sm border-collapse" },
                                    React.createElement('thead', null,
                                        React.createElement('tr', { className: "bg-eggplant text-white" },
                                            React.createElement('th', { className: "px-4 py-2 text-left border border-gray-300" }, "Client Name"),
                                            React.createElement('th', { className: "px-4 py-2 text-left border border-gray-300" }, "Project/Admin Name"),
                                            React.createElement('th', { className: "px-4 py-2 text-left border border-gray-300" }, "Task Code"),
                                            React.createElement('th', { className: "px-4 py-2 text-left border border-gray-300" }, "Subtask Code")
                                        )
                                    ),
                                    React.createElement('tbody', null,
                                        React.createElement('tr', { className: "bg-white" },
                                            React.createElement('td', { className: "px-4 py-2 border border-gray-300" }, "Orbital"),
                                            React.createElement('td', { className: "px-4 py-2 border border-gray-300" }, "O2-X Habitat Offsetting Plan"),
                                            React.createElement('td', { className: "px-4 py-2 border border-gray-300" }, "1. Meetings and Delivery"),
                                            React.createElement('td', { className: "px-4 py-2 border border-gray-300" }, "1.1 Project")
                                        ),
                                        React.createElement('tr', { className: "bg-pearl" },
                                            React.createElement('td', { className: "px-4 py-2 border border-gray-300" }, "Orbital"),
                                            React.createElement('td', { className: "px-4 py-2 border border-gray-300" }, "O2-X Habitat Offsetting Plan"),
                                            React.createElement('td', { className: "px-4 py-2 border border-gray-300" }, "1. Meetings and Delivery"),
                                            React.createElement('td', { className: "px-4 py-2 border border-gray-300" }, "1.2 Internal")
                                        ),
                                        React.createElement('tr', { className: "bg-white" },
                                            React.createElement('td', { className: "px-4 py-2 border border-gray-300" }, "Orbital"),
                                            React.createElement('td', { className: "px-4 py-2 border border-gray-300" }, "O2-X Habitat Offsetting Plan"),
                                            React.createElement('td', { className: "px-4 py-2 border border-gray-300" }, "1. Meetings and Delivery"),
                                            React.createElement('td', { className: "px-4 py-2 border border-gray-300" }, "1.3 Regulatory")
                                        )
                                    )
                                )
                            )
                        ),

                        React.createElement('div', { className: "flex items-center gap-4 flex-wrap" },
                            React.createElement('button', {
                                onClick: browseCSVFile,
                                className: 'flex items-center gap-2 px-6 py-3 bg-deep-green text-white rounded-subtle hover:bg-opacity-90 transition-all font-medium'
                            },
                                React.createElement(FolderOpen),
                                "Browse File"
                            ),
                            React.createElement('button', {
                                onClick: downloadCSVTemplate,
                                className: 'flex items-center gap-2 px-6 py-3 border-2 border-deep-green text-deep-green rounded-subtle hover:bg-deep-green hover:text-white transition-all font-medium'
                            },
                                React.createElement(Download),
                                "Download Template"
                            )
                        ),
                        linkedCSVPath && React.createElement('div', { className: "mt-4 p-4 bg-soft-gray rounded-subtle" },
                            React.createElement('p', { className: "text-sm text-gray-700 mb-2" },
                                React.createElement('strong', null, "Linked File: "),
                                linkedCSVPath
                            ),
                            React.createElement('button', {
                                onClick: refreshFromCSV,
                                className: 'flex items-center gap-2 px-4 py-2 bg-eggplant text-white rounded-subtle hover:bg-opacity-90 transition-all font-medium text-sm'
                            },
                                React.createElement(RefreshCw),
                                "Refresh Projects from File"
                            )
                        )
                    ),
                    projectCodes.length > 0 && React.createElement('div', { className: "mb-8" },
                        React.createElement('div', { className: "flex items-center justify-between mb-6" },
                            React.createElement('h2', { className: "text-xl font-semibold text-eggplant" }, "Your Projects")
                        ),
                        React.createElement('div', { className: "mb-5" },
                            React.createElement('div', { className: "relative" },
                                React.createElement('input', {
                                    type: 'text',
                                    value: projectSearchTerm,
                                    onChange: (e) => setProjectSearchTerm(e.target.value),
                                    placeholder: 'Search by client, project, or code...',
                                    className: 'w-full px-4 py-3 border border-soft-gray rounded-subtle focus:outline-none focus:border-eggplant bg-white text-gray-800 transition-colors'
                                }),
                                projectSearchTerm && React.createElement('button', {
                                    onClick: () => setProjectSearchTerm(''),
                                    className: 'absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-eggplant text-xl'
                                }, 'Ã—')
                            )
                        ),
                        React.createElement('div', { className: "space-y-3" },
                            Object.entries(organizeProjectsByHierarchy()).map(([clientName, clientProjects]) =>
                                React.createElement('div', { key: clientName, className: "bg-white border border-soft-gray rounded-subtle overflow-hidden" },
                                    React.createElement('div', { className: "flex items-center" },
                                        React.createElement('button', {
                                            onClick: () => toggleClient(clientName),
                                            className: "flex-1 flex items-center justify-between p-4 bg-pearl hover:bg-opacity-70 transition-colors text-left"
                                        },
                                            React.createElement('div', { className: "flex items-center gap-2" },
                                                React.createElement(Building),
                                                React.createElement('span', { className: "font-semibold text-eggplant" }, clientName)
                                            ),
                                            React.createElement('div', { className: "flex items-center gap-3" },
                                                React.createElement('span', { className: "text-sm text-gray-600" },
                                                    Object.keys(clientProjects).length + " project" + (Object.keys(clientProjects).length !== 1 ? 's' : '')
                                                ),
                                                React.createElement('span', { className: "text-sm text-eggplant" },
                                                    expandedClients[clientName] ? 'â–¼' : 'â–¶'
                                                )
                                            )
                                        ),
                                        React.createElement('button', {
                                            onClick: (e) => {
                                                e.stopPropagation();
                                                deleteAllByClient(clientName);
                                            },
                                            className: "p-4 text-gray-400 hover:text-eggplant transition-colors",
                                            title: "Delete all projects for this client"
                                        }, React.createElement(Trash2))
                                    ),
                                    expandedClients[clientName] && React.createElement('div', { className: "p-2 bg-white space-y-2" },
                                        Object.entries(clientProjects).map(([projectName, projectTasks]) =>
                                            React.createElement('div', { key: clientName + "-" + projectName, className: "border border-soft-gray rounded-subtle overflow-hidden" },
                                                React.createElement('div', { className: "flex items-center" },
                                                    React.createElement('button', {
                                                        onClick: () => toggleProject(clientName, projectName),
                                                        className: "flex-1 flex items-center justify-between p-3 bg-off-white hover:bg-soft-gray transition-colors text-left"
                                                    },
                                                        React.createElement('div', { className: "flex items-center gap-2" },
                                                            React.createElement(Folder),
                                                            React.createElement('span', { className: "font-medium text-deep-green" }, projectName)
                                                        ),
                                                        React.createElement('div', { className: "flex items-center gap-2" },
                                                            React.createElement('span', { className: "text-sm text-gray-600" },
                                                                Object.keys(projectTasks).length + " task" + (Object.keys(projectTasks).length !== 1 ? 's' : '')
                                                            ),
                                                            React.createElement('span', { className: "text-sm text-deep-green" },
                                                                expandedProjects[clientName + "::" + projectName] ? 'â–¼' : 'â–¶'
                                                            )
                                                        )
                                                    ),
                                                    React.createElement('button', {
                                                        onClick: (e) => {
                                                            e.stopPropagation();
                                                            deleteAllByProject(clientName, projectName);
                                                        },
                                                        className: "p-3 text-gray-400 hover:text-deep-green transition-colors",
                                                        title: "Delete all codes for this project"
                                                    }, React.createElement(Trash2))
                                                ),
                                                expandedProjects[clientName + "::" + projectName] && React.createElement('div', { className: "p-2 bg-white space-y-2" },
                                                    // Add Task button
                                                    showAddTaskForm !== (clientName + "::" + projectName) && React.createElement('button', {
                                                        onClick: () => {
                                                            setShowAddTaskForm(clientName + "::" + projectName);
                                                            setInlineTaskCode('');
                                                        },
                                                        className: "w-full flex items-center justify-center gap-2 p-3 border-2 border-dashed border-deep-green text-deep-green rounded-subtle hover:bg-pearl transition-colors"
                                                    },
                                                        React.createElement(Plus),
                                                        React.createElement('span', { className: "font-medium" }, "Add Task")
                                                    ),
                                                    // Add Task form
                                                    showAddTaskForm === (clientName + "::" + projectName) && React.createElement('div', { className: "border-2 border-deep-green rounded-subtle p-3 bg-pearl" },
                                                        React.createElement('div', { className: "flex gap-2" },
                                                            React.createElement('input', {
                                                                type: "text",
                                                                value: inlineTaskCode,
                                                                onChange: (e) => setInlineTaskCode(e.target.value.toUpperCase()),
                                                                placeholder: "Enter task code (e.g., 1. MEETINGS)",
                                                                className: "flex-1 px-3 py-2 border border-soft-gray rounded focus:outline-none focus:border-deep-green",
                                                                autoFocus: true,
                                                                onKeyPress: (e) => {
                                                                    if (e.key === 'Enter') {
                                                                        addInlineTask(clientName, projectName);
                                                                    }
                                                                }
                                                            }),
                                                            React.createElement('button', {
                                                                onClick: () => addInlineTask(clientName, projectName),
                                                                className: "px-4 py-2 bg-deep-green text-white rounded hover:bg-opacity-90 transition-colors font-medium"
                                                            }, "Add"),
                                                            React.createElement('button', {
                                                                onClick: () => {
                                                                    setShowAddTaskForm(null);
                                                                    setInlineTaskCode('');
                                                                },
                                                                className: "px-4 py-2 border border-gray-300 text-gray-600 rounded hover:bg-gray-100 transition-colors"
                                                            }, "Cancel")
                                                        )
                                                    ),
                                                    Object.entries(projectTasks).map(([taskCode, subtasks]) =>
                                                        React.createElement('div', { key: clientName + "-" + projectName + "-" + taskCode, className: "border border-soft-gray rounded-subtle overflow-hidden" },
                                                            React.createElement('button', {
                                                                onClick: () => toggleTask(clientName, projectName, taskCode),
                                                                className: "w-full flex items-center justify-between p-3 bg-pearl hover:bg-opacity-70 transition-colors text-left"
                                                            },
                                                                React.createElement('div', { className: "flex items-center gap-2" },
                                                                    React.createElement(Tag),
                                                                    React.createElement('span', { className: "font-medium text-eggplant" }, 'Task: ' + taskCode)
                                                                ),
                                                                React.createElement('div', { className: "flex items-center gap-2" },
                                                                    React.createElement('span', { className: "text-sm text-gray-600" },
                                                                        subtasks.length + " subtask" + (subtasks.length !== 1 ? 's' : '')
                                                                    ),
                                                                    React.createElement('span', { className: "text-sm text-eggplant" },
                                                                        expandedTasks[clientName + "::" + projectName + "::" + taskCode] ? 'â–¼' : 'â–¶'
                                                                    )
                                                                )
                                                            ),
                                                            expandedTasks[clientName + "::" + projectName + "::" + taskCode] && React.createElement('div', { className: "space-y-1 p-2 bg-white" },
                                                                subtasks.map((project) =>
                                                                    React.createElement('div', {
                                                                        key: project.id,
                                                                        className: 'flex items-center justify-between p-3 bg-off-white border-l-4 border-transparent rounded-subtle'
                                                                    },
                                                                        React.createElement('div', { className: "flex-1" },
                                                                            React.createElement('div', { className: "flex items-center gap-2" },
                                                                                React.createElement(Bookmark),
                                                                                React.createElement('span', { className: "font-semibold text-deep-green" }, project.subtaskCode),
                                                                                React.createElement('span', { className: "text-xs px-2 py-0.5 bg-soft-gray text-gray-600 rounded" }, project.code)
                                                                            )
                                                                        ),
                                                                        React.createElement('button', {
                                                                            onClick: () => deleteProjectCode(project.id),
                                                                            className: "text-gray-400 hover:text-eggplant transition-colors ml-3"
                                                                        }, React.createElement(Trash2))
                                                                    )
                                                                ),
                                                                // Add Subtask button
                                                                showAddSubtaskForm !== (clientName + "::" + projectName + "::" + taskCode) && React.createElement('button', {
                                                                    onClick: () => {
                                                                        setShowAddSubtaskForm(clientName + "::" + projectName + "::" + taskCode);
                                                                        setInlineSubtaskCode('');
                                                                    },
                                                                    className: "w-full flex items-center justify-center gap-2 p-2 mt-1 border-2 border-dashed border-eggplant text-eggplant rounded-subtle hover:bg-pearl transition-colors text-sm"
                                                                },
                                                                    React.createElement(Plus),
                                                                    React.createElement('span', { className: "font-medium" }, "Add Subtask")
                                                                ),
                                                                // Add Subtask form
                                                                showAddSubtaskForm === (clientName + "::" + projectName + "::" + taskCode) && React.createElement('div', { className: "border-2 border-eggplant rounded-subtle p-2 mt-1 bg-pearl" },
                                                                    React.createElement('div', { className: "flex gap-2" },
                                                                        React.createElement('input', {
                                                                            type: "text",
                                                                            value: inlineSubtaskCode,
                                                                            onChange: (e) => setInlineSubtaskCode(e.target.value.toUpperCase()),
                                                                            placeholder: "Enter subtask code (e.g., 1.1 Project)",
                                                                            className: "flex-1 px-3 py-2 border border-soft-gray rounded focus:outline-none focus:border-eggplant text-sm",
                                                                            autoFocus: true,
                                                                            onKeyPress: (e) => {
                                                                                if (e.key === 'Enter') {
                                                                                    addInlineSubtask(clientName, projectName, taskCode);
                                                                                }
                                                                            }
                                                                        }),
                                                                        React.createElement('button', {
                                                                            onClick: () => addInlineSubtask(clientName, projectName, taskCode),
                                                                            className: "px-3 py-2 bg-eggplant text-white rounded hover:bg-opacity-90 transition-colors font-medium text-sm"
                                                                        }, "Add"),
                                                                        React.createElement('button', {
                                                                            onClick: () => {
                                                                                setShowAddSubtaskForm(null);
                                                                                setInlineSubtaskCode('');
                                                                            },
                                                                            className: "px-3 py-2 border border-gray-300 text-gray-600 rounded hover:bg-gray-100 transition-colors text-sm"
                                                                        }, "Cancel")
                                                                    )
                                                                )
                                                            )
                                                        )
                                                    )
                                                )
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    ),
                    projectCodes.length > 0 && React.createElement('div', { className: "text-center pt-6" },
                        React.createElement('button', {
                            onClick: () => setShowSetup(false),
                            className: "px-10 py-4 bg-deep-green text-white text-base font-semibold rounded-subtle hover:bg-opacity-90 transition-all shadow-md"
                        }, "Start Tracking")
                    )
                    ),
                    // Notification Toast for Manage Projects page
                    activeNotification && React.createElement('div', {
                        className: "fixed bottom-4 right-4 z-50"
                    },
                        React.createElement('div', {
                            className: "bg-white border-l-4 rounded-subtle shadow-xl p-4 max-w-sm flex items-start gap-3 " + (activeNotification.type === 'success' ? "border-deep-green" : "border-eggplant")
                        },
                            React.createElement('div', { className: "flex-1" },
                                React.createElement('p', { className: "text-sm text-gray-800" }, activeNotification.message)
                            ),
                            React.createElement('button', {
                                onClick: () => setActiveNotification(null),
                                className: "text-gray-400 hover:text-gray-600 transition-colors text-xl leading-none"
                            }, "Ã—")
                        )
                    )
                );
            }

            return React.createElement('div', { className: "min-h-screen" },
                // Update notification banner
                (updateAvailable || updateDownloaded) && React.createElement('div', {
                    className: "sticky top-0 z-50 mb-6 bg-blue-50 border-2 border-blue-400 rounded-subtle shadow-md max-w-7xl mx-auto"
                },
                    React.createElement('div', { className: "p-4 flex items-center justify-between gap-4" },
                        React.createElement('div', { className: "flex items-center gap-3" },
                            React.createElement(Download),
                            React.createElement('div', null,
                                React.createElement('div', { className: "text-sm font-semibold text-blue-900" },
                                    updateDownloaded ? 'Update Ready to Install' : 'Update Available'
                                ),
                                React.createElement('div', { className: "text-xs text-blue-700" },
                                    updateDownloaded
                                        ? 'A new version has been downloaded and is ready to install. Click "Restart & Update" to update.'
                                        : updateInfo ? `Version ${updateInfo.version} is available. Click "Download" to update.` : 'A new version is available.'
                                ),
                                isDownloading && downloadProgress > 0 && React.createElement('div', { className: "mt-2" },
                                    React.createElement('div', { className: "w-64 bg-gray-200 rounded-full h-2" },
                                        React.createElement('div', {
                                            className: "bg-blue-600 h-2 rounded-full transition-all",
                                            style: { width: `${downloadProgress}%` }
                                        })
                                    ),
                                    React.createElement('div', { className: "text-xs text-blue-600 mt-1" },
                                        `Downloading... ${Math.round(downloadProgress)}%`
                                    )
                                )
                            )
                        ),
                        React.createElement('div', { className: "flex items-center gap-2" },
                            !updateDownloaded && !isDownloading && React.createElement('button', {
                                onClick: handleDownloadUpdate,
                                className: "px-4 py-2 text-sm bg-blue-600 text-white rounded-subtle hover:bg-blue-700 transition-colors font-medium"
                            }, "Download Update"),
                            updateDownloaded && React.createElement('button', {
                                onClick: handleInstallUpdate,
                                className: "px-4 py-2 text-sm bg-blue-600 text-white rounded-subtle hover:bg-blue-700 transition-colors font-medium"
                            }, "Restart & Update"),
                            React.createElement('button', {
                                onClick: handleDismissUpdate,
                                className: "px-3 py-2 text-sm border border-blue-300 text-blue-700 rounded-subtle hover:bg-blue-100 transition-colors"
                            }, "Later")
                        )
                    )
                ),
                isTracking && currentSession && React.createElement('div', { className: "sticky top-0 z-50 mb-6 bg-white border-2 border-deep-green rounded-subtle shadow-md max-w-7xl mx-auto" },
                    React.createElement('div', { className: "p-3 flex items-center justify-between gap-4" },
                        React.createElement('div', { className: "flex items-center gap-3" },
                            React.createElement('div', { className: "w-2 h-2 bg-deep-green rounded-full animate-pulse" }),
                            React.createElement('div', { className: "text-xl font-mono font-semibold text-deep-green tabular-nums" }, formatTime(elapsedTime))
                        ),
                        React.createElement('div', { className: "flex-1 text-sm text-gray-700 truncate" },
                            React.createElement('span', { className: "font-semibold text-deep-green" }, currentSession.projectCode)
                        ),
                        React.createElement('div', { className: "flex items-center gap-2" },
                            React.createElement('select', {
                                key: currentSession ? currentSession.projectId : 'no-session',
                                value: "",
                                onChange: (e) => {
                                    const value = e.target.value;
                                    console.log('Dropdown changed, value:', value);
                                    if (value && value !== "") {
                                        const projectId = parseInt(value);
                                        console.log('Switching to project ID:', projectId);
                                        if (!isNaN(projectId)) {
                                            switchProject(projectId);
                                        }
                                    }
                                },
                                className: "px-3 py-1.5 text-xs border border-soft-gray rounded-subtle bg-white text-gray-700 hover:border-deep-green focus:outline-none focus:border-deep-green transition-colors cursor-pointer"
                            },
                                React.createElement('option', { value: "" }, "Switch to..."),
                                (() => {
                                    const availableProjects = projectCodes.filter(p => p.id !== currentSession.projectId);
                                    const recentAvailable = recentProjects
                                        .filter(id => id !== currentSession.projectId)
                                        .map(id => availableProjects.find(p => p.id === id))
                                        .filter(p => p);
                                    const otherProjects = availableProjects.filter(p => !recentProjects.includes(p.id));

                                    let result = [];

                                    // Add recent projects with marker
                                    if (recentAvailable.length > 0) {
                                        result.push(React.createElement('option', { key: 'recent-header', disabled: true, style: { fontWeight: 'bold' } }, 'â”€â”€ Recent Projects â”€â”€'));
                                        recentAvailable.slice(0, 9).forEach(project => {
                                            result.push(React.createElement('option', { key: project.id, value: project.id }, 'â­ ' + project.code));
                                        });
                                    }

                                    // Add separator and other projects
                                    if (otherProjects.length > 0) {
                                        if (recentAvailable.length > 0) {
                                            result.push(React.createElement('option', { key: 'other-header', disabled: true, style: { fontWeight: 'bold' } }, 'â”€â”€ All Projects â”€â”€'));
                                        }
                                        otherProjects.forEach(project => {
                                            result.push(React.createElement('option', { key: project.id, value: project.id }, project.code));
                                        });
                                    }

                                    return result;
                                })()
                            ),
                            React.createElement('button', {
                                onClick: stopTracking,
                                className: "flex items-center gap-1.5 px-3 py-1.5 bg-deep-green text-white rounded-subtle hover:bg-opacity-90 transition-all font-medium text-xs"
                            },
                                React.createElement(Square, { size: 14 }),
                                "Stop"
                            )
                        )
                    ),
                    React.createElement('div', { className: "px-3 pb-3 pt-0 border-t border-soft-gray" },
                        React.createElement('input', {
                            type: "text",
                            value: currentComment,
                            onChange: (e) => setCurrentComment(e.target.value),
                            placeholder: "Add comment (optional)...",
                            className: "w-full px-3 py-1.5 text-xs border border-soft-gray rounded-subtle focus:outline-none focus:border-deep-green bg-white text-gray-700"
                        })
                    )
                ),
                React.createElement('div', { className: "sticky top-0 z-40 bg-white border-b border-soft-gray shadow-sm mb-10" },
                    React.createElement('div', { className: "max-w-7xl mx-auto px-4 sm:px-8 flex flex-wrap justify-between items-center py-4 gap-4" },
                        React.createElement('div', { className: "bg-white rounded px-2 py-1 flex-shrink-0" },
                            React.createElement('img', {
                                src: "logo.png",
                                alt: "Timesheet Logo",
                                className: "h-12 sm:h-16 w-auto"
                            })
                        ),
                        React.createElement('div', { className: "flex items-center gap-2 sm:gap-3 flex-wrap" },
                            React.createElement('button', {
                                onClick: () => setShowFeedbackModal(true),
                                className: "p-2 text-gray-500 hover:text-deep-green hover:bg-soft-gray rounded-full transition-all",
                                title: "Send Feedback"
                            },
                                React.createElement(MessageSquare)
                            ),
                            React.createElement('div', { className: "inline-flex bg-soft-gray rounded-full p-1" },
                                React.createElement('button', {
                                    onClick: () => setShowSetup(false),
                                    className: "flex items-center gap-2 px-6 py-2 rounded-full transition-all font-medium " + (!showSetup ? "bg-deep-green text-white" : "text-gray-600 hover:text-gray-800")
                                },
                                    React.createElement(Clock),
                                    "Track Time"
                                ),
                                React.createElement('button', {
                                    onClick: () => setShowSetup(true),
                                    className: "flex items-center gap-2 px-6 py-2 rounded-full transition-all font-medium " + (showSetup ? "bg-eggplant text-white" : "text-gray-600 hover:text-gray-800")
                                },
                                    React.createElement(Building),
                                    "Manage Projects"
                                )
                            )
                        )
                    )
                ),
                React.createElement('div', { className: "max-w-7xl mx-auto px-8 pb-8" },

                showSettingsMenu && React.createElement('div', {
                    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",
                    onClick: () => setShowSettingsMenu(false)
                },
                    React.createElement('div', {
                        className: "bg-white rounded-subtle p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto",
                        onClick: (e) => e.stopPropagation()
                    },
                        React.createElement('div', { className: "flex justify-between items-center mb-6" },
                            React.createElement('div', null,
                                React.createElement('h2', { className: "text-2xl font-bold text-eggplant" }, "Settings"),
                                React.createElement('p', { className: "text-xs text-gray-500 mt-1" }, "ThymeSheet v2.0.3")
                            ),
                            React.createElement('button', {
                                onClick: () => setShowSettingsMenu(false),
                                className: "text-gray-400 hover:text-eggplant text-2xl"
                            }, "Ã—")
                        ),

                        React.createElement('div', { className: "space-y-6" },
                            React.createElement('div', { className: "border-b border-soft-gray pb-6" },
                                React.createElement('h3', { className: "text-lg font-semibold text-eggplant mb-3" }, "Time Rounding"),
                                React.createElement('p', { className: "text-sm text-gray-600 mb-3" }, "Automatically round up time entries for cleaner billing"),
                                React.createElement('select', {
                                    value: timeRounding,
                                    onChange: (e) => setTimeRounding(e.target.value),
                                    className: "w-full px-4 py-2 border border-soft-gray rounded-subtle focus:outline-none focus:border-eggplant"
                                },
                                    React.createElement('option', { value: "none" }, "No rounding"),
                                    React.createElement('option', { value: "5" }, "Round up to nearest 5 minutes"),
                                    React.createElement('option', { value: "10" }, "Round up to nearest 10 minutes"),
                                    React.createElement('option', { value: "15" }, "Round up to nearest 15 minutes")
                                )
                            ),

                            React.createElement('div', { className: "border-b border-soft-gray pb-6" },
                                React.createElement('div', { className: "flex items-center justify-between mb-3" },
                                    React.createElement('h3', { className: "text-lg font-semibold text-eggplant" }, "Stop Timer on Idle"),
                                    React.createElement('label', { className: "relative inline-flex items-center cursor-pointer" },
                                        React.createElement('input', {
                                            type: "checkbox",
                                            checked: idleDetectionEnabled,
                                            onChange: (e) => setIdleDetectionEnabled(e.target.checked),
                                            className: "sr-only peer"
                                        }),
                                        React.createElement('div', { className: "w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-deep-green" })
                                    )
                                ),
                                React.createElement('p', { className: "text-sm text-gray-600 mb-3" }, "Automatically pause timer when you're idle, or when computer sleeps/shuts down/locks. Prevents over-billing for inactive time."),
                                idleDetectionEnabled && React.createElement('div', { className: "flex items-center gap-3" },
                                    React.createElement('span', { className: "text-gray-700" }, "Pause after"),
                                    React.createElement('input', {
                                        type: "number",
                                        min: "5",
                                        max: "60",
                                        value: idleTimeoutMinutes,
                                        onChange: (e) => setIdleTimeoutMinutes(Math.max(5, Math.min(60, parseInt(e.target.value) || 10))),
                                        className: "w-20 px-4 py-2 border border-soft-gray rounded-subtle focus:outline-none focus:border-eggplant"
                                    }),
                                    React.createElement('span', { className: "text-gray-700" }, "minutes idle")
                                )
                            ),

                            React.createElement('div', { className: "border-b border-soft-gray pb-6" },
                                React.createElement('div', { className: "flex items-center justify-between mb-3" },
                                    React.createElement('h3', { className: "text-lg font-semibold text-eggplant" }, "Activity Reminders"),
                                    React.createElement('label', { className: "relative inline-flex items-center cursor-pointer" },
                                        React.createElement('input', {
                                            type: "checkbox",
                                            checked: activityReminderEnabled,
                                            onChange: (e) => setActivityReminderEnabled(e.target.checked),
                                            className: "sr-only peer"
                                        }),
                                        React.createElement('div', { className: "w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-deep-green" })
                                    )
                                ),
                                React.createElement('p', { className: "text-sm text-gray-600 mb-3" }, "Remind you to start tracking when you're working but the timer isn't running. Don't miss billable hours!"),
                                activityReminderEnabled && React.createElement('div', { className: "flex items-center gap-3" },
                                    React.createElement('span', { className: "text-gray-700" }, "Remind every"),
                                    React.createElement('input', {
                                        type: "number",
                                        min: "10",
                                        max: "120",
                                        value: reminderIntervalMinutes,
                                        onChange: (e) => setReminderIntervalMinutes(Math.max(10, Math.min(120, parseInt(e.target.value) || 10))),
                                        className: "w-20 px-4 py-2 border border-soft-gray rounded-subtle focus:outline-none focus:border-eggplant"
                                    }),
                                    React.createElement('span', { className: "text-gray-700" }, "minutes")
                                )
                            ),

                            React.createElement('div', { className: "border-b border-soft-gray pb-6" },
                                React.createElement('div', { className: "flex items-center justify-between mb-3" },
                                    React.createElement('h3', { className: "text-lg font-semibold text-eggplant" }, "Daily Goal"),
                                    React.createElement('label', { className: "relative inline-flex items-center cursor-pointer" },
                                        React.createElement('input', {
                                            type: "checkbox",
                                            checked: dailyGoalEnabled,
                                            onChange: (e) => setDailyGoalEnabled(e.target.checked),
                                            className: "sr-only peer"
                                        }),
                                        React.createElement('div', { className: "w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-deep-green" })
                                    )
                                ),
                                React.createElement('p', { className: "text-sm text-gray-600 mb-3" }, "Set a daily hours target and track your progress"),
                                dailyGoalEnabled && React.createElement('div', { className: "flex items-center gap-3" },
                                    React.createElement('input', {
                                        type: "number",
                                        min: "1",
                                        max: "24",
                                        value: dailyGoalHours,
                                        onChange: (e) => setDailyGoalHours(parseInt(e.target.value)),
                                        className: "w-20 px-4 py-2 border border-soft-gray rounded-subtle focus:outline-none focus:border-eggplant"
                                    }),
                                    React.createElement('span', { className: "text-gray-700" }, "hours per day")
                                )
                            ),

                            React.createElement('div', { className: "border-t border-soft-gray pt-6 pb-6" },
                                React.createElement('div', { className: "flex items-center justify-between mb-3" },
                                    React.createElement('h3', { className: "text-lg font-semibold text-eggplant" }, "Daily Progress"),
                                    React.createElement('label', { className: "relative inline-flex items-center cursor-pointer" },
                                        React.createElement('input', {
                                            type: "checkbox",
                                            checked: dailyProgressEnabled,
                                            onChange: (e) => setDailyProgressEnabled(e.target.checked),
                                            className: "sr-only peer"
                                        }),
                                        React.createElement('div', { className: "w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-deep-green" })
                                    )
                                ),
                                React.createElement('p', { className: "text-sm text-gray-600" }, "Show progress bar with hours worked today vs daily goal")
                            ),

                            React.createElement('div', { className: "border-t border-soft-gray pt-6 pb-6" },
                                React.createElement('div', { className: "flex items-center justify-between mb-3" },
                                    React.createElement('h3', { className: "text-lg font-semibold text-eggplant" }, "Time Summary Widget"),
                                    React.createElement('label', { className: "relative inline-flex items-center cursor-pointer" },
                                        React.createElement('input', {
                                            type: "checkbox",
                                            checked: timeSummaryEnabled,
                                            onChange: (e) => setTimeSummaryEnabled(e.target.checked),
                                            className: "sr-only peer"
                                        }),
                                        React.createElement('div', { className: "w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-deep-green" })
                                    )
                                ),
                                React.createElement('p', { className: "text-sm text-gray-600" }, "Show daily, weekly, and monthly hour totals on Track Time page")
                            ),

                            React.createElement('div', { className: "border-t border-soft-gray pt-6 pb-6" },
                                React.createElement('div', { className: "flex items-center justify-between mb-3" },
                                    React.createElement('h3', { className: "text-lg font-semibold text-eggplant" }, "Recent Projects"),
                                    React.createElement('label', { className: "relative inline-flex items-center cursor-pointer" },
                                        React.createElement('input', {
                                            type: "checkbox",
                                            checked: recentProjectsEnabled,
                                            onChange: (e) => setRecentProjectsEnabled(e.target.checked),
                                            className: "sr-only peer"
                                        }),
                                        React.createElement('div', { className: "w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-deep-green" })
                                    )
                                ),
                                React.createElement('p', { className: "text-sm text-gray-600" }, "Show your 10 most recent projects on Track Time page for quick access")
                            ),

                            React.createElement('div', { className: "border-t border-soft-gray pt-6 pb-6" },
                                React.createElement('div', { className: "flex items-center justify-between mb-3" },
                                    React.createElement('h3', { className: "text-lg font-semibold text-eggplant" }, "Full Day Notification"),
                                    React.createElement('label', { className: "relative inline-flex items-center cursor-pointer" },
                                        React.createElement('input', {
                                            type: "checkbox",
                                            checked: fullDayNotificationEnabled,
                                            onChange: (e) => setFullDayNotificationEnabled(e.target.checked),
                                            className: "sr-only peer"
                                        }),
                                        React.createElement('div', { className: "w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-deep-green" })
                                    )
                                ),
                                React.createElement('p', { className: "text-sm text-gray-600" }, "Get notified after 8 hours of work to take a break")
                            ),

                            React.createElement('div', { className: "border-t border-soft-gray pt-6 pb-6" },
                                React.createElement('div', { className: "flex items-center justify-between mb-3" },
                                    React.createElement('h3', { className: "text-lg font-semibold text-eggplant" }, "Hourly Break Reminder"),
                                    React.createElement('label', { className: "relative inline-flex items-center cursor-pointer" },
                                        React.createElement('input', {
                                            type: "checkbox",
                                            checked: hourlyBreakNotificationEnabled,
                                            onChange: (e) => setHourlyBreakNotificationEnabled(e.target.checked),
                                            className: "sr-only peer"
                                        }),
                                        React.createElement('div', { className: "w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-deep-green" })
                                    )
                                ),
                                React.createElement('p', { className: "text-sm text-gray-600" }, "Get reminded every hour to take a 5-minute break")
                            ),

                            React.createElement('div', { className: "pb-6" },
                                React.createElement('div', { className: "flex items-center justify-between mb-3" },
                                    React.createElement('h3', { className: "text-lg font-semibold text-eggplant" }, "Floating Timer Window"),
                                    React.createElement('label', { className: "relative inline-flex items-center cursor-pointer" },
                                        React.createElement('input', {
                                            type: "checkbox",
                                            checked: floatingTimerEnabled,
                                            onChange: (e) => setFloatingTimerEnabled(e.target.checked),
                                            className: "sr-only peer"
                                        }),
                                        React.createElement('div', { className: "w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-deep-green" })
                                    )
                                ),
                                React.createElement('p', { className: "text-sm text-gray-600" }, "Show a small always-on-top window with timer while tracking")
                            ),

                            React.createElement('div', { className: "pb-6 border-t pt-6 mt-6" },
                                React.createElement('div', { className: "flex items-center justify-between mb-3" },
                                    React.createElement('h3', { className: "text-lg font-semibold text-eggplant" }, "Expense Tracking"),
                                    React.createElement('label', { className: "relative inline-flex items-center cursor-pointer" },
                                        React.createElement('input', {
                                            type: "checkbox",
                                            checked: expenseTrackingEnabled,
                                            onChange: (e) => setExpenseTrackingEnabled(e.target.checked),
                                            className: "sr-only peer"
                                        }),
                                        React.createElement('div', { className: "w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-deep-green" })
                                    )
                                ),
                                React.createElement('p', { className: "text-sm text-gray-600" }, "Enable expense tracking section on the Track Time page")
                            ),

                            React.createElement('div', { className: "pb-6 border-t pt-6 mt-6" },
                                React.createElement('h3', { className: "text-lg font-semibold text-eggplant mb-4" }, "Invoice Management"),
                                React.createElement('div', { className: "space-y-4" },
                                    // Company and Client Profile Management Buttons
                                    React.createElement('div', { className: "grid grid-cols-2 gap-4 mb-6" },
                                        React.createElement('button', {
                                            onClick: () => {
                                                setShowSettingsMenu(false);
                                                setShowCompanyManager(true);
                                            },
                                            className: "px-4 py-3 bg-deep-green text-white rounded-subtle hover:bg-opacity-90 transition-colors font-medium text-center"
                                        }, "Manage Company Profiles"),
                                        React.createElement('button', {
                                            onClick: () => {
                                                setShowSettingsMenu(false);
                                                setShowClientManager(true);
                                            },
                                            className: "px-4 py-3 bg-eggplant text-white rounded-subtle hover:bg-opacity-90 transition-colors font-medium text-center"
                                        }, "Manage Client Profiles")
                                    ),
                                    React.createElement('p', { className: "text-xs text-gray-500 mb-4" }, "Create and manage reusable company and client profiles for quick invoice generation"),
                                    React.createElement('div', { className: "border-t border-gray-200 pt-4" }),
                                    React.createElement('div', null,
                                        React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, "Business Logo"),
                                        React.createElement('input', {
                                            type: "file",
                                            accept: ".jpg,.jpeg,.png",
                                            onChange: (e) => {
                                                const file = e.target.files[0];
                                                if (file) {
                                                    const reader = new FileReader();
                                                    reader.onload = (event) => {
                                                        setBusinessLogo(event.target.result);
                                                    };
                                                    reader.readAsDataURL(file);
                                                }
                                            },
                                            className: "block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-subtle file:border-0 file:text-sm file:font-semibold file:bg-deep-green file:text-white hover:file:bg-opacity-90"
                                        }),
                                        React.createElement('p', { className: "text-xs text-gray-500 mt-1" }, "JPEG or PNG. Recommended: 400x100px, max 2MB, transparent background preferred"),
                                        businessLogo && React.createElement('div', { className: "mt-3 p-4 bg-gray-50 rounded border" },
                                            React.createElement('img', { src: businessLogo, alt: "Logo preview", className: "max-h-20" }),
                                            React.createElement('button', {
                                                onClick: () => setBusinessLogo(''),
                                                className: "mt-2 text-sm text-red-600 hover:text-red-800"
                                            }, "Remove Logo")
                                        )
                                    ),
                                    React.createElement('div', null,
                                        React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, "Invoice Line Item Grouping"),
                                        React.createElement('select', {
                                            value: invoiceGrouping,
                                            onChange: (e) => setInvoiceGrouping(e.target.value),
                                            className: "w-full px-3 py-2 border border-gray-300 rounded-subtle focus:outline-none focus:border-eggplant"
                                        },
                                            React.createElement('option', { value: "none" }, "No grouping - one line per entry"),
                                            React.createElement('option', { value: "task" }, "Group by task"),
                                            React.createElement('option', { value: "task-subtask" }, "Group by task and subtask")
                                        ),
                                        React.createElement('p', { className: "text-xs text-gray-500 mt-1" }, "Choose how to group timesheet entries on invoices")
                                    )
                                )
                            )
                        )
                    )
                ),

                showGuideModal && React.createElement('div', {
                    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",
                    onClick: () => setShowGuideModal(false)
                },
                    React.createElement('div', {
                        className: "bg-white rounded-subtle p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto",
                        onClick: (e) => e.stopPropagation()
                    },
                        React.createElement('div', { className: "flex justify-between items-center mb-6" },
                            React.createElement('h2', { className: "text-3xl font-bold text-eggplant" }, "Getting Started with ThymeSheet"),
                            React.createElement('button', {
                                onClick: () => setShowGuideModal(false),
                                className: "text-gray-400 hover:text-eggplant text-3xl leading-none"
                            }, "Ã—")
                        ),

                        React.createElement('div', { className: "space-y-8" },
                            React.createElement('section', null,
                                React.createElement('h3', { className: "text-xl font-semibold text-deep-green mb-4 flex items-center gap-2" },
                                    React.createElement('span', { className: "bg-deep-green text-white w-8 h-8 rounded-full flex items-center justify-center text-sm" }, "1"),
                                    "Setting Up Your Projects"
                                ),
                                React.createElement('div', { className: "ml-10 space-y-3 text-gray-700" },
                                    React.createElement('p', { className: "leading-relaxed" }, "Before you can track time, you need to add your projects. ThymeSheet uses a 4-field structure for maximum organization:"),
                                    React.createElement('ul', { className: "list-disc ml-6 space-y-2" },
                                        React.createElement('li', null, React.createElement('strong', null, "Client Name:"), " The company or organization you're working for (e.g., \"Orbital\")"),
                                        React.createElement('li', null, React.createElement('strong', null, "Project/Admin Name:"), " The specific project or administrative category (e.g., \"O2-X Habitat Offsetting Plan\")"),
                                        React.createElement('li', null, React.createElement('strong', null, "Task Code:"), " The main task category (e.g., \"1. Meetings and Delivery\")"),
                                        React.createElement('li', null, React.createElement('strong', null, "Subtask Code:"), " The specific subtask (e.g., \"1.1 Project\")")
                                    ),
                                    React.createElement('div', { className: "bg-pearl p-4 rounded-subtle mt-4" },
                                        React.createElement('p', { className: "font-semibold text-eggplant mb-2" }, "ðŸ’¡ Quick Tip:"),
                                        React.createElement('p', null, "Navigate to ", React.createElement('strong', null, "View â†’ Manage Projects"), " or click the ", React.createElement('strong', null, "\"Manage Projects\""), " toggle to add projects one by one, or use ", React.createElement('strong', null, "\"Download Template\""), " to bulk import via CSV.")
                                    )
                                )
                            ),

                            React.createElement('section', null,
                                React.createElement('h3', { className: "text-xl font-semibold text-deep-green mb-4 flex items-center gap-2" },
                                    React.createElement('span', { className: "bg-deep-green text-white w-8 h-8 rounded-full flex items-center justify-center text-sm" }, "2"),
                                    "Tracking Your Time"
                                ),
                                React.createElement('div', { className: "ml-10 space-y-3 text-gray-700" },
                                    React.createElement('p', { className: "leading-relaxed" }, "Once your projects are set up, tracking time is simple:"),
                                    React.createElement('ol', { className: "list-decimal ml-6 space-y-2" },
                                        React.createElement('li', null, "Navigate to ", React.createElement('strong', null, "View â†’ Track Time"), " or click the ", React.createElement('strong', null, "\"Track Time\""), " toggle"),
                                        React.createElement('li', null, "Select your project from the dropdown menu"),
                                        React.createElement('li', null, "Optionally add a comment describing what you're working on"),
                                        React.createElement('li', null, "Click ", React.createElement('strong', { className: "text-deep-green" }, "\"Start Timer\""), " to begin tracking"),
                                        React.createElement('li', null, "When you're done, click ", React.createElement('strong', { className: "text-eggplant" }, "\"Stop Timer\""), " to save the entry")
                                    ),
                                    React.createElement('div', { className: "bg-pearl p-4 rounded-subtle mt-4" },
                                        React.createElement('p', { className: "font-semibold text-eggplant mb-2" }, "âš¡ Power Features:"),
                                        React.createElement('ul', { className: "list-disc ml-6 space-y-1" },
                                            React.createElement('li', null, React.createElement('strong', null, "Recent Projects:"), " Your last 10 projects appear at the top for quick access"),
                                            React.createElement('li', null, React.createElement('strong', null, "Quick Switch:"), " Use the dropdown in the running timer bar to switch projects without stopping"),
                                            React.createElement('li', null, React.createElement('strong', null, "Always Visible Timer:"), " The compact timer bar stays visible on both pages")
                                        )
                                    )
                                )
                            ),

                            React.createElement('section', null,
                                React.createElement('h3', { className: "text-xl font-semibold text-deep-green mb-4 flex items-center gap-2" },
                                    React.createElement('span', { className: "bg-deep-green text-white w-8 h-8 rounded-full flex items-center justify-center text-sm" }, "3"),
                                    "Keyboard Shortcuts"
                                ),
                                React.createElement('div', { className: "ml-10 space-y-3 text-gray-700" },
                                    React.createElement('p', { className: "leading-relaxed mb-3" }, "Work faster with these global hotkeys (work even when app is minimized):"),
                                    React.createElement('div', { className: "grid grid-cols-2 gap-4" },
                                        React.createElement('div', { className: "flex items-center gap-3 bg-soft-gray p-3 rounded-subtle" },
                                            React.createElement('kbd', { className: "px-3 py-2 bg-white border-2 border-gray-300 rounded font-mono text-sm" }, "Ctrl+Shift+Z"),
                                            React.createElement('span', null, "Show/Hide window")
                                        ),
                                        React.createElement('div', { className: "flex items-center gap-3 bg-soft-gray p-3 rounded-subtle" },
                                            React.createElement('kbd', { className: "px-3 py-2 bg-white border-2 border-gray-300 rounded font-mono text-sm" }, "Ctrl+Shift+Space"),
                                            React.createElement('span', null, "Start/Stop timer")
                                        ),
                                        React.createElement('div', { className: "flex items-center gap-3 bg-soft-gray p-3 rounded-subtle" },
                                            React.createElement('kbd', { className: "px-3 py-2 bg-white border-2 border-gray-300 rounded font-mono text-sm" }, "Ctrl+,"),
                                            React.createElement('span', null, "Open Settings")
                                        ),
                                        React.createElement('div', { className: "flex items-center gap-3 bg-soft-gray p-3 rounded-subtle" },
                                            React.createElement('kbd', { className: "px-3 py-2 bg-white border-2 border-gray-300 rounded font-mono text-sm" }, "Ctrl+H"),
                                            React.createElement('span', null, "Hide to tray")
                                        )
                                    )
                                )
                            ),

                            React.createElement('section', null,
                                React.createElement('h3', { className: "text-xl font-semibold text-deep-green mb-4 flex items-center gap-2" },
                                    React.createElement('span', { className: "bg-deep-green text-white w-8 h-8 rounded-full flex items-center justify-center text-sm" }, "4"),
                                    "Configuring Settings"
                                ),
                                React.createElement('div', { className: "ml-10 space-y-3 text-gray-700" },
                                    React.createElement('p', { className: "leading-relaxed mb-3" }, "Access ", React.createElement('strong', null, "Settings â†’ All Settings"), " from the menu to configure:"),
                                    React.createElement('div', { className: "space-y-3" },
                                        React.createElement('div', null,
                                            React.createElement('h4', { className: "font-semibold text-eggplant mb-1" }, "â±ï¸ Time Rounding"),
                                            React.createElement('p', null, "Automatically round up your time entries to 5, 10, or 15-minute intervals for cleaner billing. Perfect for hourly billing requirements.")
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('h4', { className: "font-semibold text-eggplant mb-1" }, "â¸ï¸ Stop Timer on Idle"),
                                            React.createElement('p', null, "Automatically pauses timer when you're idle or when your computer sleeps/shuts down/locks. You can choose to resume tracking or assign the idle time to your project. Prevents accidental over-billing.")
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('h4', { className: "font-semibold text-eggplant mb-1" }, "ðŸ”” Activity Reminders"),
                                            React.createElement('p', null, "Get reminded to start tracking when you're working but the timer isn't running. Helps you never miss billable hours! Configurable reminder interval.")
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('h4', { className: "font-semibold text-eggplant mb-1" }, "ðŸŽ¯ Daily Goal"),
                                            React.createElement('p', null, "Set a target number of hours per day. ThymeSheet shows a live progress bar with your current hours, percentage complete, and hours remaining. Motivating and informative!")
                                        )
                                    )
                                )
                            ),

                            React.createElement('section', null,
                                React.createElement('h3', { className: "text-xl font-semibold text-deep-green mb-4 flex items-center gap-2" },
                                    React.createElement('span', { className: "bg-deep-green text-white w-8 h-8 rounded-full flex items-center justify-center text-sm" }, "5"),
                                    "Exporting Your Data"
                                ),
                                React.createElement('div', { className: "ml-10 space-y-3 text-gray-700" },
                                    React.createElement('p', { className: "leading-relaxed" }, "ThymeSheet provides flexible export options for your timesheet data:"),
                                    React.createElement('div', { className: "space-y-3" },
                                        React.createElement('div', null,
                                            React.createElement('h4', { className: "font-semibold text-eggplant mb-1" }, "ðŸ“Š CSV Export"),
                                            React.createElement('p', null, "Exports a detailed CSV with both a project summary and detailed entries. Filter by date range, client, or project before exporting.")
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('h4', { className: "font-semibold text-eggplant mb-1" }, "ðŸ’¼ QuickBooks Online (QBO) Export"),
                                            React.createElement('p', null, "Exports in QBO-compatible format for easy import into QuickBooks. Includes service items, quantities, and customer mapping.")
                                        )
                                    ),
                                    React.createElement('div', { className: "bg-deep-green bg-opacity-10 border-l-4 border-deep-green p-4 rounded-subtle mt-4" },
                                        React.createElement('p', { className: "font-semibold text-deep-green mb-2" }, "ðŸ“ Pro Tip:"),
                                        React.createElement('p', null, "Use the date range filters to export specific billing periods. Comments are included in CSV exports, so add context to your time entries!")
                                    )
                                )
                            ),

                            React.createElement('section', null,
                                React.createElement('h3', { className: "text-xl font-semibold text-deep-green mb-4 flex items-center gap-2" },
                                    React.createElement('span', { className: "bg-deep-green text-white w-8 h-8 rounded-full flex items-center justify-center text-sm" }, "6"),
                                    "System Tray Integration"
                                ),
                                React.createElement('div', { className: "ml-10 space-y-3 text-gray-700" },
                                    React.createElement('p', { className: "leading-relaxed" }, "ThymeSheet lives in your system tray for always-available access:"),
                                    React.createElement('ul', { className: "list-disc ml-6 space-y-2" },
                                        React.createElement('li', null, React.createElement('strong', null, "Double-click the tray icon"), " to show/hide the window"),
                                        React.createElement('li', null, React.createElement('strong', null, "Right-click the tray icon"), " for quick actions:"),
                                        React.createElement('ul', { className: "list-circle ml-6 mt-1" },
                                            React.createElement('li', null, "Show ThymeSheet"),
                                            React.createElement('li', null, "Start/Stop Timer"),
                                            React.createElement('li', null, "Quit")
                                        ),
                                        React.createElement('li', null, "The app stays running in the tray even when you close the window, so you can quickly pop it back up with ", React.createElement('kbd', { className: "px-2 py-1 bg-soft-gray rounded text-sm" }, "Ctrl+Shift+Z"))
                                    )
                                )
                            ),

                            React.createElement('section', { className: "border-t border-soft-gray pt-6" },
                                React.createElement('h3', { className: "text-xl font-semibold text-eggplant mb-4" }, "ðŸ’¡ Best Practices"),
                                React.createElement('div', { className: "space-y-2 text-gray-700" },
                                    React.createElement('ul', { className: "list-disc ml-6 space-y-2" },
                                        React.createElement('li', null, React.createElement('strong', null, "Set up all your projects at the start"), " to avoid interruptions during actual work"),
                                        React.createElement('li', null, React.createElement('strong', null, "Use descriptive comments"), " - your future self will thank you when reviewing entries"),
                                        React.createElement('li', null, React.createElement('strong', null, "Enable auto-pause"), " to prevent accidentally leaving the timer running"),
                                        React.createElement('li', null, React.createElement('strong', null, "Set a daily goal"), " to stay motivated and aware of your workload"),
                                        React.createElement('li', null, React.createElement('strong', null, "Export regularly"), " - weekly or bi-weekly exports make billing and invoicing smoother"),
                                        React.createElement('li', null, React.createElement('strong', null, "Use the Recent Projects"), " feature for recurring work - it saves valuable clicks!")
                                    )
                                )
                            )
                        ),

                        React.createElement('div', { className: "mt-8 text-center" },
                            React.createElement('button', {
                                onClick: () => setShowGuideModal(false),
                                className: "px-8 py-3 bg-deep-green text-white rounded-subtle hover:bg-opacity-90 transition-all font-semibold"
                            }, "Got It!")
                        )
                    )
                ),

                showFeedbackModal && React.createElement('div', {
                    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",
                    onClick: () => setShowFeedbackModal(false)
                },
                    React.createElement('div', {
                        className: "bg-white rounded-subtle p-8 max-w-lg w-full mx-4",
                        onClick: (e) => e.stopPropagation()
                    },
                        React.createElement('div', { className: "flex justify-between items-center mb-6" },
                            React.createElement('h2', { className: "text-2xl font-bold text-deep-green" }, "Send Feedback"),
                            React.createElement('button', {
                                onClick: () => setShowFeedbackModal(false),
                                className: "text-gray-400 hover:text-deep-green text-2xl"
                            }, "Ã—")
                        ),
                        React.createElement('div', { className: "space-y-4" },
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-sm font-semibold text-gray-700 mb-2" }, "What type of feedback?"),
                                React.createElement('select', {
                                    value: feedbackType,
                                    onChange: (e) => setFeedbackType(e.target.value),
                                    className: "w-full px-4 py-2 border border-soft-gray rounded-subtle focus:outline-none focus:border-deep-green"
                                },
                                    React.createElement('option', { value: "suggestion" }, "ðŸ’¡ Suggestion"),
                                    React.createElement('option', { value: "bug" }, "ðŸ› Bug Report"),
                                    React.createElement('option', { value: "feature" }, "âœ¨ Feature Request"),
                                    React.createElement('option', { value: "other" }, "ðŸ’¬ Other")
                                )
                            ),
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-sm font-semibold text-gray-700 mb-2" }, "Your feedback"),
                                React.createElement('textarea', {
                                    value: feedbackText,
                                    onChange: (e) => setFeedbackText(e.target.value),
                                    placeholder: "Tell us what you think...",
                                    rows: 6,
                                    className: "w-full px-4 py-2 border border-soft-gray rounded-subtle focus:outline-none focus:border-deep-green resize-none"
                                })
                            ),
                            React.createElement('div', { className: "flex justify-end gap-3 pt-4" },
                                React.createElement('button', {
                                    onClick: () => setShowFeedbackModal(false),
                                    className: "px-6 py-2 border border-soft-gray text-gray-700 rounded-subtle hover:bg-soft-gray transition-colors"
                                }, "Cancel"),
                                React.createElement('button', {
                                    onClick: () => {
                                        if (feedbackText.trim()) {
                                            const feedbackUrl = `https://docs.google.com/forms/d/e/1FAIpQLSeNFOTEUzh4y2cSDU9ndxzLFH066hQZRSZQOoGCSynuTuLI4w/viewform?usp=pp_url&entry.560510887=${encodeURIComponent(feedbackType)}&entry.1928926751=${encodeURIComponent(feedbackText)}`;
                                            require('electron').shell.openExternal(feedbackUrl);
                                            setFeedbackText('');
                                            setShowFeedbackModal(false);
                                            setActiveNotification({ type: 'success', message: 'Thank you for your feedback!' });
                                        }
                                    },
                                    disabled: !feedbackText.trim(),
                                    className: "px-6 py-2 bg-deep-green text-white rounded-subtle hover:bg-opacity-90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                }, "Send Feedback")
                            )
                        )
                    )
                ),

                showUpgradeDialog && React.createElement('div', {
                    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",
                    onClick: () => {
                        setShowUpgradeDialog(false);
                        setUpgradeError('');
                        setUpgradeKeyInput('');
                        setUpgradeSuccess(false);
                    }
                },
                    React.createElement('div', {
                        className: "bg-white rounded-subtle p-8 max-w-md w-full mx-4",
                        onClick: (e) => e.stopPropagation()
                    },
                        React.createElement('div', { className: "flex justify-between items-center mb-6" },
                            React.createElement('h2', { className: "text-2xl font-bold text-deep-green" }, "Upgrade to Premium"),
                            React.createElement('button', {
                                onClick: () => {
                                    setShowUpgradeDialog(false);
                                    setUpgradeError('');
                                    setUpgradeKeyInput('');
                                    setUpgradeSuccess(false);
                                },
                                className: "text-gray-400 hover:text-deep-green text-2xl"
                            }, "Ã—")
                        ),
                        !upgradeSuccess ? React.createElement('div', { className: "space-y-4" },
                            licenseState && licenseState.state === 'trial' && React.createElement('div', { className: "bg-blue-50 border-l-4 border-blue-400 p-4 mb-4" },
                                React.createElement('p', { className: "text-sm text-blue-700" },
                                    `You have ${licenseState.daysRemaining} day${licenseState.daysRemaining !== 1 ? 's' : ''} remaining in your trial.`
                                )
                            ),
                            React.createElement('p', { className: "text-gray-700 mb-4" },
                                "Enter your premium license key to unlock all features:"
                            ),
                            React.createElement('div', null,
                                React.createElement('input', {
                                    type: "text",
                                    value: upgradeKeyInput,
                                    onChange: (e) => {
                                        setUpgradeKeyInput(e.target.value.toUpperCase());
                                        setUpgradeError('');
                                    },
                                    placeholder: "THYME-PREM-XXXX-XXXX",
                                    className: "w-full px-4 py-3 border border-soft-gray rounded-subtle focus:outline-none focus:border-deep-green font-mono text-center text-lg tracking-wider",
                                    style: { letterSpacing: '0.1em' }
                                })
                            ),
                            upgradeError && React.createElement('div', { className: "bg-red-50 border-l-4 border-red-400 p-3" },
                                React.createElement('p', { className: "text-sm text-red-700" }, upgradeError)
                            ),
                            React.createElement('div', { className: "flex justify-end gap-3 pt-4" },
                                React.createElement('button', {
                                    onClick: () => {
                                        setShowUpgradeDialog(false);
                                        setUpgradeError('');
                                        setUpgradeKeyInput('');
                                    },
                                    className: "px-6 py-2 border border-soft-gray text-gray-700 rounded-subtle hover:bg-soft-gray transition-colors"
                                }, "Cancel"),
                                React.createElement('button', {
                                    onClick: async () => {
                                        if (!upgradeKeyInput.trim()) {
                                            setUpgradeError('Please enter a license key');
                                            return;
                                        }

                                        try {
                                            const result = await ipcRenderer.invoke('upgrade-to-premium', upgradeKeyInput.trim());
                                            if (result.success) {
                                                setUpgradeSuccess(true);
                                                setUpgradeError('');
                                                // Refresh license state
                                                const updatedState = await ipcRenderer.invoke('get-license-state');
                                                setLicenseState(updatedState);
                                            } else {
                                                setUpgradeError(result.error || 'Invalid license key');
                                            }
                                        } catch (error) {
                                            setUpgradeError('Failed to activate license. Please try again.');
                                            console.error('Upgrade error:', error);
                                        }
                                    },
                                    disabled: !upgradeKeyInput.trim(),
                                    className: "px-6 py-2 bg-deep-green text-white rounded-subtle hover:bg-opacity-90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                }, "Activate Premium")
                            )
                        ) : React.createElement('div', { className: "text-center space-y-4" },
                            React.createElement('div', { className: "text-6xl mb-4" }, "ðŸŽ‰"),
                            React.createElement('h3', { className: "text-xl font-bold text-deep-green mb-2" }, "Premium Activated!"),
                            React.createElement('p', { className: "text-gray-600 mb-6" }, "All premium features are now unlocked. Thank you for your support!"),
                            React.createElement('button', {
                                onClick: () => {
                                    setShowUpgradeDialog(false);
                                    setUpgradeError('');
                                    setUpgradeKeyInput('');
                                    setUpgradeSuccess(false);
                                },
                                className: "px-8 py-3 bg-deep-green text-white rounded-subtle hover:bg-opacity-90 transition-colors"
                            }, "Continue")
                        )
                    )
                ),

                showExportDialog && React.createElement('div', {
                    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",
                    onClick: () => setShowExportDialog(false)
                },
                    React.createElement('div', {
                        className: "bg-white rounded-subtle p-8 max-w-md w-full mx-4",
                        onClick: (e) => e.stopPropagation()
                    },
                        React.createElement('div', { className: "flex justify-between items-center mb-6" },
                            React.createElement('h2', { className: "text-2xl font-bold text-deep-green" }, "Export Format"),
                            React.createElement('button', {
                                onClick: () => setShowExportDialog(false),
                                className: "text-gray-400 hover:text-deep-green text-2xl"
                            }, "Ã—")
                        ),
                        React.createElement('p', { className: "text-gray-700 mb-6" },
                            "Choose how you'd like to export your time entries:"
                        ),
                        React.createElement('div', { className: "space-y-3" },
                            React.createElement('button', {
                                onClick: () => {
                                    setShowExportDialog(false);
                                    exportToExcel();
                                },
                                className: "w-full flex items-center gap-3 px-6 py-4 border-2 border-deep-green bg-deep-green bg-opacity-5 rounded-subtle hover:bg-opacity-10 transition-colors text-left"
                            },
                                React.createElement('div', { className: "flex-shrink-0" },
                                    React.createElement('svg', {
                                        width: '24',
                                        height: '24',
                                        viewBox: '0 0 24 24',
                                        fill: 'none',
                                        stroke: 'currentColor',
                                        strokeWidth: '2',
                                        className: 'text-deep-green'
                                    },
                                        React.createElement('path', { d: 'M3 3v18h18' }),
                                        React.createElement('path', { d: 'M18.7 8l-5.1 5.2-2.8-2.7L7 14.3' })
                                    )
                                ),
                                React.createElement('div', null,
                                    React.createElement('div', { className: "font-semibold text-deep-green" }, "Export to Excel"),
                                    React.createElement('div', { className: "text-sm text-gray-600" }, "Download time entries as Excel spreadsheet")
                                )
                            ),
                            React.createElement('button', {
                                onClick: () => {
                                    setShowExportDialog(false);
                                    exportToInvoice();
                                },
                                className: "w-full flex items-center gap-3 px-6 py-4 border-2 border-eggplant bg-eggplant bg-opacity-5 rounded-subtle hover:bg-opacity-10 transition-colors text-left"
                            },
                                React.createElement('div', { className: "flex-shrink-0" },
                                    React.createElement('svg', {
                                        width: '24',
                                        height: '24',
                                        viewBox: '0 0 24 24',
                                        fill: 'none',
                                        stroke: 'currentColor',
                                        strokeWidth: '2',
                                        className: 'text-eggplant'
                                    },
                                        React.createElement('rect', { x: '3', y: '3', width: '18', height: '18', rx: '2', ry: '2' }),
                                        React.createElement('line', { x1: '3', y1: '9', x2: '21', y2: '9' }),
                                        React.createElement('line', { x1: '9', y1: '21', x2: '9', y2: '9' })
                                    )
                                ),
                                React.createElement('div', null,
                                    React.createElement('div', { className: "font-semibold text-eggplant" }, "Export as Invoice"),
                                    React.createElement('div', { className: "text-sm text-gray-600" }, "Generate professional invoice PDF")
                                )
                            )
                        )
                    )
                ),

                storageError && React.createElement('div', { className: "mb-8 p-5 bg-white border-l-4 border-eggplant rounded-subtle shadow-sm" },
                    React.createElement('span', { className: "text-eggplant" }, storageError),
                    React.createElement('button', {
                        onClick: () => setStorageError(null),
                        className: "ml-3 text-eggplant hover:opacity-60 transition-opacity"
                    }, "Ã—")
                ),

                dailyGoalEnabled && dailyProgressEnabled && (() => {
                    const todaysHours = getTodaysTotalHours();
                    const progressPercent = Math.min((todaysHours / dailyGoalHours) * 100, 100);
                    const hoursRemaining = Math.max(0, dailyGoalHours - todaysHours);

                    return React.createElement('div', { className: "bg-white border-l-4 border-eggplant rounded-subtle p-6 mb-10 shadow-sm" },
                        React.createElement('div', { className: "flex justify-between items-center mb-3" },
                            React.createElement('h3', { className: "text-sm font-semibold text-eggplant uppercase tracking-wider" }, "Daily Progress"),
                            React.createElement('div', { className: "text-right" },
                                React.createElement('span', { className: "text-2xl font-semibold text-deep-green" }, todaysHours.toFixed(1)),
                                React.createElement('span', { className: "text-gray-600 text-sm" }, " / " + dailyGoalHours + "h")
                            )
                        ),
                        React.createElement('div', { className: "w-full bg-soft-gray rounded-full h-4 overflow-hidden" },
                            React.createElement('div', {
                                className: "h-full bg-gradient-to-r from-deep-green to-eggplant transition-all duration-500",
                                style: { width: progressPercent + "%" }
                            })
                        ),
                        React.createElement('div', { className: "flex justify-between items-center mt-2 text-xs text-gray-600" },
                            React.createElement('span', null, progressPercent.toFixed(0) + "% complete"),
                            React.createElement('span', null, hoursRemaining.toFixed(1) + "h remaining")
                        )
                    );
                })(),

                // Time Summary Widget
                timeSummaryEnabled && React.createElement('div', { className: "bg-white border-l-4 border-deep-green rounded-subtle shadow-sm mb-8" },
                    React.createElement('div', {
                        className: "flex justify-between items-center p-4 cursor-pointer hover:bg-off-white transition-colors",
                        onClick: () => setTimeSummaryExpanded(!timeSummaryExpanded)
                    },
                        React.createElement('h3', { className: "text-sm font-semibold text-eggplant uppercase tracking-wider" }, "Time Summary"),
                        React.createElement('div', {
                            className: "transform transition-transform " + (timeSummaryExpanded ? "" : "rotate-180")
                        }, React.createElement(ChevronDown))
                    ),
                    timeSummaryExpanded && React.createElement('div', { className: "px-4 pb-4 border-t border-soft-gray pt-4" },
                        // Summary stats
                        React.createElement('div', { className: "grid grid-cols-3 gap-4 mb-6" },
                            React.createElement('div', { className: "text-center" },
                                React.createElement('div', { className: "text-xs text-gray-600 mb-1" }, "Today"),
                                React.createElement('div', { className: "text-2xl font-bold font-mono text-deep-green tabular-nums" },
                                    getTodaysTotalHours().toFixed(1)
                                ),
                                React.createElement('div', { className: "text-xs text-gray-500 mt-1" }, "hours")
                            ),
                            React.createElement('div', { className: "text-center border-l border-r border-soft-gray" },
                                React.createElement('div', { className: "text-xs text-gray-600 mb-1" }, "This Week"),
                                React.createElement('div', { className: "text-2xl font-bold font-mono text-deep-green tabular-nums" },
                                    getThisWeeksTotalHours().toFixed(1)
                                ),
                                React.createElement('div', { className: "text-xs text-gray-500 mt-1" }, "hours")
                            ),
                            React.createElement('div', { className: "text-center" },
                                React.createElement('div', { className: "text-xs text-gray-600 mb-1" }, "This Month"),
                                React.createElement('div', { className: "text-2xl font-bold font-mono text-deep-green tabular-nums" },
                                    getThisMonthsTotalHours().toFixed(1)
                                ),
                                React.createElement('div', { className: "text-xs text-gray-500 mt-1" }, "hours")
                            )
                        ),

                        // Period filter buttons
                        React.createElement('div', { className: "flex justify-center gap-2 mb-6" },
                            React.createElement('button', {
                                onClick: () => setChartPeriod('day'),
                                className: "px-4 py-2 rounded-subtle text-sm font-medium transition-colors " + (chartPeriod === 'day' ? "bg-deep-green text-white" : "bg-soft-gray text-gray-700 hover:bg-gray-300")
                            }, "Day"),
                            React.createElement('button', {
                                onClick: () => setChartPeriod('week'),
                                className: "px-4 py-2 rounded-subtle text-sm font-medium transition-colors " + (chartPeriod === 'week' ? "bg-deep-green text-white" : "bg-soft-gray text-gray-700 hover:bg-gray-300")
                            }, "Week"),
                            React.createElement('button', {
                                onClick: () => setChartPeriod('month'),
                                className: "px-4 py-2 rounded-subtle text-sm font-medium transition-colors " + (chartPeriod === 'month' ? "bg-deep-green text-white" : "bg-soft-gray text-gray-700 hover:bg-gray-300")
                            }, "Month")
                        ),

                        // Charts container
                        React.createElement('div', { className: "grid grid-cols-1 lg:grid-cols-2 gap-6" },
                            // Column chart - Total Hours
                            React.createElement('div', { className: "bg-off-white p-4 rounded-subtle" },
                                React.createElement('h4', { className: "text-sm font-semibold text-gray-700 mb-2 text-center" }, "Total Hours"),
                                React.createElement('p', { className: "text-xs text-gray-500 mb-4 text-center" }, getChartTitle()),
                                React.createElement('div', { className: "relative h-64" },
                                    React.createElement('div', { className: "flex items-end justify-around h-full gap-2 px-2" },
                                        getChartData().map((data, index) => {
                                            const chartData = getChartData();
                                            const maxHours = Math.max(...chartData.map(d => d.hours), 1);
                                            // Calculate height as percentage of container, with minimum 8% for visibility
                                            const heightPercent = data.hours > 0 ? Math.max((data.hours / maxHours) * 100, 8) : 0;
                                            return React.createElement('div', {
                                                key: index,
                                                className: "flex flex-col items-center justify-end flex-1 max-w-[80px] h-full"
                                            },
                                                React.createElement('div', {
                                                    className: "w-full bg-deep-green rounded-t relative flex flex-col items-center justify-end pb-2 transition-all hover:bg-opacity-80",
                                                    style: { height: heightPercent + '%' }
                                                },
                                                    data.hours > 0 && React.createElement('span', { className: "text-xs text-white font-bold" }, data.hours.toFixed(1))
                                                ),
                                                React.createElement('div', { className: "text-xs text-gray-600 mt-2 text-center font-medium" }, data.label)
                                            );
                                        })
                                    )
                                )
                            ),

                            // Pie chart - Hours by Project
                            React.createElement('div', { className: "bg-off-white p-4 rounded-subtle" },
                                React.createElement('h4', { className: "text-sm font-semibold text-gray-700 mb-2 text-center" }, "Hours by Project"),
                                React.createElement('p', { className: "text-xs text-gray-500 mb-4 text-center" }, getChartTitle()),
                                getProjectChartData().length > 0 ? React.createElement('div', { className: "flex flex-col items-center" },
                                    // Actual pie chart
                                    React.createElement('svg', { width: "200", height: "200", viewBox: "0 0 200 200", className: "mb-4" },
                                        (() => {
                                            const projectData = getProjectChartData();
                                            const colors = ['#4A7C59', '#6B9375', '#8CAA91', '#ADC1AD', '#CED8C9', '#4A7C59', '#6B9375', '#8CAA91'];
                                            let currentAngle = 0;

                                            return projectData.map((data, index) => {
                                                const percentage = parseFloat(data.percentage);
                                                const angle = (percentage / 100) * 360;
                                                const startAngle = currentAngle;
                                                const endAngle = currentAngle + angle;
                                                currentAngle = endAngle;

                                                const startRadians = (startAngle - 90) * (Math.PI / 180);
                                                const endRadians = (endAngle - 90) * (Math.PI / 180);
                                                const largeArc = angle > 180 ? 1 : 0;

                                                const x1 = 100 + 90 * Math.cos(startRadians);
                                                const y1 = 100 + 90 * Math.sin(startRadians);
                                                const x2 = 100 + 90 * Math.cos(endRadians);
                                                const y2 = 100 + 90 * Math.sin(endRadians);

                                                const pathData = `M 100 100 L ${x1} ${y1} A 90 90 0 ${largeArc} 1 ${x2} ${y2} Z`;

                                                return React.createElement('path', {
                                                    key: index,
                                                    d: pathData,
                                                    fill: colors[index % colors.length],
                                                    stroke: '#fff',
                                                    strokeWidth: '2'
                                                });
                                            });
                                        })()
                                    ),
                                    // Legend
                                    React.createElement('div', { className: "w-full space-y-2" },
                                        getProjectChartData().map((data, index) => {
                                            const colors = ['#4A7C59', '#6B9375', '#8CAA91', '#ADC1AD', '#CED8C9', '#4A7C59', '#6B9375', '#8CAA91'];
                                            const color = colors[index % colors.length];
                                            return React.createElement('div', { key: index, className: "flex items-center gap-2 text-sm" },
                                                React.createElement('div', {
                                                    className: "w-3 h-3 rounded-full flex-shrink-0",
                                                    style: { backgroundColor: color }
                                                }),
                                                React.createElement('span', { className: "text-gray-700 truncate flex-1" }, data.project),
                                                React.createElement('span', { className: "text-deep-green font-bold whitespace-nowrap" }, data.hours.toFixed(1) + 'h'),
                                                React.createElement('span', { className: "text-gray-500 text-xs whitespace-nowrap" }, '(' + data.percentage + '%)')
                                            );
                                        })
                                    )
                                ) : React.createElement('div', { className: "h-56 flex items-center justify-center text-gray-500 text-sm" }, "No data available")
                            )
                        )
                    )
                ),

                recentProjectsEnabled && recentProjects.length > 0 && React.createElement('div', { className: "bg-white border-l-4 border-deep-green rounded-subtle p-6 mb-8 shadow-sm" },
                    React.createElement('div', { className: "flex items-center justify-between mb-4" },
                        React.createElement('h3', { className: "text-sm font-semibold text-eggplant uppercase tracking-wider" }, "Recent Projects"),
                        React.createElement('div', { className: "text-xs text-gray-600 bg-soft-gray px-3 py-1 rounded-subtle" },
                            "Press ",
                            React.createElement('kbd', { className: "px-1.5 py-0.5 bg-white border border-gray-300 rounded text-xs font-mono mx-1" }, "1-9,0"),
                            " then ",
                            React.createElement('kbd', { className: "px-1.5 py-0.5 bg-white border border-gray-300 rounded text-xs font-mono mx-1" }, "Enter"),
                            " to start"
                        )
                    ),
                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3" },
                        recentProjects.slice(0, 10).map((projectId, index) => {
                            const project = projectCodes.find(p => p.id === projectId);
                            if (!project) return null;
                            const isActive = isTracking && currentSession && currentSession.projectId === projectId;
                            const isSelected = selectedProject === projectId.toString();

                            return React.createElement('button', {
                                key: projectId,
                                onClick: () => {
                                    if (isTracking && !isActive) {
                                        switchProject(projectId);
                                    } else {
                                        setSelectedProject(projectId.toString());
                                    }
                                },
                                className: "relative p-3 rounded-subtle border-2 transition-all text-left " +
                                    (isActive ? "border-deep-green bg-deep-green bg-opacity-10" :
                                     isSelected ? "border-eggplant bg-eggplant bg-opacity-10" :
                                     "border-soft-gray bg-white hover:border-deep-green")
                            },
                                React.createElement('div', { className: "absolute top-1 right-1 w-5 h-5 bg-deep-green text-white text-xs font-bold rounded-full flex items-center justify-center" }, (index === 9 ? '0' : (index + 1).toString())),
                                React.createElement('div', { className: "text-xs font-semibold text-deep-green truncate" }, project.code),
                                React.createElement('div', { className: "text-xs text-gray-600 truncate" }, project.clientName),
                                React.createElement('div', { className: "text-xs text-gray-500 truncate" }, project.subtaskCode),
                                isActive && React.createElement('div', { className: "text-xs text-deep-green font-semibold mt-1" }, "â— TRACKING")
                            );
                        })
                    )
                ),

                React.createElement('div', { className: "bg-white border-l-4 border-eggplant rounded-subtle p-6 mb-8 shadow-sm" },
                    React.createElement('h2', { className: "text-lg font-semibold text-eggplant mb-4" }, "Track Time"),
                    React.createElement('div', { className: "grid grid-cols-1 lg:grid-cols-3 gap-4" },
                        React.createElement('div', { className: "lg:col-span-2" },
                            React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-3 mb-3" },
                                React.createElement('div', null,
                                    React.createElement('label', { className: "block text-xs font-medium text-gray-700 mb-1" }, "1. Select Client"),
                                    React.createElement('select', {
                                        value: selectedClient,
                                        onChange: (e) => handleClientChange(e.target.value),
                                        className: "w-full px-3 py-2 text-sm border border-soft-gray rounded-subtle focus:outline-none focus:border-eggplant bg-white text-gray-800",
                                        disabled: isTracking
                                    },
                                        React.createElement('option', { value: "" }, "Choose client..."),
                                        getAvailableClients().map(client =>
                                            React.createElement('option', { key: client, value: client }, client)
                                        )
                                    )
                                ),
                                React.createElement('div', null,
                                    React.createElement('label', { className: "block text-xs font-medium text-gray-700 mb-1" }, "2. Select Project"),
                                    React.createElement('select', {
                                        value: selectedProjectName,
                                        onChange: (e) => handleProjectNameChange(e.target.value),
                                        className: "w-full px-3 py-2 text-sm border border-soft-gray rounded-subtle focus:outline-none focus:border-eggplant bg-white text-gray-800",
                                        disabled: !selectedClient || isTracking
                                    },
                                        React.createElement('option', { value: "" }, "Choose project..."),
                                        getAvailableProjectNames(selectedClient).map(project =>
                                            React.createElement('option', { key: project, value: project }, project)
                                        )
                                    )
                                ),
                                React.createElement('div', null,
                                    React.createElement('label', { className: "block text-xs font-medium text-gray-700 mb-1" }, "3. Select Task"),
                                    React.createElement('select', {
                                        value: selectedTaskCode,
                                        onChange: (e) => handleTaskCodeChange(e.target.value),
                                        className: "w-full px-3 py-2 text-sm border border-soft-gray rounded-subtle focus:outline-none focus:border-eggplant bg-white text-gray-800",
                                        disabled: !selectedProjectName || isTracking
                                    },
                                        React.createElement('option', { value: "" }, "Choose task..."),
                                        getAvailableTaskCodes(selectedClient, selectedProjectName).map(task =>
                                            React.createElement('option', { key: task, value: task }, task)
                                        )
                                    )
                                ),
                                React.createElement('div', null,
                                    React.createElement('label', { className: "block text-xs font-medium text-gray-700 mb-1" }, "4. Select Subtask"),
                                    React.createElement('select', {
                                        value: selectedProject,
                                        onChange: (e) => {
                                            if (isTracking) {
                                                switchProject(parseInt(e.target.value));
                                            } else {
                                                handleSubtaskCodeChange(e.target.value);
                                            }
                                        },
                                        className: "w-full px-3 py-2 text-sm border border-soft-gray rounded-subtle focus:outline-none focus:border-eggplant bg-white text-gray-800",
                                        disabled: !selectedTaskCode
                                    },
                                        React.createElement('option', { value: "" }, "Choose subtask..."),
                                        getAvailableSubtaskCodes(selectedClient, selectedProjectName, selectedTaskCode).map(subtask =>
                                            React.createElement('option', { key: subtask.id, value: subtask.id }, subtask.subtaskCode + " (" + subtask.code + ")")
                                        )
                                    )
                                )
                            ),
                            React.createElement('div', { className: "mt-3" },
                                React.createElement('label', { className: "block text-xs font-medium text-gray-700 mb-1" }, "Comment (Optional)"),
                                React.createElement('textarea', {
                                    value: currentComment,
                                    onChange: (e) => setCurrentComment(e.target.value),
                                    placeholder: "Add notes about this time entry...",
                                    className: "w-full px-3 py-2 text-sm border border-soft-gray rounded-subtle focus:outline-none focus:border-eggplant bg-white text-gray-800 resize-none",
                                    rows: 2
                                })
                            )
                        ),
                        React.createElement('div', { className: "flex flex-col justify-center items-center bg-pearl rounded-subtle p-4" },
                            React.createElement('div', { className: "text-center mb-3" },
                                React.createElement('div', { className: "text-xs text-gray-600 mb-1" }, "Elapsed Time"),
                                React.createElement('div', { className: "text-3xl font-mono font-bold text-deep-green tabular-nums" }, formatTime(elapsedTime))
                            ),
                            React.createElement('div', { className: "w-full" },
                                !isTracking ?
                                    React.createElement('button', {
                                        onClick: startTracking,
                                        disabled: !selectedProject,
                                        className: "w-full px-5 py-2.5 bg-deep-green text-white rounded-subtle hover:bg-opacity-90 transition-all font-semibold text-sm disabled:bg-gray-400 disabled:cursor-not-allowed"
                                    }, "Start Timer") :
                                    React.createElement('button', {
                                        onClick: stopTracking,
                                        className: "w-full px-5 py-2.5 bg-eggplant text-white rounded-subtle hover:bg-opacity-90 transition-all font-semibold text-sm"
                                    }, "Stop Timer")
                            )
                        )
                    )
                ),

                React.createElement('div', { className: "bg-white border-l-4 border-deep-green rounded-subtle p-6 mb-8 shadow-sm" },
                    React.createElement('h3', { className: "text-lg font-semibold text-eggplant mb-4" }, "Export Options"),
                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-4 mb-4" },
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, "Start Date"),
                            React.createElement('input', {
                                type: "date",
                                value: filterStartDate,
                                onChange: (e) => setFilterStartDate(e.target.value),
                                className: "w-full px-3 py-2 border border-soft-gray rounded-subtle focus:outline-none focus:border-eggplant"
                            })
                        ),
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, "End Date"),
                            React.createElement('input', {
                                type: "date",
                                value: filterEndDate,
                                onChange: (e) => setFilterEndDate(e.target.value),
                                className: "w-full px-3 py-2 border border-soft-gray rounded-subtle focus:outline-none focus:border-eggplant"
                            })
                        ),
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, "Filter by Client"),
                            React.createElement('select', {
                                value: filterClient,
                                onChange: (e) => setFilterClient(e.target.value),
                                className: "w-full px-3 py-2 border border-soft-gray rounded-subtle focus:outline-none focus:border-eggplant",
                                style: { height: '42px', appearance: 'auto' }
                            },
                                React.createElement('option', { value: "" }, "All Clients"),
                                getUniqueClients().map(client =>
                                    React.createElement('option', { key: client, value: client }, client)
                                )
                            )
                        ),
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, "Filter by Project"),
                            React.createElement('select', {
                                value: filterProject,
                                onChange: (e) => setFilterProject(e.target.value),
                                className: "w-full px-3 py-2 border border-soft-gray rounded-subtle focus:outline-none focus:border-eggplant",
                                style: { height: '42px', appearance: 'auto' }
                            },
                                React.createElement('option', { value: "" }, "All Projects"),
                                getUniqueProjects().map(project =>
                                    React.createElement('option', { key: project, value: project }, project)
                                )
                            )
                        )
                    ),
                    React.createElement('div', { className: "mb-4 p-4 bg-pearl rounded-subtle border border-soft-gray" },
                        React.createElement('label', { className: "flex items-start gap-3 cursor-pointer" },
                            React.createElement('input', {
                                type: "checkbox",
                                checked: mergeEntries,
                                onChange: (e) => setMergeEntries(e.target.checked),
                                className: "mt-1 w-4 h-4 text-deep-green border-gray-300 rounded focus:ring-deep-green"
                            }),
                            React.createElement('div', null,
                                React.createElement('span', { className: "text-sm font-medium text-gray-900" }, "Combine entries for the same task on the same day"),
                                React.createElement('p', { className: "text-xs text-gray-600 mt-1" },
                                    "When enabled, multiple time entries for the same task and subtask on the same date will be merged into a single row with combined hours. Comments will be joined together."
                                )
                            )
                        )
                    ),
                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-4" },
                        React.createElement('button', {
                            onClick: startExportWorkflow,
                            disabled: timeEntries.length === 0,
                            className: "flex items-center justify-center gap-2 px-6 py-3 bg-deep-green text-white rounded-subtle hover:bg-opacity-90 transition-all font-medium disabled:bg-gray-400 disabled:cursor-not-allowed"
                        },
                            React.createElement(Download),
                            "Export"
                        ),
                        React.createElement('button', {
                            onClick: () => startInvoiceGeneration(),
                            disabled: timeEntries.length === 0,
                            className: "flex items-center justify-center gap-2 px-6 py-3 bg-eggplant text-white rounded-subtle hover:bg-opacity-90 transition-all font-medium disabled:bg-gray-400 disabled:cursor-not-allowed"
                        },
                            React.createElement(DollarSign),
                            "Generate Invoice"
                        )
                    )
                ),

                // EXPENSE TRACKING SECTION (Only if enabled in settings)
                expenseTrackingEnabled && React.createElement('div', { className: "bg-white border-l-4 border-deep-green rounded-subtle p-6 shadow-sm mb-6" },
                    React.createElement('div', { className: "flex items-center justify-between mb-4" },
                        React.createElement('h3', { className: "text-lg font-semibold text-deep-green" }, "Expense Tracking"),
                        React.createElement('div', { className: "flex gap-3" },
                            React.createElement('button', {
                                onClick: () => setShowAddExpenseModal(true),
                                className: "flex items-center gap-2 px-4 py-2 bg-deep-green text-white rounded-subtle hover:bg-opacity-90 transition-all font-medium text-sm"
                            },
                                React.createElement(DollarSign),
                                "Add Expense"
                            ),
                            React.createElement('button', {
                                onClick: () => setShowExpensesView(!showExpensesView),
                                className: "flex items-center gap-2 px-4 py-2 bg-eggplant text-white rounded-subtle hover:bg-opacity-90 transition-all font-medium text-sm"
                            },
                                showExpensesView ? "Hide List" : "View List"
                            )
                        )
                    ),

                    // EXPENSES VIEW
                    showExpensesView && (expenses.length === 0 ?
                        React.createElement('div', { className: "text-center py-8 text-gray-500" },
                            React.createElement('p', null, "No expenses tracked yet. Click \"Add Expense\" to get started.")
                        ) :
                        React.createElement('div', { className: "overflow-x-auto" },
                            React.createElement('table', { className: "w-full border-collapse" },
                                React.createElement('thead', null,
                                    React.createElement('tr', { style: { backgroundColor: '#1C5A3F', color: 'white' } },
                                        React.createElement('th', { className: "p-3 text-left" }, "Date"),
                                        React.createElement('th', { className: "p-3 text-left" }, "Project"),
                                        React.createElement('th', { className: "p-3 text-left" }, "Category"),
                                        React.createElement('th', { className: "p-3 text-left" }, "Vendor"),
                                        React.createElement('th', { className: "p-3 text-left" }, "Description"),
                                        React.createElement('th', { className: "p-3 text-right" }, "Amount"),
                                        React.createElement('th', { className: "p-3 text-center" }, "Status"),
                                        React.createElement('th', { className: "p-3 text-center" }, "Actions")
                                    )
                                ),
                                React.createElement('tbody', null,
                                    [...expenses].sort((a, b) => b.purchaseDate.localeCompare(a.purchaseDate)).map((expense, idx) =>
                                        React.createElement('tr', {
                                            key: expense.id,
                                            style: { backgroundColor: idx % 2 === 0 ? 'white' : '#F5F3F0', borderBottom: '1px solid #EAEAEA' }
                                        },
                                            React.createElement('td', { className: "p-3" }, new Date(expense.purchaseDate).toLocaleDateString()),
                                            React.createElement('td', { className: "p-3 text-sm" },
                                                React.createElement('div', null, expense.clientName),
                                                React.createElement('div', { style: { color: '#666', fontSize: '12px' } }, expense.projectName)
                                            ),
                                            React.createElement('td', { className: "p-3" }, expense.category),
                                            React.createElement('td', { className: "p-3" }, expense.vendor),
                                            React.createElement('td', { className: "p-3", style: { maxWidth: '200px' } }, expense.description),
                                            React.createElement('td', { className: "p-3 text-right font-medium" }, '$' + expense.totalExpense.toFixed(2)),
                                            React.createElement('td', { className: "p-3 text-center" },
                                                React.createElement('button', {
                                                    onClick: () => toggleExpensePaidStatus(expense.id),
                                                    style: {
                                                        padding: '5px 12px',
                                                        borderRadius: '4px',
                                                        border: 'none',
                                                        cursor: 'pointer',
                                                        backgroundColor: expense.paid ? '#4CAF50' : '#FFC107',
                                                        color: 'white',
                                                        fontSize: '12px'
                                                    }
                                                },
                                                    expense.paid ? 'Paid' : 'Unpaid'
                                                )
                                            ),
                                            React.createElement('td', { className: "p-3 text-center" },
                                                React.createElement('button', {
                                                    onClick: () => deleteExpense(expense.id),
                                                    className: "px-3 py-1 border border-gray-300 rounded hover:bg-gray-100"
                                                },
                                                    "Delete"
                                                )
                                            )
                                        )
                                    )
                                )
                            )
                        ))
                ),

                React.createElement('div', { className: "bg-white border-l-4 border-eggplant rounded-subtle p-6 shadow-sm" },
                    React.createElement('h3', { className: "text-lg font-semibold text-eggplant mb-4" }, "Recent Entries"),
                    timeEntries.length === 0 ?
                        React.createElement('div', { className: "text-center py-8 text-gray-500" },
                            React.createElement('p', null, "No time entries yet. Start tracking to see your entries here!")
                        ) :
                        React.createElement('div', null,
                            React.createElement('div', { className: "mb-4" },
                                React.createElement('input', {
                                    type: "text",
                                    value: timeEntriesSearchTerm,
                                    onChange: (e) => {
                                        setTimeEntriesSearchTerm(e.target.value);
                                        setCurrentPage(1);
                                    },
                                    placeholder: "Search by client, project, or comment...",
                                    className: "w-full px-4 py-2 border border-soft-gray rounded-subtle focus:outline-none focus:border-deep-green"
                                })
                            ),
                            React.createElement('div', { className: "overflow-x-auto" },
                                React.createElement('table', { className: "w-full text-sm" },
                                    React.createElement('thead', null,
                                        React.createElement('tr', { className: "border-b border-soft-gray" },
                                            React.createElement('th', { className: "text-left py-3 px-2 font-semibold text-gray-700" }, "Date"),
                                            React.createElement('th', { className: "text-left py-3 px-2 font-semibold text-gray-700" }, "Code"),
                                            React.createElement('th', { className: "text-left py-3 px-2 font-semibold text-gray-700" }, "Client"),
                                            React.createElement('th', { className: "text-left py-3 px-2 font-semibold text-gray-700" }, "Project"),
                                            React.createElement('th', { className: "text-left py-3 px-2 font-semibold text-gray-700" }, "Start"),
                                            React.createElement('th', { className: "text-left py-3 px-2 font-semibold text-gray-700" }, "End"),
                                            React.createElement('th', { className: "text-left py-3 px-2 font-semibold text-gray-700" }, "Hours"),
                                            React.createElement('th', { className: "text-left py-3 px-2 font-semibold text-gray-700" }, "Comment"),
                                            React.createElement('th', { className: "text-left py-3 px-2 font-semibold text-gray-700" }, "Actions")
                                        )
                                    ),
                                    React.createElement('tbody', null,
                                        (() => {
                                            const entriesPerPage = 10;
                                            const reversedEntries = timeEntries.slice().reverse();

                                            // Filter entries based on search term
                                            const filteredEntries = timeEntriesSearchTerm.trim() === ''
                                                ? reversedEntries
                                                : reversedEntries.filter(entry => {
                                                    const searchLower = timeEntriesSearchTerm.toLowerCase();
                                                    return (
                                                        (entry.clientName && entry.clientName.toLowerCase().includes(searchLower)) ||
                                                        (entry.projectName && entry.projectName.toLowerCase().includes(searchLower)) ||
                                                        (entry.comment && entry.comment.toLowerCase().includes(searchLower)) ||
                                                        (entry.projectCode && entry.projectCode.toLowerCase().includes(searchLower))
                                                    );
                                                });

                                            const totalPages = Math.ceil(filteredEntries.length / entriesPerPage);
                                            const startIndex = (currentPage - 1) * entriesPerPage;
                                            const endIndex = startIndex + entriesPerPage;
                                            const currentEntries = filteredEntries.slice(startIndex, endIndex);

                                            return currentEntries.map((entry) =>
                                                React.createElement('tr', { key: entry.id, className: "border-b border-soft-gray hover:bg-off-white transition-colors" },
                                                    React.createElement('td', { className: "py-3 px-2" }, entry.date),
                                                    React.createElement('td', { className: "py-3 px-2 font-semibold text-deep-green" }, entry.projectCode),
                                                    React.createElement('td', { className: "py-3 px-2 text-gray-700" }, entry.clientName),
                                                    React.createElement('td', { className: "py-3 px-2 text-gray-700" }, entry.projectName),
                                                    React.createElement('td', { className: "py-3 px-2 text-gray-600" }, entry.startTime),
                                                    React.createElement('td', { className: "py-3 px-2 text-gray-600" }, entry.endTime),
                                                    React.createElement('td', { className: "py-3 px-2 font-semibold" }, entry.hours.toFixed(2)),
                                                    React.createElement('td', { className: "py-3 px-2 text-gray-600 text-xs max-w-xs truncate" }, entry.comment || '-'),
                                                    React.createElement('td', { className: "py-3 px-2" },
                                                        React.createElement('div', { className: "flex items-center gap-2" },
                                                            React.createElement('button', {
                                                                onClick: () => startEditEntry(entry),
                                                                className: "text-gray-400 hover:text-deep-green transition-colors",
                                                                title: "Edit entry"
                                                            }, React.createElement(Edit2)),
                                                            React.createElement('button', {
                                                                onClick: () => deleteEntry(entry.id),
                                                                className: "text-gray-400 hover:text-eggplant transition-colors",
                                                                title: "Delete entry"
                                                            }, React.createElement(Trash2))
                                                        )
                                                    )
                                                )
                                            );
                                        })()
                                    )
                                )
                            ),
                            // Pagination controls
                            (() => {
                                const entriesPerPage = 10;
                                const reversedEntries = timeEntries.slice().reverse();

                                // Filter entries based on search term (same logic as above)
                                const filteredEntries = timeEntriesSearchTerm.trim() === ''
                                    ? reversedEntries
                                    : reversedEntries.filter(entry => {
                                        const searchLower = timeEntriesSearchTerm.toLowerCase();
                                        return (
                                            (entry.clientName && entry.clientName.toLowerCase().includes(searchLower)) ||
                                            (entry.projectName && entry.projectName.toLowerCase().includes(searchLower)) ||
                                            (entry.comment && entry.comment.toLowerCase().includes(searchLower)) ||
                                            (entry.projectCode && entry.projectCode.toLowerCase().includes(searchLower))
                                        );
                                    });

                                const totalPages = Math.ceil(filteredEntries.length / entriesPerPage);

                                if (totalPages <= 1) return null;

                                const getPageNumbers = () => {
                                    const pages = [];
                                    const maxVisible = 10;

                                    if (totalPages <= maxVisible) {
                                        // Show all pages
                                        for (let i = 1; i <= totalPages; i++) {
                                            pages.push(i);
                                        }
                                    } else {
                                        // Show first 10 pages and ellipsis
                                        for (let i = 1; i <= Math.min(maxVisible, totalPages); i++) {
                                            pages.push(i);
                                        }
                                        if (totalPages > maxVisible) {
                                            pages.push('...');
                                        }
                                    }

                                    return pages;
                                };

                                return React.createElement('div', { className: "flex items-center justify-center gap-2 mt-4 flex-wrap" },
                                    // Previous button
                                    React.createElement('button', {
                                        onClick: () => setCurrentPage(Math.max(1, currentPage - 1)),
                                        disabled: currentPage === 1,
                                        className: "px-3 py-1 rounded-subtle border border-soft-gray hover:border-deep-green disabled:opacity-30 disabled:cursor-not-allowed transition-colors"
                                    }, "â† Prev"),

                                    // Page numbers
                                    getPageNumbers().map((page, index) => {
                                        if (page === '...') {
                                            return React.createElement('span', { key: `ellipsis-${index}`, className: "px-2 text-gray-400" }, '...');
                                        }

                                        return React.createElement('button', {
                                            key: page,
                                            onClick: () => setCurrentPage(page),
                                            className: currentPage === page
                                                ? "px-3 py-1 rounded-subtle bg-deep-green text-white font-semibold"
                                                : "px-3 py-1 rounded-subtle border border-soft-gray hover:border-deep-green transition-colors"
                                        }, page);
                                    }),

                                    // Next button
                                    React.createElement('button', {
                                        onClick: () => setCurrentPage(Math.min(totalPages, currentPage + 1)),
                                        disabled: currentPage === totalPages,
                                        className: "px-3 py-1 rounded-subtle border border-soft-gray hover:border-deep-green disabled:opacity-30 disabled:cursor-not-allowed transition-colors"
                                    }, "Next â†’")
                                );
                            })()
                        )
                ),
                // Notification Toast
                activeNotification && React.createElement('div', {
                    className: "fixed bottom-4 right-4 z-50"
                },
                    React.createElement('div', {
                        className: "bg-white border-l-4 rounded-subtle shadow-xl p-4 max-w-sm flex items-start gap-3 " + (activeNotification.type === 'success' ? "border-deep-green" : "border-eggplant")
                    },
                        React.createElement('div', { className: "flex-1" },
                            React.createElement('p', { className: "text-sm text-gray-800" }, activeNotification.message)
                        ),
                        React.createElement('button', {
                            onClick: () => setActiveNotification(null),
                            className: "text-gray-400 hover:text-gray-600 transition-colors text-xl leading-none"
                        }, "Ã—")
                    )
                ),

                // Edit Entry Modal
                editingEntry && React.createElement('div', {
                    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",
                    onClick: cancelEditEntry
                },
                    React.createElement('div', {
                        className: "bg-white rounded-subtle shadow-xl p-4 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto",
                        onClick: (e) => e.stopPropagation()
                    },
                        React.createElement('h3', { className: "text-base font-semibold text-eggplant mb-3" }, "Edit Time Entry"),
                        React.createElement('div', { className: "space-y-3" },
                            React.createElement('div', { className: "bg-soft-gray p-3 rounded-subtle space-y-2" },
                                React.createElement('h4', { className: "text-xs font-semibold text-eggplant mb-1" }, "Project Selection"),
                                React.createElement('div', { className: "grid grid-cols-2 gap-2" },
                                React.createElement('div', null,
                                    React.createElement('label', { className: "block text-xs font-semibold text-gray-700 mb-1" }, "1. Client Name"),
                                    React.createElement('select', {
                                        value: (() => {
                                            const project = projectCodes.find(p => p.id === editFormData.projectId);
                                            return project ? project.clientName : '';
                                        })(),
                                        onChange: (e) => {
                                            const clientName = e.target.value;
                                            if (clientName) {
                                                // Find first project for this client
                                                const firstProject = projectCodes.find(p => p.clientName === clientName);
                                                if (firstProject) {
                                                    setEditFormData({ ...editFormData, projectId: firstProject.id });
                                                }
                                            }
                                        },
                                        className: "w-full px-2 py-1.5 text-sm border border-soft-gray rounded-subtle focus:outline-none focus:border-deep-green bg-white"
                                    },
                                        React.createElement('option', { value: '' }, "Select client..."),
                                        [...new Set(projectCodes.map(p => p.clientName))].sort().map(client =>
                                            React.createElement('option', { key: client, value: client }, client)
                                        )
                                    )
                                ),
                                (() => {
                                    const currentProject = projectCodes.find(p => p.id === editFormData.projectId);
                                    if (!currentProject) return null;

                                    const availableProjects = projectCodes.filter(p => p.clientName === currentProject.clientName);
                                    const uniqueProjectNames = [...new Set(availableProjects.map(p => p.projectName))];

                                    return React.createElement('div', null,
                                        React.createElement('label', { className: "block text-xs font-semibold text-gray-700 mb-1" }, "2. Project/Admin Name"),
                                        React.createElement('select', {
                                            value: currentProject.projectName,
                                            onChange: (e) => {
                                                const projectName = e.target.value;
                                                const firstMatch = projectCodes.find(p =>
                                                    p.clientName === currentProject.clientName &&
                                                    p.projectName === projectName
                                                );
                                                if (firstMatch) {
                                                    setEditFormData({ ...editFormData, projectId: firstMatch.id });
                                                }
                                            },
                                            className: "w-full px-2 py-1.5 text-sm border border-soft-gray rounded-subtle focus:outline-none focus:border-deep-green bg-white"
                                        },
                                            uniqueProjectNames.map(projName =>
                                                React.createElement('option', { key: projName, value: projName }, projName)
                                            )
                                        )
                                    );
                                })(),
                                (() => {
                                    const currentProject = projectCodes.find(p => p.id === editFormData.projectId);
                                    if (!currentProject) return null;

                                    const availableTasks = projectCodes.filter(p =>
                                        p.clientName === currentProject.clientName &&
                                        p.projectName === currentProject.projectName
                                    );
                                    const uniqueTasks = [...new Set(availableTasks.map(p => p.taskCode))];

                                    return React.createElement('div', null,
                                        React.createElement('label', { className: "block text-xs font-semibold text-gray-700 mb-1" }, "3. Task"),
                                        React.createElement('select', {
                                            value: currentProject.taskCode,
                                            onChange: (e) => {
                                                const taskCode = e.target.value;
                                                const firstMatch = projectCodes.find(p =>
                                                    p.clientName === currentProject.clientName &&
                                                    p.projectName === currentProject.projectName &&
                                                    p.taskCode === taskCode
                                                );
                                                if (firstMatch) {
                                                    setEditFormData({ ...editFormData, projectId: firstMatch.id });
                                                }
                                            },
                                            className: "w-full px-2 py-1.5 text-sm border border-soft-gray rounded-subtle focus:outline-none focus:border-deep-green bg-white"
                                        },
                                            uniqueTasks.map(task =>
                                                React.createElement('option', { key: task, value: task }, task)
                                            )
                                        )
                                    );
                                })(),
                                (() => {
                                    const currentProject = projectCodes.find(p => p.id === editFormData.projectId);
                                    if (!currentProject) return null;

                                    const availableSubtasks = projectCodes.filter(p =>
                                        p.clientName === currentProject.clientName &&
                                        p.projectName === currentProject.projectName &&
                                        p.taskCode === currentProject.taskCode
                                    );

                                    return React.createElement('div', null,
                                        React.createElement('label', { className: "block text-xs font-semibold text-gray-700 mb-1" }, "4. Subtask"),
                                        React.createElement('select', {
                                            value: editFormData.projectId,
                                            onChange: (e) => {
                                                setEditFormData({ ...editFormData, projectId: Number(e.target.value) });
                                            },
                                            className: "w-full px-2 py-1.5 text-sm border border-soft-gray rounded-subtle focus:outline-none focus:border-deep-green bg-white"
                                        },
                                            availableSubtasks.map(proj =>
                                                React.createElement('option', { key: proj.id, value: proj.id },
                                                    proj.subtaskCode + ' (' + proj.code + ')'
                                                )
                                            )
                                        )
                                    );
                                })()
                                )
                            ),
                            React.createElement('div', { className: "grid grid-cols-2 gap-2" },
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-xs font-semibold text-gray-700 mb-1" }, "Date"),
                                React.createElement('input', {
                                    type: "date",
                                    value: editFormData.date || '',
                                    onChange: (e) => setEditFormData({ ...editFormData, date: e.target.value }),
                                    className: "w-full px-2 py-1.5 text-sm border border-soft-gray rounded-subtle focus:outline-none focus:border-deep-green"
                                })
                            ),
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-xs font-semibold text-gray-700 mb-1" }, "Start Time"),
                                React.createElement('input', {
                                    type: "time",
                                    step: "1",
                                    value: editFormData.startTime || '',
                                    onChange: (e) => setEditFormData({ ...editFormData, startTime: e.target.value }),
                                    className: "w-full px-2 py-1.5 text-sm border border-soft-gray rounded-subtle focus:outline-none focus:border-deep-green"
                                })
                            )
                            ),
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-xs font-semibold text-gray-700 mb-1" }, "End Time"),
                                React.createElement('div', { className: "space-y-1.5" },
                                    React.createElement('input', {
                                        type: "time",
                                        step: "1",
                                        value: editFormData.endTime || '',
                                        onChange: (e) => setEditFormData({ ...editFormData, endTime: e.target.value }),
                                        className: "w-full px-2 py-1.5 text-sm border border-soft-gray rounded-subtle focus:outline-none focus:border-deep-green"
                                    }),
                                    editFormData.startTime && React.createElement('div', {
                                        className: "border border-soft-gray rounded p-1.5 max-h-32 overflow-y-auto bg-white"
                                    },
                                        React.createElement('div', { className: "grid grid-cols-6 gap-1.5" },
                                            (() => {
                                                // Generate preset time options in 15-minute increments up to 8 hours
                                                const parseTime = (timeStr) => {
                                                    const [hours, minutes, seconds] = timeStr.split(':').map(Number);
                                                    return (hours * 60 + minutes) + (seconds || 0) / 60;
                                                };

                                                const formatMinutesToTime = (totalMinutes) => {
                                                    const hours = Math.floor(totalMinutes / 60);
                                                    const minutes = Math.floor(totalMinutes % 60);
                                                    const seconds = Math.floor(((totalMinutes % 60) - minutes) * 60);
                                                    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                                                };

                                                const formatDuration = (minutes) => {
                                                    if (minutes < 60) return minutes + ' min';
                                                    const hours = minutes / 60;
                                                    if (Number.isInteger(hours)) return hours + ' hour' + (hours !== 1 ? 's' : '');
                                                    return hours.toFixed(2) + ' hours';
                                                };

                                                const startMinutes = parseTime(editFormData.startTime);

                                                // Generate all 15-minute increments from 15 minutes to 8 hours (480 minutes)
                                                const presets = [];
                                                for (let i = 15; i <= 480; i += 15) {
                                                    presets.push(i);
                                                }

                                                return presets.map(duration => {
                                                    const endMinutes = startMinutes + duration;
                                                    const endTime = formatMinutesToTime(endMinutes);
                                                    const isSelected = editFormData.endTime === endTime;

                                                    return React.createElement('button', {
                                                        key: duration,
                                                        type: 'button',
                                                        onClick: () => setEditFormData({ ...editFormData, endTime: endTime }),
                                                        className: "px-1.5 py-1 text-xs border rounded transition-all whitespace-nowrap " + (isSelected
                                                            ? "bg-deep-green text-white border-deep-green font-semibold"
                                                            : "border-soft-gray hover:border-deep-green hover:bg-soft-gray")
                                                    }, formatDuration(duration));
                                                });
                                            })()
                                        )
                                    )
                                )
                            ),
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-xs font-semibold text-gray-700 mb-1" }, "Comment"),
                                React.createElement('input', {
                                    type: "text",
                                    value: editFormData.comment || '',
                                    onChange: (e) => setEditFormData({ ...editFormData, comment: e.target.value }),
                                    placeholder: "Add comment (optional)...",
                                    className: "w-full px-2 py-1.5 text-sm border border-soft-gray rounded-subtle focus:outline-none focus:border-deep-green"
                                })
                            )
                        ),
                        React.createElement('div', { className: "flex items-center justify-end gap-2 mt-3 pt-3 border-t border-soft-gray" },
                            React.createElement('button', {
                                onClick: cancelEditEntry,
                                className: "px-3 py-1.5 text-sm border border-soft-gray rounded-subtle hover:border-gray-400 transition-colors"
                            }, "Cancel"),
                            React.createElement('button', {
                                onClick: saveEditEntry,
                                className: "px-3 py-1.5 text-sm bg-deep-green text-white rounded-subtle hover:bg-opacity-90 transition-colors"
                            }, "Save Changes")
                        )
                    )
                ),

                // Review Modal
                showReviewModal && React.createElement('div', {
                    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",
                    onClick: () => setShowReviewModal(false)
                },
                    React.createElement('div', {
                        className: "bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col",
                        onClick: (e) => e.stopPropagation()
                    },
                        React.createElement('div', { className: "p-6 border-b border-gray-200 bg-pearl" },
                            React.createElement('h2', { className: "text-2xl font-semibold text-eggplant" }, "Review Timesheet Before Export"),
                            React.createElement('p', { className: "text-sm text-gray-600 mt-2" }, "Review and edit your time entries, then choose to export to Excel or export and send to your project manager.")
                        ),
                        React.createElement('div', { className: "flex-1 overflow-y-auto p-6" },
                            React.createElement('div', { className: "overflow-x-auto" },
                                React.createElement('table', { className: "w-full border-collapse" },
                                    React.createElement('thead', null,
                                        React.createElement('tr', { className: "bg-deep-green text-white" },
                                            React.createElement('th', { className: "px-4 py-2 text-left border border-gray-300" }, "Date"),
                                            React.createElement('th', { className: "px-4 py-2 text-left border border-gray-300" }, "Project"),
                                            React.createElement('th', { className: "px-4 py-2 text-left border border-gray-300" }, "Task"),
                                            React.createElement('th', { className: "px-4 py-2 text-left border border-gray-300" }, "Subtask"),
                                            React.createElement('th', { className: "px-4 py-2 text-left border border-gray-300" }, "Hours"),
                                            React.createElement('th', { className: "px-4 py-2 text-left border border-gray-300" }, "Comment")
                                        )
                                    ),
                                    React.createElement('tbody', null,
                                        reviewEntries.map((entry, index) =>
                                            React.createElement('tr', { key: index, className: index % 2 === 0 ? 'bg-white' : 'bg-pearl' },
                                                React.createElement('td', { className: "px-4 py-2 border border-gray-300" }, entry.date),
                                                React.createElement('td', { className: "px-4 py-2 border border-gray-300" }, entry.projectName),
                                                React.createElement('td', { className: "px-4 py-2 border border-gray-300" }, entry.taskCode),
                                                React.createElement('td', { className: "px-4 py-2 border border-gray-300" }, entry.subtaskCode),
                                                React.createElement('td', { className: "px-4 py-2 border border-gray-300" },
                                                    React.createElement('input', {
                                                        type: "number",
                                                        step: "0.01",
                                                        value: entry.hours,
                                                        onChange: (e) => updateReviewEntry(index, 'hours', parseFloat(e.target.value) || 0),
                                                        className: "w-20 px-2 py-1 border border-soft-gray rounded focus:outline-none focus:border-eggplant"
                                                    })
                                                ),
                                                React.createElement('td', { className: "px-4 py-2 border border-gray-300" },
                                                    React.createElement('input', {
                                                        type: "text",
                                                        value: entry.comment || '',
                                                        onChange: (e) => updateReviewEntry(index, 'comment', e.target.value),
                                                        placeholder: "Add comment...",
                                                        className: "w-full px-2 py-1 border border-soft-gray rounded focus:outline-none focus:border-eggplant"
                                                    })
                                                )
                                            )
                                        )
                                    )
                                )
                            ),
                            React.createElement('div', { className: "mt-4 p-4 bg-pearl rounded border border-soft-gray" },
                                React.createElement('p', { className: "text-sm font-semibold text-eggplant" }, "Total Hours: " + reviewEntries.reduce((sum, e) => sum + e.hours, 0).toFixed(2))
                            )
                        ),
                        React.createElement('div', { className: "p-6 border-t border-gray-200 bg-white flex items-center justify-between" },
                            React.createElement('button', {
                                onClick: () => setShowReviewModal(false),
                                className: "px-6 py-2 border border-gray-300 text-gray-700 rounded-subtle hover:bg-gray-100 transition-colors"
                            }, "Cancel"),
                            React.createElement('div', { className: "flex gap-3" },
                                React.createElement('button', {
                                    onClick: exportToExcelOnly,
                                    className: "flex items-center gap-2 px-6 py-2 bg-deep-green text-white rounded-subtle hover:bg-opacity-90 transition-colors font-medium"
                                },
                                    React.createElement(Download, { style: { width: '18px', height: '18px' } }),
                                    "Export to Excel"
                                ),
                                React.createElement('button', {
                                    onClick: confirmAndCreateEmail,
                                    className: "flex items-center gap-2 px-6 py-2 bg-eggplant text-white rounded-subtle hover:bg-opacity-90 transition-colors font-medium"
                                },
                                    React.createElement(Upload, { style: { width: '18px', height: '18px' } }),
                                    "Export & Send to PM"
                                )
                            )
                        )
                    )
                ),

                // Email Provider Selection Modal
                showProviderSelection && React.createElement('div', {
                    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",
                    onClick: () => setShowProviderSelection(false)
                },
                    React.createElement('div', {
                        className: "bg-white rounded-lg shadow-xl max-w-md w-full p-6",
                        onClick: (e) => e.stopPropagation()
                    },
                        React.createElement('h2', { className: "text-2xl font-semibold text-eggplant mb-4" }, "Select Email Provider"),
                        React.createElement('p', { className: "text-sm text-gray-600 mb-6" }, "Choose your preferred email provider. This will be saved for future releases."),
                        React.createElement('div', { className: "space-y-3" },
                            React.createElement('button', {
                                onClick: () => selectEmailProvider('outlook'),
                                className: "w-full flex items-center justify-center gap-3 px-6 py-4 border-2 border-eggplant rounded-lg hover:bg-pearl transition-colors"
                            },
                                React.createElement('span', { className: "text-lg font-medium text-eggplant" }, "Outlook")
                            ),
                            React.createElement('button', {
                                onClick: () => selectEmailProvider('gmail'),
                                className: "w-full flex items-center justify-center gap-3 px-6 py-4 border-2 border-deep-green rounded-lg hover:bg-pearl transition-colors"
                            },
                                React.createElement('span', { className: "text-lg font-medium text-deep-green" }, "Gmail")
                            )
                        ),
                        React.createElement('button', {
                            onClick: () => setShowProviderSelection(false),
                            className: "w-full mt-4 px-4 py-2 text-sm text-gray-600 hover:text-gray-800 transition-colors"
                        }, "Cancel")
                    )
                )
                ),

                // ADD EXPENSE MODAL
                showAddExpenseModal && React.createElement('div', {
                    style: {
                        position: 'fixed',
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0,
                        backgroundColor: 'rgba(0,0,0,0.5)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        zIndex: 9999
                    },
                    onClick: () => setShowAddExpenseModal(false)
                },
                    React.createElement('div', {
                        style: {
                            backgroundColor: 'white',
                            padding: '30px',
                            borderRadius: '8px',
                            maxWidth: '600px',
                            width: '90%',
                            maxHeight: '90vh',
                            overflowY: 'auto'
                        },
                        onClick: (e) => e.stopPropagation()
                    },
                        React.createElement('h2', { style: { fontSize: '24px', fontWeight: 'bold', marginBottom: '20px' } }, "Add Expense"),

                        // Project Selection
                        React.createElement('div', { style: { marginBottom: '15px' } },
                            React.createElement('label', { style: { display: 'block', marginBottom: '5px', fontWeight: '500' } }, "Project Code *"),
                            React.createElement('select', {
                                value: expenseFormData.projectCode,
                                onChange: (e) => setExpenseFormData({ ...expenseFormData, projectCode: e.target.value }),
                                style: { width: '100%', padding: '8px', border: '1px solid #ccc', borderRadius: '4px' }
                            },
                                React.createElement('option', { value: "" }, "Select a project..."),
                                projectCodes.map((proj, idx) =>
                                    React.createElement('option', {
                                        key: idx,
                                        value: `${proj.clientName}::${proj.projectName}::${proj.taskCode}::${proj.subtaskCode}`
                                    }, `${proj.clientName} - ${proj.projectName} - ${proj.taskCode} - ${proj.subtaskCode}`)
                                )
                            )
                        ),

                        // Description
                        React.createElement('div', { style: { marginBottom: '15px' } },
                            React.createElement('label', { style: { display: 'block', marginBottom: '5px', fontWeight: '500' } }, "Description"),
                            React.createElement('textarea', {
                                value: expenseFormData.description,
                                onChange: (e) => setExpenseFormData({ ...expenseFormData, description: e.target.value }),
                                placeholder: "What was this expense for?",
                                rows: 3,
                                style: { width: '100%', padding: '8px', border: '1px solid #ccc', borderRadius: '4px', fontFamily: 'inherit' }
                            })
                        ),

                        // Category
                        React.createElement('div', { style: { marginBottom: '15px' } },
                            React.createElement('label', { style: { display: 'block', marginBottom: '5px', fontWeight: '500' } }, "Category"),
                            React.createElement('select', {
                                value: expenseFormData.category,
                                onChange: (e) => setExpenseFormData({ ...expenseFormData, category: e.target.value }),
                                style: { width: '100%', padding: '8px', border: '1px solid #ccc', borderRadius: '4px' }
                            },
                                ['Office Supplies', 'Travel', 'Meals & Entertainment', 'Software & Subscriptions', 'Equipment', 'Professional Services', 'Marketing', 'Utilities', 'Other'].map(cat =>
                                    React.createElement('option', { key: cat, value: cat }, cat)
                                )
                            )
                        ),

                        // Vendor
                        React.createElement('div', { style: { marginBottom: '15px' } },
                            React.createElement('label', { style: { display: 'block', marginBottom: '5px', fontWeight: '500' } }, "Vendor"),
                            React.createElement('input', {
                                type: "text",
                                value: expenseFormData.vendor,
                                onChange: (e) => setExpenseFormData({ ...expenseFormData, vendor: e.target.value }),
                                placeholder: "Who was the vendor?",
                                style: { width: '100%', padding: '8px', border: '1px solid #ccc', borderRadius: '4px' }
                            })
                        ),

                        // Purchase Date
                        React.createElement('div', { style: { marginBottom: '15px' } },
                            React.createElement('label', { style: { display: 'block', marginBottom: '5px', fontWeight: '500' } }, "Purchase Date *"),
                            React.createElement('input', {
                                type: "date",
                                value: expenseFormData.purchaseDate,
                                onChange: (e) => setExpenseFormData({ ...expenseFormData, purchaseDate: e.target.value }),
                                style: { width: '100%', padding: '8px', border: '1px solid #ccc', borderRadius: '4px' }
                            })
                        ),

                        // Price Before Tax
                        React.createElement('div', { style: { marginBottom: '15px' } },
                            React.createElement('label', { style: { display: 'block', marginBottom: '5px', fontWeight: '500' } }, "Price Before Tax *"),
                            React.createElement('input', {
                                type: "number",
                                step: "0.01",
                                min: "0",
                                value: expenseFormData.priceBeforeTax,
                                onChange: (e) => {
                                    const newPrice = e.target.value;
                                    const tax = parseFloat(expenseFormData.taxAmount) || 0;
                                    setExpenseFormData({
                                        ...expenseFormData,
                                        priceBeforeTax: newPrice,
                                        totalExpense: (parseFloat(newPrice) || 0) + tax
                                    });
                                },
                                placeholder: "0.00",
                                style: { width: '100%', padding: '8px', border: '1px solid #ccc', borderRadius: '4px' }
                            })
                        ),

                        // Tax Amount
                        React.createElement('div', { style: { marginBottom: '15px' } },
                            React.createElement('label', { style: { display: 'block', marginBottom: '5px', fontWeight: '500' } }, "Tax Amount *"),
                            React.createElement('input', {
                                type: "number",
                                step: "0.01",
                                min: "0",
                                value: expenseFormData.taxAmount,
                                onChange: (e) => {
                                    const newTax = e.target.value;
                                    const price = parseFloat(expenseFormData.priceBeforeTax) || 0;
                                    setExpenseFormData({
                                        ...expenseFormData,
                                        taxAmount: newTax,
                                        totalExpense: price + (parseFloat(newTax) || 0)
                                    });
                                },
                                placeholder: "0.00",
                                style: { width: '100%', padding: '8px', border: '1px solid #ccc', borderRadius: '4px' }
                            })
                        ),

                        // Total (Auto-calculated)
                        React.createElement('div', {
                            style: {
                                marginBottom: '20px',
                                padding: '12px',
                                backgroundColor: '#f0f0f0',
                                borderRadius: '4px'
                            }
                        },
                            React.createElement('label', { style: { display: 'block', marginBottom: '5px', fontWeight: 'bold' } }, "Total Expense"),
                            React.createElement('div', { style: { fontSize: '20px', color: '#1C5A3F' } },
                                '$' + (expenseFormData.totalExpense || 0).toFixed(2)
                            )
                        ),

                        // Buttons
                        React.createElement('div', { style: { display: 'flex', gap: '10px', justifyContent: 'flex-end' } },
                            React.createElement('button', {
                                onClick: () => {
                                    setShowAddExpenseModal(false);
                                    setExpenseFormData({
                                        projectCode: '',
                                        description: '',
                                        category: 'Office Supplies',
                                        vendor: '',
                                        purchaseDate: new Date().toISOString().split('T')[0],
                                        priceBeforeTax: '',
                                        taxAmount: '',
                                        totalExpense: 0
                                    });
                                },
                                style: {
                                    padding: '10px 20px',
                                    border: '1px solid #ccc',
                                    borderRadius: '4px',
                                    cursor: 'pointer',
                                    backgroundColor: 'white'
                                }
                            }, "Cancel"),
                            React.createElement('button', {
                                onClick: async () => {
                                    if (!expenseFormData.projectCode || !expenseFormData.purchaseDate || !expenseFormData.priceBeforeTax || !expenseFormData.taxAmount) {
                                        alert('Please fill in all required fields (Project, Date, Price, Tax)');
                                        return;
                                    }
                                    await addExpense(expenseFormData);
                                    setShowAddExpenseModal(false);
                                    setExpenseFormData({
                                        projectCode: '',
                                        description: '',
                                        category: 'Office Supplies',
                                        vendor: '',
                                        purchaseDate: new Date().toISOString().split('T')[0],
                                        priceBeforeTax: '',
                                        taxAmount: '',
                                        totalExpense: 0
                                    });
                                },
                                style: {
                                    padding: '10px 20px',
                                    backgroundColor: '#1C5A3F',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '4px',
                                    cursor: 'pointer'
                                }
                            }, "Add Expense")
                        )
                    )
                ),

                // INVOICE CLIENT SELECTION MODAL
                showInvoiceClientSelection && React.createElement('div', {
                    style: {
                        position: 'fixed',
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0,
                        backgroundColor: 'rgba(0,0,0,0.5)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        zIndex: 9999
                    }
                },
                    React.createElement('div', {
                        style: {
                            backgroundColor: 'white',
                            padding: '30px',
                            borderRadius: '8px',
                            maxWidth: '500px',
                            width: '90%'
                        }
                    },
                        React.createElement('h2', { style: { fontSize: '24px', fontWeight: 'bold', marginBottom: '10px' } }, "Generate Invoice"),
                        React.createElement('p', { style: { marginBottom: '20px', color: '#666' } }, "Select clients and set hourly rates:"),

                        React.createElement('div', { style: { maxHeight: '300px', overflowY: 'auto', marginBottom: '20px' } },
                            (() => {
                                const filteredEntries = timeEntries.filter(entry => {
                                    let matches = true;
                                    if (filterStartDate && entry.date < filterStartDate) matches = false;
                                    if (filterEndDate && entry.date > filterEndDate) matches = false;
                                    if (filterProject && entry.projectName !== filterProject) matches = false;
                                    return matches;
                                });
                                const uniqueClients = [...new Set(filteredEntries.map(e => e.clientName))].filter(Boolean).sort();

                                return uniqueClients.map(client =>
                                    React.createElement('div', {
                                        key: client,
                                        style: {
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '12px',
                                            padding: '12px',
                                            marginBottom: '8px',
                                            border: '1px solid #ddd',
                                            borderRadius: '4px',
                                            backgroundColor: selectedInvoiceClients.includes(client) ? '#E8F5E9' : 'white'
                                        }
                                    },
                                        React.createElement('input', {
                                            type: "checkbox",
                                            checked: selectedInvoiceClients.includes(client),
                                            onChange: (e) => {
                                                e.stopPropagation();
                                                if (selectedInvoiceClients.includes(client)) {
                                                    setSelectedInvoiceClients(selectedInvoiceClients.filter(c => c !== client));
                                                } else {
                                                    setSelectedInvoiceClients([...selectedInvoiceClients, client]);
                                                }
                                            },
                                            style: { cursor: 'pointer', width: '18px', height: '18px' }
                                        }),
                                        React.createElement('span', {
                                            style: {
                                                fontWeight: '500',
                                                flex: '1',
                                                minWidth: '150px'
                                            }
                                        }, client),
                                        React.createElement('div', {
                                            style: {
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '8px'
                                            }
                                        },
                                            React.createElement('label', {
                                                style: {
                                                    fontSize: '14px',
                                                    color: '#666',
                                                    whiteSpace: 'nowrap'
                                                }
                                            }, "Rate:"),
                                            React.createElement('input', {
                                                type: "number",
                                                step: "0.01",
                                                min: "0",
                                                value: clientRates[client] || '',
                                                onChange: (e) => {
                                                    e.stopPropagation();
                                                    setClientRates({
                                                        ...clientRates,
                                                        [client]: e.target.value
                                                    });
                                                },
                                                onClick: (e) => e.stopPropagation(),
                                                placeholder: "0.00",
                                                style: {
                                                    width: '100px',
                                                    padding: '6px 10px',
                                                    border: '1px solid #ccc',
                                                    borderRadius: '4px',
                                                    fontSize: '14px'
                                                }
                                            })
                                        )
                                    )
                                );
                            })()
                        ),

                        React.createElement('p', { style: { fontSize: '12px', color: '#999', marginBottom: '20px', fontStyle: 'italic' } }, "Leave rate blank to show hours only. Rates are per client."),

                        React.createElement('div', { style: { display: 'flex', gap: '10px', justifyContent: 'flex-end' } },
                            React.createElement('button', {
                                onClick: () => {
                                    setShowInvoiceClientSelection(false);
                                    setSelectedInvoiceClients([]);
                                    setClientRates({});
                                },
                                style: {
                                    padding: '10px 20px',
                                    border: '1px solid #ccc',
                                    borderRadius: '4px',
                                    cursor: 'pointer',
                                    backgroundColor: 'white'
                                }
                            }, "Cancel"),
                            React.createElement('button', {
                                onClick: () => {
                                    if (selectedInvoiceClients.length === 0) {
                                        alert('Please select at least one client');
                                        return;
                                    }
                                    // Prepare entries for review (same as Export timesheet review)
                                    const filteredEntries = timeEntries.filter(entry => {
                                        let matches = true;
                                        if (filterStartDate && entry.date < filterStartDate) matches = false;
                                        if (filterEndDate && entry.date > filterEndDate) matches = false;
                                        if (!selectedInvoiceClients.includes(entry.clientName)) matches = false;
                                        return matches;
                                    }).sort((a, b) => a.date.localeCompare(b.date));

                                    setReviewEntries(filteredEntries);
                                    // Hide rate selection modal and show review modal
                                    setShowInvoiceClientSelection(false);
                                    setShowInvoiceReview(true);
                                },
                                disabled: selectedInvoiceClients.length === 0,
                                style: {
                                    padding: '10px 20px',
                                    backgroundColor: '#1C5A3F',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '4px',
                                    cursor: selectedInvoiceClients.length === 0 ? 'not-allowed' : 'pointer',
                                    opacity: selectedInvoiceClients.length === 0 ? 0.5 : 1
                                }
                            }, "Review timesheet")
                        )
                    )
                ),

                // INVOICE REVIEW MODAL - Project-by-project review
                showInvoiceReview && React.createElement('div', {
                    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",
                    onClick: () => {
                        setShowInvoiceReview(false);
                        setCurrentReviewProjectIndex(0);
                    }
                },
                    React.createElement('div', {
                        className: "bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col",
                        onClick: (e) => e.stopPropagation()
                    },
                        // Header
                        React.createElement('div', { className: "p-6 border-b border-gray-200 bg-pearl" },
                            React.createElement('h2', { className: "text-2xl font-semibold text-eggplant" }, "Review Timesheet Before Invoice"),
                            React.createElement('p', { className: "text-sm text-gray-600 mt-2" }, "Review and edit your time entries, then click Generate Invoice to create the invoice.")
                        ),

                        // Content
                        React.createElement('div', { className: "flex-1 overflow-y-auto p-6" },
                            React.createElement('div', { className: "overflow-x-auto" },
                                React.createElement('table', { className: "w-full border-collapse" },
                                    React.createElement('thead', null,
                                        React.createElement('tr', { className: "bg-deep-green text-white" },
                                            React.createElement('th', { className: "px-4 py-2 text-left border border-gray-300" }, "Date"),
                                            React.createElement('th', { className: "px-4 py-2 text-left border border-gray-300" }, "Project"),
                                            React.createElement('th', { className: "px-4 py-2 text-left border border-gray-300" }, "Task"),
                                            React.createElement('th', { className: "px-4 py-2 text-left border border-gray-300" }, "Subtask"),
                                            React.createElement('th', { className: "px-4 py-2 text-left border border-gray-300" }, "Hours"),
                                            React.createElement('th', { className: "px-4 py-2 text-left border border-gray-300" }, "Comment")
                                        )
                                    ),
                                    React.createElement('tbody', null,
                                        reviewEntries.map((entry, index) =>
                                            React.createElement('tr', { key: index, className: index % 2 === 0 ? 'bg-white' : 'bg-pearl' },
                                                React.createElement('td', { className: "px-4 py-2 border border-gray-300" }, entry.date),
                                                React.createElement('td', { className: "px-4 py-2 border border-gray-300" }, entry.projectName),
                                                React.createElement('td', { className: "px-4 py-2 border border-gray-300" }, entry.taskCode),
                                                React.createElement('td', { className: "px-4 py-2 border border-gray-300" }, entry.subtaskCode),
                                                React.createElement('td', { className: "px-4 py-2 border border-gray-300" },
                                                    React.createElement('input', {
                                                        type: "number",
                                                        step: "0.01",
                                                        value: entry.hours,
                                                        onChange: (e) => updateReviewEntry(index, 'hours', parseFloat(e.target.value) || 0),
                                                        className: "w-20 px-2 py-1 border border-soft-gray rounded focus:outline-none focus:border-eggplant"
                                                    })
                                                ),
                                                React.createElement('td', { className: "px-4 py-2 border border-gray-300" },
                                                    React.createElement('input', {
                                                        type: "text",
                                                        value: entry.comment || '',
                                                        onChange: (e) => updateReviewEntry(index, 'comment', e.target.value),
                                                        placeholder: "Add comment...",
                                                        className: "w-full px-2 py-1 border border-soft-gray rounded focus:outline-none focus:border-eggplant"
                                                    })
                                                )
                                            )
                                        )
                                    )
                                )
                            ),
                            React.createElement('div', { className: "mt-4 p-4 bg-pearl rounded border border-soft-gray" },
                                React.createElement('p', { className: "text-sm font-semibold text-eggplant" }, "Total Hours: " + reviewEntries.reduce((sum, e) => sum + e.hours, 0).toFixed(2))
                            )
                        ),

                        // Footer with navigation
                        React.createElement('div', { className: "p-6 border-t border-gray-200 bg-white flex items-center justify-between" },
                            React.createElement('button', {
                                onClick: () => {
                                    setShowInvoiceReview(false);
                                    setShowInvoiceClientSelection(true);
                                },
                                className: "px-6 py-2 border border-gray-300 text-gray-700 rounded-subtle hover:bg-gray-100 transition-colors"
                            }, "â† Back to Rates"),
                            React.createElement('button', {
                                onClick: () => {
                                    // Reset company selection dropdowns
                                    setSelectedUserCompany('');
                                    setSelectedBillToCompany('');

                                    // Pre-populate invoice details from localStorage if available
                                    if (selectedInvoiceClients.length > 0) {
                                        const firstClient = selectedInvoiceClients[0];
                                        const storageKey = `invoice_details_${firstClient}`;
                                        const savedDetails = localStorage.getItem(storageKey);

                                        if (savedDetails) {
                                            try {
                                                const details = JSON.parse(savedDetails);
                                                setInvoiceCompanyName(details.companyName || '');
                                                setInvoiceStreetAddress(details.streetAddress || '');
                                                setInvoiceCityStateZip(details.cityStateZip || '');
                                                setInvoicePhone(details.phone || '');
                                                setInvoiceEmail(details.email || '');
                                                setInvoiceClientCompanyName(details.clientCompanyName || '');
                                                setInvoiceClientStreetAddress(details.clientStreetAddress || '');
                                                setInvoiceClientCityStateZip(details.clientCityStateZip || '');
                                                setInvoiceClientPhone(details.clientPhone || '');
                                                setInvoiceNumber(details.invoiceNumber || '');
                                                setInvoiceDueDate(details.dueDate || '');
                                                setInvoiceContactInfo(details.contactInfo || '');
                                                setInvoiceMemo(details.memo || '');
                                                setInvoiceTaxRate(details.taxRate || '');
                                            } catch (e) {
                                                console.error('Error loading saved invoice details:', e);
                                            }
                                        } else {
                                            // Clear all fields if no saved details
                                            setInvoiceCompanyName('');
                                            setInvoiceStreetAddress('');
                                            setInvoiceCityStateZip('');
                                            setInvoicePhone('');
                                            setInvoiceEmail('');
                                            setInvoiceClientCompanyName('');
                                            setInvoiceClientStreetAddress('');
                                            setInvoiceClientCityStateZip('');
                                            setInvoiceClientPhone('');
                                            setInvoiceNumber('');
                                            setInvoiceDueDate('');
                                            setInvoiceContactInfo('');
                                            setInvoiceMemo('');
                                            setInvoiceTaxRate('');
                                        }
                                    }

                                    setShowInvoiceReview(false);
                                    setShowInvoiceDetails(true);
                                },
                                className: "px-6 py-2 bg-deep-green text-white rounded-subtle hover:bg-opacity-90 transition-colors font-medium"
                            }, "Invoice Details â†’")
                        )
                    )
                ),

                // Invoice Details Modal
                showInvoiceDetails && React.createElement('div', {
                    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                },
                    React.createElement('div', {
                        className: "bg-white rounded-lg shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col",
                        onClick: (e) => e.stopPropagation()
                    },
                        // Header with close button
                        React.createElement('div', { className: "p-6 border-b border-gray-200 bg-gradient-to-r from-deep-green to-eggplant" },
                            React.createElement('div', { className: "flex justify-between items-start" },
                                React.createElement('div', null,
                                    React.createElement('h2', { className: "text-2xl font-bold text-white" }, "Invoice Details"),
                                    React.createElement('p', { className: "text-sm text-white text-opacity-90 mt-1" }, "Complete your invoice information")
                                ),
                                React.createElement('button', {
                                    onClick: () => setShowInvoiceDetails(false),
                                    className: "text-white hover:text-gray-200 transition-colors text-3xl font-bold leading-none"
                                }, "Ã—")
                            )
                        ),

                        // Profile Management Buttons
                        React.createElement('div', { className: "px-6 py-4 bg-gray-50 border-b border-gray-200" },
                            React.createElement('div', { className: "flex gap-3 items-center" },
                                React.createElement('span', { className: "text-sm font-medium text-gray-700" }, "Quick Actions:"),
                                React.createElement('button', {
                                    onClick: () => {
                                        setShowInvoiceDetails(false);
                                        setShowCompanyManager(true);
                                    },
                                    className: "px-4 py-2 bg-deep-green text-white text-sm rounded-lg hover:bg-opacity-90 transition-colors font-medium"
                                }, "ðŸ“‹ Manage Company Profiles"),
                                React.createElement('button', {
                                    onClick: () => {
                                        setShowInvoiceDetails(false);
                                        setShowClientManager(true);
                                    },
                                    className: "px-4 py-2 bg-eggplant text-white text-sm rounded-lg hover:bg-opacity-90 transition-colors font-medium"
                                }, "ðŸ‘¥ Manage Client Profiles")
                            )
                        ),

                        // Content - scrollable form
                        React.createElement('div', { className: "flex-1 overflow-y-auto p-6" },
                            React.createElement('div', { className: "space-y-6" },
                                // Your Company Information Section
                                React.createElement('div', null,
                                    React.createElement('h3', { className: "text-lg font-semibold text-eggplant mb-4 border-b border-gray-200 pb-2" }, "Your Company Information"),
                                    // Company selection dropdown - always show
                                    React.createElement('div', { className: "mb-4" },
                                        React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" },
                                            companyProfiles.length > 0 ? "Select Company or Enter New" : "Enter Company Information"
                                        ),
                                        companyProfiles.length > 0 && React.createElement('select', {
                                            value: selectedUserCompany,
                                            onChange: (e) => {
                                                const profileId = e.target.value;
                                                setSelectedUserCompany(profileId);
                                                if (profileId) {
                                                    const profile = companyProfiles.find(p => p.id == profileId);
                                                    if (profile) {
                                                        setInvoiceCompanyName(profile.name || '');
                                                        setInvoiceStreetAddress(profile.streetAddress || '');
                                                        setInvoiceCityStateZip(profile.cityStateZip || '');
                                                        setInvoicePhone(profile.phone || '');
                                                        setInvoiceEmail(profile.email || '');
                                                    }
                                                }
                                            },
                                            className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-eggplant mb-2",
                                            style: { height: '42px' }
                                        },
                                            React.createElement('option', { value: "" }, "-- Select Saved Company --"),
                                            companyProfiles.map(profile =>
                                                React.createElement('option', { key: profile.id, value: profile.id }, profile.name)
                                            )
                                        )
                                    ),
                                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-4" },
                                        React.createElement('div', null,
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "Company Name"),
                                            React.createElement('input', {
                                                type: "text",
                                                value: invoiceCompanyName,
                                                onChange: (e) => setInvoiceCompanyName(e.target.value),
                                                placeholder: "BLUEDOT ENVIRONMENTAL",
                                                className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-eggplant"
                                            })
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "Street Address"),
                                            React.createElement('input', {
                                                type: "text",
                                                value: invoiceStreetAddress,
                                                onChange: (e) => setInvoiceStreetAddress(e.target.value),
                                                placeholder: "[Street Address]",
                                                className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-eggplant"
                                            })
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "City, State ZIP"),
                                            React.createElement('input', {
                                                type: "text",
                                                value: invoiceCityStateZip,
                                                onChange: (e) => setInvoiceCityStateZip(e.target.value),
                                                placeholder: "[City, ST ZIP]",
                                                className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-eggplant"
                                            })
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "Phone"),
                                            React.createElement('input', {
                                                type: "text",
                                                value: invoicePhone,
                                                onChange: (e) => setInvoicePhone(e.target.value),
                                                placeholder: "[000-000-0000]",
                                                className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-eggplant"
                                            })
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "Email"),
                                            React.createElement('input', {
                                                type: "email",
                                                value: invoiceEmail,
                                                onChange: (e) => setInvoiceEmail(e.target.value),
                                                placeholder: "your-email@example.com",
                                                className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-eggplant"
                                            })
                                        )
                                    )
                                ),

                                // Client Information Section
                                React.createElement('div', null,
                                    React.createElement('h3', { className: "text-lg font-semibold text-eggplant mb-4 border-b border-gray-200 pb-2" }, "Client Information (Bill To)"),
                                    // Client selection dropdown - always show
                                    React.createElement('div', { className: "mb-4" },
                                        React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" },
                                            clientProfiles.length > 0 ? "Select Client or Enter New" : "Enter Client Information"
                                        ),
                                        clientProfiles.length > 0 && React.createElement('select', {
                                            value: selectedBillToCompany,
                                            onChange: (e) => {
                                                const profileId = e.target.value;
                                                setSelectedBillToCompany(profileId);
                                                if (profileId) {
                                                    const profile = clientProfiles.find(p => p.id == profileId);
                                                    if (profile) {
                                                        setInvoiceClientCompanyName(profile.name || '');
                                                        setInvoiceClientStreetAddress(profile.streetAddress || '');
                                                        setInvoiceClientCityStateZip(profile.cityStateZip || '');
                                                        setInvoiceClientPhone(profile.phone || '');
                                                        setInvoiceTaxRate(profile.taxRate || '');
                                                    }
                                                }
                                            },
                                            className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-eggplant mb-2",
                                            style: { height: '42px' }
                                        },
                                            React.createElement('option', { value: "" }, "-- Select Saved Client --"),
                                            clientProfiles.map(profile =>
                                                React.createElement('option', { key: profile.id, value: profile.id }, profile.name)
                                            )
                                        )
                                    ),
                                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-4" },
                                        React.createElement('div', null,
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "Company Name"),
                                            React.createElement('input', {
                                                type: "text",
                                                value: invoiceClientCompanyName,
                                                onChange: (e) => setInvoiceClientCompanyName(e.target.value),
                                                placeholder: "[Company Name]",
                                                className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-eggplant"
                                            })
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "Street Address"),
                                            React.createElement('input', {
                                                type: "text",
                                                value: invoiceClientStreetAddress,
                                                onChange: (e) => setInvoiceClientStreetAddress(e.target.value),
                                                placeholder: "[Street Address]",
                                                className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-eggplant"
                                            })
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "City, State ZIP"),
                                            React.createElement('input', {
                                                type: "text",
                                                value: invoiceClientCityStateZip,
                                                onChange: (e) => setInvoiceClientCityStateZip(e.target.value),
                                                placeholder: "[City, ST ZIP]",
                                                className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-eggplant"
                                            })
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "Phone"),
                                            React.createElement('input', {
                                                type: "text",
                                                value: invoiceClientPhone,
                                                onChange: (e) => setInvoiceClientPhone(e.target.value),
                                                placeholder: "[Phone]",
                                                className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-eggplant"
                                            })
                                        )
                                    )
                                ),

                                // Invoice Information Section
                                React.createElement('div', null,
                                    React.createElement('h3', { className: "text-lg font-semibold text-eggplant mb-4 border-b border-gray-200 pb-2" }, "Invoice Information"),
                                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-4" },
                                        React.createElement('div', null,
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "Invoice Number"),
                                            React.createElement('input', {
                                                type: "text",
                                                value: invoiceNumber,
                                                onChange: (e) => setInvoiceNumber(e.target.value),
                                                placeholder: "921363",
                                                className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-eggplant"
                                            })
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "Due Date"),
                                            React.createElement('input', {
                                                type: "date",
                                                value: invoiceDueDate,
                                                onChange: (e) => setInvoiceDueDate(e.target.value),
                                                className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-eggplant"
                                            })
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "Tax Rate (%)"),
                                            React.createElement('input', {
                                                type: "number",
                                                value: invoiceTaxRate,
                                                onChange: (e) => setInvoiceTaxRate(e.target.value),
                                                placeholder: "0",
                                                step: "0.01",
                                                min: "0",
                                                max: "100",
                                                className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-eggplant"
                                            })
                                        )
                                    )
                                ),

                                // Additional Information Section
                                React.createElement('div', null,
                                    React.createElement('h3', { className: "text-lg font-semibold text-eggplant mb-4 border-b border-gray-200 pb-2" }, "Additional Information"),
                                    React.createElement('div', { className: "space-y-4" },
                                        React.createElement('div', null,
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "Invoice Memo/Comments"),
                                            React.createElement('textarea', {
                                                value: invoiceMemo,
                                                onChange: (e) => setInvoiceMemo(e.target.value),
                                                placeholder: "1. Total payment due in 30 days\n2. Please include the invoice number on your check",
                                                rows: 4,
                                                className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-eggplant"
                                            })
                                        )
                                    )
                                )
                            )
                        ),

                        // Footer with navigation
                        React.createElement('div', { className: "p-6 border-t border-gray-200 bg-white flex items-center justify-between" },
                            React.createElement('button', {
                                onClick: () => {
                                    setShowInvoiceDetails(false);
                                    setShowInvoiceReview(true);
                                },
                                className: "px-6 py-2 border border-gray-300 text-gray-700 rounded-subtle hover:bg-gray-100 transition-colors"
                            }, "â† Back to Review"),
                            React.createElement('button', {
                                onClick: () => {
                                    // Convert client rates to numbers
                                    const ratesMap = {};
                                    Object.keys(clientRates).forEach(client => {
                                        const rate = parseFloat(clientRates[client]);
                                        if (rate && rate > 0) {
                                            ratesMap[client] = rate;
                                        }
                                    });

                                    // Prepare invoice details object
                                    const details = {
                                        companyName: invoiceCompanyName,
                                        streetAddress: invoiceStreetAddress,
                                        cityStateZip: invoiceCityStateZip,
                                        phone: invoicePhone,
                                        email: invoiceEmail,
                                        clientCompanyName: invoiceClientCompanyName,
                                        clientStreetAddress: invoiceClientStreetAddress,
                                        clientCityStateZip: invoiceClientCityStateZip,
                                        clientPhone: invoiceClientPhone,
                                        invoiceNumber: invoiceNumber,
                                        dueDate: invoiceDueDate,
                                        contactInfo: invoiceContactInfo,
                                        memo: invoiceMemo,
                                        taxRate: invoiceTaxRate
                                    };

                                    // Save user company profile if company name is filled and not already saved
                                    if (invoiceCompanyName && invoiceCompanyName.trim()) {
                                        const existingProfile = companyProfiles.find(p => p.name === invoiceCompanyName);
                                        if (!existingProfile) {
                                            const newProfile = {
                                                id: Date.now(),
                                                name: invoiceCompanyName,
                                                streetAddress: invoiceStreetAddress,
                                                cityStateZip: invoiceCityStateZip,
                                                phone: invoicePhone,
                                                email: invoiceEmail
                                            };
                                            setCompanyProfiles([...companyProfiles, newProfile]);
                                        }
                                    }

                                    // Save bill-to client profile if company name is filled and not already saved
                                    if (invoiceClientCompanyName && invoiceClientCompanyName.trim()) {
                                        const existingProfile = clientProfiles.find(p => p.name === invoiceClientCompanyName);
                                        if (!existingProfile) {
                                            const newProfile = {
                                                id: Date.now(),
                                                name: invoiceClientCompanyName,
                                                streetAddress: invoiceClientStreetAddress,
                                                cityStateZip: invoiceClientCityStateZip,
                                                phone: invoiceClientPhone,
                                                taxRate: invoiceTaxRate
                                            };
                                            setClientProfiles([...clientProfiles, newProfile]);
                                        }
                                    }

                                    // Save invoice details to localStorage for this client (for backward compatibility)
                                    selectedInvoiceClients.forEach(client => {
                                        const storageKey = `invoice_details_${client}`;
                                        localStorage.setItem(storageKey, JSON.stringify(details));
                                    });

                                    // Close details modal
                                    setShowInvoiceDetails(false);
                                    // Generate invoice with all details
                                    generateInvoiceWorkbook(selectedInvoiceClients, 0, ratesMap, details);
                                },
                                className: "px-6 py-2 bg-deep-green text-white rounded-subtle hover:bg-opacity-90 transition-colors font-medium"
                            }, "Generate Invoice")
                        )
                    )
                ),

                // Company Profile Manager Modal
                showCompanyManager && React.createElement('div', {
                    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",
                    onClick: () => setShowCompanyManager(false)
                },
                    React.createElement('div', {
                        className: "bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col",
                        onClick: (e) => e.stopPropagation()
                    },
                        // Header
                        React.createElement('div', { className: "p-6 border-b border-gray-200 bg-pearl" },
                            React.createElement('h2', { className: "text-2xl font-semibold text-eggplant" }, "Manage Company Profiles"),
                            React.createElement('p', { className: "text-sm text-gray-600 mt-2" }, "Create and manage your company billing profiles")
                        ),

                        // Content
                        React.createElement('div', { className: "flex-1 overflow-y-auto p-6" },
                            React.createElement('div', { className: "space-y-4" },
                                // Add New Company Button
                                React.createElement('button', {
                                    onClick: () => {
                                        setEditingCompanyProfile({
                                            id: Date.now(),
                                            name: '',
                                            streetAddress: '',
                                            cityStateZip: '',
                                            phone: '',
                                            email: ''
                                        });
                                    },
                                    className: "w-full px-4 py-3 bg-deep-green text-white rounded-lg hover:bg-opacity-90 transition-colors font-medium"
                                }, "+ Add New Company Profile"),

                                // Editing Form (shown when editing)
                                editingCompanyProfile && React.createElement('div', { className: "border-2 border-deep-green rounded-lg p-6 bg-green-50" },
                                    React.createElement('h3', { className: "text-lg font-semibold text-eggplant mb-4" },
                                        editingCompanyProfile.name ? `Edit: ${editingCompanyProfile.name}` : "New Company Profile"
                                    ),
                                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-4" },
                                        React.createElement('div', null,
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "Company Name *"),
                                            React.createElement('input', {
                                                type: "text",
                                                value: editingCompanyProfile.name,
                                                onChange: (e) => setEditingCompanyProfile({...editingCompanyProfile, name: e.target.value}),
                                                placeholder: "ACME Corporation",
                                                className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-eggplant"
                                            })
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "Street Address"),
                                            React.createElement('input', {
                                                type: "text",
                                                value: editingCompanyProfile.streetAddress,
                                                onChange: (e) => setEditingCompanyProfile({...editingCompanyProfile, streetAddress: e.target.value}),
                                                placeholder: "123 Main Street",
                                                className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-eggplant"
                                            })
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "City, State ZIP"),
                                            React.createElement('input', {
                                                type: "text",
                                                value: editingCompanyProfile.cityStateZip,
                                                onChange: (e) => setEditingCompanyProfile({...editingCompanyProfile, cityStateZip: e.target.value}),
                                                placeholder: "Vancouver, BC V6B 1A1",
                                                className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-eggplant"
                                            })
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "Phone"),
                                            React.createElement('input', {
                                                type: "text",
                                                value: editingCompanyProfile.phone,
                                                onChange: (e) => setEditingCompanyProfile({...editingCompanyProfile, phone: e.target.value}),
                                                placeholder: "604-555-1234",
                                                className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-eggplant"
                                            })
                                        ),
                                        React.createElement('div', { className: "md:col-span-2" },
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "Email"),
                                            React.createElement('input', {
                                                type: "email",
                                                value: editingCompanyProfile.email,
                                                onChange: (e) => setEditingCompanyProfile({...editingCompanyProfile, email: e.target.value}),
                                                placeholder: "billing@acme.com",
                                                className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-eggplant"
                                            })
                                        )
                                    ),
                                    React.createElement('div', { className: "flex gap-3 mt-4" },
                                        React.createElement('button', {
                                            onClick: () => {
                                                if (!editingCompanyProfile.name.trim()) {
                                                    alert('Company name is required');
                                                    return;
                                                }
                                                const existing = companyProfiles.find(p => p.id === editingCompanyProfile.id);
                                                if (existing) {
                                                    setCompanyProfiles(companyProfiles.map(p => p.id === editingCompanyProfile.id ? editingCompanyProfile : p));
                                                } else {
                                                    setCompanyProfiles([...companyProfiles, editingCompanyProfile]);
                                                }
                                                setEditingCompanyProfile(null);
                                            },
                                            className: "px-6 py-2 bg-deep-green text-white rounded-lg hover:bg-opacity-90 transition-colors font-medium"
                                        }, "Save"),
                                        React.createElement('button', {
                                            onClick: () => setEditingCompanyProfile(null),
                                            className: "px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors"
                                        }, "Cancel")
                                    )
                                ),

                                // List of existing companies
                                companyProfiles.length > 0 && React.createElement('div', { className: "mt-6" },
                                    React.createElement('h3', { className: "text-lg font-semibold text-eggplant mb-3" }, "Saved Company Profiles"),
                                    React.createElement('div', { className: "space-y-2" },
                                        companyProfiles.map(profile =>
                                            React.createElement('div', {
                                                key: profile.id,
                                                className: "border border-gray-200 rounded-lg p-4 hover:border-deep-green transition-colors"
                                            },
                                                React.createElement('div', { className: "flex justify-between items-start" },
                                                    React.createElement('div', { className: "flex-1" },
                                                        React.createElement('h4', { className: "font-semibold text-gray-900" }, profile.name),
                                                        profile.streetAddress && React.createElement('p', { className: "text-sm text-gray-600" }, profile.streetAddress),
                                                        profile.cityStateZip && React.createElement('p', { className: "text-sm text-gray-600" }, profile.cityStateZip),
                                                        profile.phone && React.createElement('p', { className: "text-sm text-gray-600" }, "Phone: ", profile.phone),
                                                        profile.email && React.createElement('p', { className: "text-sm text-gray-600" }, "Email: ", profile.email)
                                                    ),
                                                    React.createElement('div', { className: "flex gap-2" },
                                                        React.createElement('button', {
                                                            onClick: () => setEditingCompanyProfile(profile),
                                                            className: "px-3 py-1 text-sm text-deep-green hover:bg-green-50 rounded transition-colors"
                                                        }, "Edit"),
                                                        React.createElement('button', {
                                                            onClick: () => {
                                                                if (confirm(`Delete company profile "${profile.name}"?`)) {
                                                                    setCompanyProfiles(companyProfiles.filter(p => p.id !== profile.id));
                                                                }
                                                            },
                                                            className: "px-3 py-1 text-sm text-red-600 hover:bg-red-50 rounded transition-colors"
                                                        }, "Delete")
                                                    )
                                                )
                                            )
                                        )
                                    )
                                )
                            )
                        ),

                        // Footer
                        React.createElement('div', { className: "p-6 border-t border-gray-200 bg-white flex items-center justify-between" },
                            React.createElement('p', { className: "text-sm text-gray-600" }, `${companyProfiles.length} profile(s) saved`),
                            React.createElement('button', {
                                onClick: () => setShowCompanyManager(false),
                                className: "px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium"
                            }, "Close")
                        )
                    )
                ),

                // Client Profile Manager Modal
                showClientManager && React.createElement('div', {
                    className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",
                    onClick: () => setShowClientManager(false)
                },
                    React.createElement('div', {
                        className: "bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col",
                        onClick: (e) => e.stopPropagation()
                    },
                        // Header
                        React.createElement('div', { className: "p-6 border-b border-gray-200 bg-pearl" },
                            React.createElement('h2', { className: "text-2xl font-semibold text-eggplant" }, "Manage Client Profiles"),
                            React.createElement('p', { className: "text-sm text-gray-600 mt-2" }, "Create and manage client billing profiles with tax rates")
                        ),

                        // Content
                        React.createElement('div', { className: "flex-1 overflow-y-auto p-6" },
                            React.createElement('div', { className: "space-y-4" },
                                // Add New Client Button
                                React.createElement('button', {
                                    onClick: () => {
                                        setEditingClientProfile({
                                            id: Date.now(),
                                            name: '',
                                            streetAddress: '',
                                            cityStateZip: '',
                                            phone: '',
                                            taxRate: ''
                                        });
                                    },
                                    className: "w-full px-4 py-3 bg-eggplant text-white rounded-lg hover:bg-opacity-90 transition-colors font-medium"
                                }, "+ Add New Client Profile"),

                                // Editing Form (shown when editing)
                                editingClientProfile && React.createElement('div', { className: "border-2 border-eggplant rounded-lg p-6 bg-purple-50" },
                                    React.createElement('h3', { className: "text-lg font-semibold text-eggplant mb-4" },
                                        editingClientProfile.name ? `Edit: ${editingClientProfile.name}` : "New Client Profile"
                                    ),
                                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-4" },
                                        React.createElement('div', null,
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "Client Company Name *"),
                                            React.createElement('input', {
                                                type: "text",
                                                value: editingClientProfile.name,
                                                onChange: (e) => setEditingClientProfile({...editingClientProfile, name: e.target.value}),
                                                placeholder: "Client Corp Inc.",
                                                className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-eggplant"
                                            })
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "Street Address"),
                                            React.createElement('input', {
                                                type: "text",
                                                value: editingClientProfile.streetAddress,
                                                onChange: (e) => setEditingClientProfile({...editingClientProfile, streetAddress: e.target.value}),
                                                placeholder: "456 Oak Avenue",
                                                className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-eggplant"
                                            })
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "City, State ZIP"),
                                            React.createElement('input', {
                                                type: "text",
                                                value: editingClientProfile.cityStateZip,
                                                onChange: (e) => setEditingClientProfile({...editingClientProfile, cityStateZip: e.target.value}),
                                                placeholder: "Seattle, WA 98101",
                                                className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-eggplant"
                                            })
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "Phone"),
                                            React.createElement('input', {
                                                type: "text",
                                                value: editingClientProfile.phone,
                                                onChange: (e) => setEditingClientProfile({...editingClientProfile, phone: e.target.value}),
                                                placeholder: "206-555-6789",
                                                className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-eggplant"
                                            })
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "Tax Rate (%)"),
                                            React.createElement('input', {
                                                type: "number",
                                                value: editingClientProfile.taxRate,
                                                onChange: (e) => setEditingClientProfile({...editingClientProfile, taxRate: e.target.value}),
                                                placeholder: "0",
                                                step: "0.01",
                                                min: "0",
                                                max: "100",
                                                className: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-eggplant"
                                            })
                                        )
                                    ),
                                    React.createElement('div', { className: "flex gap-3 mt-4" },
                                        React.createElement('button', {
                                            onClick: () => {
                                                if (!editingClientProfile.name.trim()) {
                                                    alert('Client company name is required');
                                                    return;
                                                }
                                                const existing = clientProfiles.find(p => p.id === editingClientProfile.id);
                                                if (existing) {
                                                    setClientProfiles(clientProfiles.map(p => p.id === editingClientProfile.id ? editingClientProfile : p));
                                                } else {
                                                    setClientProfiles([...clientProfiles, editingClientProfile]);
                                                }
                                                setEditingClientProfile(null);
                                            },
                                            className: "px-6 py-2 bg-eggplant text-white rounded-lg hover:bg-opacity-90 transition-colors font-medium"
                                        }, "Save"),
                                        React.createElement('button', {
                                            onClick: () => setEditingClientProfile(null),
                                            className: "px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors"
                                        }, "Cancel")
                                    )
                                ),

                                // List of existing clients
                                clientProfiles.length > 0 && React.createElement('div', { className: "mt-6" },
                                    React.createElement('h3', { className: "text-lg font-semibold text-eggplant mb-3" }, "Saved Client Profiles"),
                                    React.createElement('div', { className: "space-y-2" },
                                        clientProfiles.map(profile =>
                                            React.createElement('div', {
                                                key: profile.id,
                                                className: "border border-gray-200 rounded-lg p-4 hover:border-eggplant transition-colors"
                                            },
                                                React.createElement('div', { className: "flex justify-between items-start" },
                                                    React.createElement('div', { className: "flex-1" },
                                                        React.createElement('h4', { className: "font-semibold text-gray-900" }, profile.name),
                                                        profile.streetAddress && React.createElement('p', { className: "text-sm text-gray-600" }, profile.streetAddress),
                                                        profile.cityStateZip && React.createElement('p', { className: "text-sm text-gray-600" }, profile.cityStateZip),
                                                        profile.phone && React.createElement('p', { className: "text-sm text-gray-600" }, "Phone: ", profile.phone),
                                                        profile.taxRate && React.createElement('p', { className: "text-sm text-gray-600 font-medium" }, "Tax Rate: ", profile.taxRate, "%")
                                                    ),
                                                    React.createElement('div', { className: "flex gap-2" },
                                                        React.createElement('button', {
                                                            onClick: () => setEditingClientProfile(profile),
                                                            className: "px-3 py-1 text-sm text-eggplant hover:bg-purple-50 rounded transition-colors"
                                                        }, "Edit"),
                                                        React.createElement('button', {
                                                            onClick: () => {
                                                                if (confirm(`Delete client profile "${profile.name}"?`)) {
                                                                    setClientProfiles(clientProfiles.filter(p => p.id !== profile.id));
                                                                }
                                                            },
                                                            className: "px-3 py-1 text-sm text-red-600 hover:bg-red-50 rounded transition-colors"
                                                        }, "Delete")
                                                    )
                                                )
                                            )
                                        )
                                    )
                                )
                            )
                        ),

                        // Footer
                        React.createElement('div', { className: "p-6 border-t border-gray-200 bg-white flex items-center justify-between" },
                            React.createElement('p', { className: "text-sm text-gray-600" }, `${clientProfiles.length} profile(s) saved`),
                            React.createElement('button', {
                                onClick: () => setShowClientManager(false),
                                className: "px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium"
                            }, "Close")
                        )
                    )
                )
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(TimeTracker));
    </script>
</body>
</html>
